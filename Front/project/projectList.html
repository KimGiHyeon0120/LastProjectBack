<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>프로젝트 리스트</title>
    <link rel="icon" sizes="48x48" href="../img/android-icon-48x48.png">
    <link rel="apple-touch-icon" sizes="48x48" href="../img/android-icon-48x48.png">
    <script src="../script/header.js"></script>
    <link rel="stylesheet" href="../../Front/profile/">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
    <!-- 헤더 영역 -->
    <header>

    </header>
    <div class="main">
        <!-- 메인 콘텐츠 -->
        <main class="projectList-container">
            <div class="projectList-header">
                <h1>프로젝트</h1>
                <button class="projectList-create-btn">프로젝트 만들기</button>
            </div>


            <div class="projectList-filters">
                <input type="text" id="search" placeholder="">
                <label for="search">프로젝트 검색</label>

            </div>

            <table class="projectList-table">
                <thead>
                    <tr>
                        <th>이름</th>
                        <th>유형</th>
                        <th>리더</th>
                        <th>설정</th>
                    </tr>
                </thead>
                <tbody id="projectList">
                    <!-- 프로젝트 데이터가 동적으로 추가됩니다 -->
                </tbody>

            </table>
        </main>
    </div>
    <script>
        $(document).ready(function () {
            const API_URL = "http://192.168.20.37:3000/api/project/list-by-user";

            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            if (!loggedInUser || !loggedInUser.user_id) {
                alert("로그인이 필요합니다.");
                window.location.href = "../Login/login.html";
                return;
            }

            const userId = loggedInUser.user_id;

            function fetchUserIdx() {
                return new Promise((resolve, reject) => {
                    $.ajax({
                        url: `http://localhost:3000/api/users/get-idx?userId=${userId}`,

                        method: "GET",
                        success: function (data) {
                            resolve(data.user_idx);
                        },
                        error: function (err) {
                            reject(err);
                        },
                    });
                });
            }

            function fetchProjects(userIdx) {
                $.ajax({
                    url: `${API_URL}?userId=${userIdx}`,
                    method: "GET",
                    success: function (data) {
                        renderProjects(data.ownedProjects, data.participatingProjects);
                    },
                    error: function (err) {
                        console.error("프로젝트 목록 불러오기 실패:", err);
                    },
                });
            }

            function renderProjects(ownedProjects, participatingProjects) {
                const projectList = $("#projectList");
                projectList.empty();

                ownedProjects.forEach((project) => {
                    projectList.append(`
                    <tr class="project-row" data-project-id="${project.project_id}">
                       <td><div class="project-name">${project.project_name}</div></td>
                        <td>${project.is_team_project || '역할 없음'}</td>
                        <td>${project.leader_name || '리더 없음'}</td>
                        <td class="text-right">
                            <button class="settings-btn">
                                <img src="../img/Settings-icon.png" alt="Settings">
                            </button>
                        </td>
                    </tr>
                `);
                });


                participatingProjects.forEach((project) => {
                    projectList.append(`
                    <tr class="project-row" data-project-id="${project.project_id}">
                        <td class="project-name">${project.project_name}</td>
                        <td>${project.is_team_project || '역할 없음'}</td>
                        <td>${project.leader_name || '리더 없음'}</td>
                        <td class="text-right">
                            <button class="settings-btn">
                                <img src="../img/Settings-icon.png" alt="Settings">
                            </button>
                        </td>
                    </tr>
                `);
                });


                // 프로젝트 이름을 클릭했을 때 이동하도록 설정
                $(".project-name").on("click", function (e) {
                    e.stopPropagation(); // 클릭 이벤트가 부모 <tr>로 전파되지 않도록 막기
                    const projectId = $(this).closest("tr").data("project-id"); // 프로젝트 ID 가져오기
                    sessionStorage.setItem('projectId', projectId); // 프로젝트 ID를 세션 스토리지에 저장
                    localStorage.setItem('projectId', projectId); // 프로젝트 ID를 세션 스토리지에 저장
                    window.location.href = `../project/board_main.html?projectId=${projectId}`; // 해당 프로젝트 페이지로 이동

                    // 클릭 시 테두리 스타일 적용
                    $(".project-name").removeClass("clicked"); // 다른 프로젝트에서 테두리 제거
                    $(this).addClass("clicked"); // 클릭한 프로젝트에 테두리 추가
                });

            }

            function filterProjects() {
                const searchQuery = $("#projectSearchBar").val().toLowerCase();
                $(".project-row").each(function () {
                    const projectName = $(this).data("project-name");
                    if (projectName.includes(searchQuery)) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            }

            fetchUserIdx()
                .then(fetchProjects)
                .catch((err) => {
                    console.error("전체 처리 중 오류 발생:", err);
                });

            // 검색창 이벤트 리스너 추가
            $("#projectSearchBar").on("input", filterProjects);
        });

    </script>

</body>

</html>