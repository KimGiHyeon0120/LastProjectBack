<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>작업 진행 상태</title>
    <style>
        /* 고정 헤더 스타일 */
        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        /* 메인 컨텐츠 */
        .main {
            padding-top: 100px;
            /* 헤더 높이만큼 추가 */
        }

        /* 작업 진행 상태 보드 컨테이너 */
        .board {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 20px;
            overflow: visible;
            /* 드롭다운이 보일 수 있도록 설정 */
            position: relative;
            /* 자식 요소 절대 위치 계산을 위해 */
        }

        .board-column {
            flex: 1;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            min-height: 300px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .board-column h3 {
            margin-top: 0;
            font-size: 18px;
            color: #333;
            text-align: center;
        }

        /* 작업 카드 */
        .task {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            cursor: grab;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }

        .task:hover {
            background-color: #f0f9ff;
            transform: translateY(-2px);
        }

        /* 작업 카드 내부 텍스트 */
        .task p {
            margin: 0;
            color: #333;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
        }

        /* 작업 상태 칸 */
        .tasks {
            border-radius: 4px;
            /* 모서리 둥글게 */
            padding: 10px;
            /* 여백 */
            background-color: #f9f9f9;
            transition: background-color 0.3s ease;
            min-height: 100px;
        }

        .tasks.empty:hover {
            background-color: #e6f7ff;
            /* 드롭 가능 강조 */
        }

        /* 드롭다운 활성화 시 hover 효과 비활성화 */
        .task.dropdown-active:hover {
            background-color: initial;
            /* 원래 배경색 유지 */
            transform: none;
            /* 움직임 제거 */
        }


        /*프로필 사진*/
        .profile-section {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }

        .profile-image {
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 1px solid #ddd;
            transition: transform 0.2s ease;
        }

        .profile-image:hover {
            transform: scale(1.1);
        }


        .assignee-section {
            position: relative;
            display: inline-block;
        }

        .assignee-dropdown {
            cursor: pointer;
            display: inline-block;
        }

        /* 담당자 섹션 */
        .assignee-section {
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* 드롭다운 버튼 */
        .assignee-dropdown {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        /* 드롭다운 내 이미지 */
        .assignee-image {
            width: 50px;
            height: 50px;
            border-radius: 50%;
        }

        /* 드롭다운 내 이름 */
        .assignee-name {
            font-size: 14px;
            color: #333;
        }

        /* 드롭다운 옵션 */
        .dropdown-options {
            position: absolute;
            /* 절대 위치 */
            top: 60px;
            /* 프로필 이미지 바로 아래로 위치 조정 */
            left: 0;
            z-index: 2000;
            /* 높은 z-index 설정 */
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
            /* 기본적으로 숨김 */
            padding: 10px;
            min-width: 150px;
            max-width: 200px;
            overflow-y: auto;
            /* 스크롤 가능 */
            white-space: nowrap;
        }

        /* 드롭다운이 보일 때 */
        .dropdown-options.show {
            display: block;
            z-index: 3000;
            /* 드롭다운이 최상단으로 올라오도록 설정 */
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 5px;
            cursor: pointer;
            white-space: nowrap;
            /* 텍스트 줄바꿈 방지 */
        }

        .dropdown-item:hover {
            background-color: #f0f0f0;
        }

        .dropdown-image {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
        }

        /* 드롭다운 이미지 */
        .dropdown-image {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        /* 드롭다운 이름 */
        .dropdown-item span {
            font-size: 14px;
            color: #333;
        }

        /* 팝업 컨테이너 */
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            padding: 20px;
        }

        /* 팝업 헤더 */
        .popup-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
            color: #333;
        }

        /* 폼 내부 스타일 */
        .popup-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* 입력 필드 스타일 */
        .popup-form input,
        .popup-form textarea,
        .popup-form select {
            padding: 10px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .popup-form input:focus,
        .popup-form textarea:focus,
        .popup-form select:focus {
            outline: none;
            border-color: #40a9ff;
            box-shadow: 0 0 6px rgba(64, 169, 255, 0.5);
        }

        /* 텍스트 영역 스타일 */
        .popup-form textarea {
            resize: none;
            height: 100px;
        }

        /* 버튼 섹션 */
        .popup-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .popup-buttons button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        /* 취소 버튼 */
        .popup-buttons .cancel-btn {
            background-color: #ddd;
            color: #333;
        }

        .popup-buttons .cancel-btn:hover {
            background-color: #bbb;
        }

        /* 저장 버튼 */
        .popup-buttons .save-btn {
            background-color: #40a9ff;
            color: #fff;
        }

        .popup-buttons .save-btn:hover {
            background-color: #1890ff;
        }

        /* 팝업 배경 */
        .popup-background {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.3);
            z-index: 999;
        }
        
    </style>
    <script src="../lib/jquery-3.7.1.min.js"></script>
    <script src="../script/header.js"></script>
</head>

<body>
    <!-- 헤더 영역 -->
    <header>
        <script>loadHTML("./header.html")</script>
    </header>

    <div class="main">
        <div class="header">
            <h1>작업 진행 상태</h1>
        </div>
        <div class="content">
            <!-- 작업 진행 상태 보드 -->
            <div class="board" id="sprintBoard">
                <!-- 스프린트 및 작업 데이터가 동적으로 추가됩니다 -->
            </div>
        </div>
    </div>

    <!-- 맨션 팝업창 -->
    <div class="popup" id="editTaskPopup">
        <div class="popup-header">작업 확인 및 맨션 추가</div>
        <form class="popup-form">
            <label>작업 이름</label>
            <input type="text" id="editTaskName" placeholder="작업 이름을 입력하세요" readonly />

            <label>작업 설명</label>
            <textarea id="editTaskDescription" placeholder="작업 설명을 입력하세요" readonly></textarea>

            <label>마감 날짜</label>
            <input type="date" id="editTaskDueDate" readonly />

            <label>작업 상태</label>
            <select id="editTaskStatus" disabled></select>

            <label>맨션 추가</label>
            <textarea id="mentionMessage" placeholder="맨션 내용을 입력하세요"></textarea>

            <div class="popup-buttons">
                <button type="button" class="cancel-btn" id="cancelEditTaskBtn">닫기</button>
                <button type="button" class="save-btn" id="sendMentionBtn">맨션 보내기</button>
            </div>
        </form>
    </div>

    <script>

        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

        $(document).ready(function () {
            const projectId = sessionStorage.getItem("projectId");
            const userIdx = sessionStorage.getItem("userIdx"); // 로그인된 사용자 ID
            const API_URL = "http://localhost:3000/api";

            if (!projectId) {
                return;
            }
            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

            // 작업 상태 및 작업 데이터를 가져오기
            async function fetchTasksAndMembers() {
                try {
                    // 작업 상태 목록 가져오기
                    const statusResponse = await $.get(`${API_URL}/tasks/status-list`);
                    const statuses = statusResponse;

                    // 작업 데이터 가져오기
                    const taskResponse = await $.get(`${API_URL}/tasks/list`, { projectId });
                    const tasks = taskResponse;

                    // 팀원 목록 가져오기
                    const membersResponse = await $.get(`${API_URL}/project/members`, { projectId });
                    const teamMembers = membersResponse;

                    renderTasks(statuses, tasks, teamMembers);
                } catch (err) {
                }
            }
            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

            // 작업 렌더링
            function renderTasks(statuses, tasks, teamMembers) {
                const sprintBoard = $("#sprintBoard");
                sprintBoard.empty(); // 기존 데이터 초기화

                statuses.forEach(status => {
                    const tasksForStatus = tasks.filter(task => task.statusId === status.id);

                    const tasksHTML = tasksForStatus.map(task => `
                    <div class="task" draggable="true" ondragstart="dragTask(event)" data-task-id="${task.taskId}">
                        <p>${task.taskName}</p>
                        <div class="assignee-section">
                            <!-- 담당자 선택 -->
                            <div class="assignee-dropdown" onclick="window.toggleAssigneeDropdown(${task.taskId})">
                                <img src="${task.assignedToImage || '../profile/default-profile.png'}" 
                                    class="assignee-image" alt="프로필">
                                <span class="assignee-name">${task.assignedTo || '담당자 없음'}</span>
                            </div>
                            <div class="dropdown-options hidden" id="dropdown_${task.taskId}">
                                ${teamMembers.map(member => `
                                    <div class="dropdown-item" onclick="window.selectAssignee(${task.taskId}, ${member.userId}, '${member.profileImage || '../profile/default-profile.png'}', '${member.userName}')">
                                        <img src="${member.profileImage || '../profile/default-profile.png'}" 
                                            class="dropdown-image" alt="프로필">
                                        <span>${member.userName}</span>
                                    </div>
                                `).join("")}
                                <div class="dropdown-item" onclick="window.selectAssignee(${task.taskId}, null, '../profile/default-profile.png', '담당자 없음')">
                                    <img src="../profile/default-profile.png" class="dropdown-image" alt="프로필">
                                    <span>담당자 없음</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join("");

                    const columnHTML = `
                        <div class="board-column" data-status="${status.name}">
                            <h3>${status.name}</h3>
                            <div class="tasks ${tasksForStatus.length === 0 ? "empty" : ""}" 
                                 ondragover="allowDrop(event)" 
                                 ondrop="dropTask(event, '${status.id}')">
                                ${tasksHTML}
                            </div>
                        </div>
                    `;

                    sprintBoard.append(columnHTML); // 작업 상태 컬럼 추가
                });
            }
            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

            window.dragTask = function (event) {
                const taskId = event.target.dataset.taskId;
                event.dataTransfer.setData("text", taskId);
            };

            // 드래그 허용
            window.allowDrop = function (event) {
                event.preventDefault();
            };

            // 작업 드롭
            window.dropTask = function (event, newStatusId) {
                event.preventDefault();
                const taskId = event.dataTransfer.getData("text");

                if (!userIdx) {
                    return;
                }

                $.ajax({
                    url: `${API_URL}/tasks/update_status`,
                    method: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify({ taskId, status: newStatusId, changedBy: userIdx }),
                    success: function () {
                        fetchTasksAndMembers(); // 데이터 새로고침
                    },
                    error: function (err) {
                    }
                });
            };



            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

            // 작업 할당
            window.assignTask = function (dropdown) {
                const taskId = dropdown.dataset.taskId;
                const assignedTo = dropdown.value;

                if (!taskId) {
                    alert("Task ID가 필요합니다.");
                    return;
                }

                $.ajax({
                    url: `${API_URL}/tasks/assign`,
                    method: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify({ taskId, assignedTo, changedBy: userIdx }),
                    success: function () {
                        fetchTasksAndMembers(); // 새로고침
                    },
                    error: function (err) {
                        console.error("작업 할당 중 오류 발생:", err);
                    }
                });
            };


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────



            window.toggleAssigneeDropdown = function (taskId) {
                // 모든 드롭다운 닫기
                document.querySelectorAll('.dropdown-options').forEach(dropdown => {
                    dropdown.classList.remove('show');
                    const taskElement = dropdown.closest('.task');
                    if (taskElement) {
                        taskElement.classList.remove('dropdown-active'); // 모든 task에서 dropdown-active 제거
                    }
                });

                // 현재 드롭다운 열기
                const currentDropdown = document.getElementById(`dropdown_${taskId}`);
                const taskElement = currentDropdown.closest('.task'); // 드롭다운이 속한 task 찾기

                if (!currentDropdown.classList.contains('show')) {
                    currentDropdown.classList.add('show');
                    taskElement.classList.add('dropdown-active'); // 드롭다운 활성화 시 클래스 추가
                } else {
                    currentDropdown.classList.remove('show');
                    taskElement.classList.remove('dropdown-active'); // 드롭다운 비활성화 시 클래스 제거
                }
            };


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────



            window.selectAssignee = function (taskId, userId, profileImage, userName) {
                // AJAX로 서버에 업데이트 요청
                $.ajax({
                    url: `${API_URL}/tasks/assign`,
                    method: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify({ taskId, assignedTo: userId, changedBy: userIdx }),
                    success: function () {
                        // 드롭다운 닫기
                        const dropdown = document.getElementById(`dropdown_${taskId}`);
                        dropdown.classList.remove("show");

                        // 화면에서 즉시 변경 반영
                        const taskElement = document.querySelector(`.task[data-task-id="${taskId}"]`);
                        const assigneeDropdown = taskElement.querySelector(".assignee-dropdown");

                        // 프로필 이미지와 이름 즉시 업데이트
                        assigneeDropdown.innerHTML = `
                            <img src="${profileImage}" class="assignee-image" alt="프로필">
                            <span class="assignee-name">${userName || '담당자 없음'}</span>
                        `;

                        console.log(`담당자 변경됨: Task ID ${taskId}, Assigned To ${userName}`);
                    },
                    error: function (err) {
                        console.error("작업 할당 중 오류 발생:", err);
                    }
                });
            };


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────



            // 클릭 외 영역 클릭 시 드롭다운 닫기
            document.addEventListener('click', function (e) {
                if (!e.target.closest('.assignee-section')) {
                    document.querySelectorAll('.dropdown-options').forEach(dropdown => {
                        dropdown.classList.remove('show');
                        const taskElement = dropdown.closest('.task');
                        if (taskElement) {
                            taskElement.classList.remove('dropdown-active'); // 모든 task에서 dropdown-active 제거
                        }
                    });
                }
            });

            // 초기 데이터 로드
            fetchTasksAndMembers();
        });

        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


    </script>
</body>

</html>