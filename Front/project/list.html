<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>작업 진행 상태</title>
    <link rel="icon" sizes="48x48" href="../img/logo.png">
    <link rel="apple-touch-icon" sizes="48x48" href="../img/logo.png">
    <link rel="stylesheet" href="../css/list.css">
    <link rel="stylesheet" href="../css/form-control.css">
    <script src="../lib/jquery-3.7.1.min.js"></script>
    <script src="../script/header.js"></script>
</head>

<body>
    <!-- 헤더 영역 -->
    <header> </header>

    <div class="main">
        <div class="projectList-header">
            <h1>작업 진행 상태</h1>
        </div>
        <div class="projectList-filters">
            <input type="text" id="search" placeholder="">
            <label for="search">작업 검색</label>

            <!-- 스프린트 필터 -->
            <div class="dropdown-container" style="position: relative;">
                <button id="sprintDropdownButton" class="sprint-dropdown-button">전체</button>
                <div id="sprintDropdownContent" class="sprint-dropdown-content">
                    <!-- 스프린트 항목이 여기에 동적으로 추가됩니다 -->
                </div>
            </div>
          
        </div>
        
        <div class="content">
            <!-- 작업 진행 상태 보드 -->
            <div class="board" id="sprintBoard">
                <!-- 스프린트 및 작업 데이터가 동적으로 추가됩니다 -->
            </div>
        </div>
    </div>




    <!-- 맨션 팝업창 -->
    <div class="popup" id="editTaskPopup">
        <div class="popup-header">작업 확인 및 수정</div>
        <form class="popup-form">
            <label>작업 이름</label>
            <input type="text" id="editTaskName" placeholder="작업 이름을 입력하세요" />

            <label>작업 설명</label>
            <textarea id="editTaskDescription" placeholder="작업 설명을 입력하세요"></textarea>

            <!-- 시작 날짜와 마감 날짜를 좌우로 배치 -->
            <div class="date-container">
                <div class="date-field">
                    <label>시작 날짜</label>
                    <input type="date" id="editTaskStartDate" />
                </div>
                <div class="date-field">
                    <label>마감 날짜</label>
                    <input type="date" id="editTaskDueDate" />
                </div>
            </div>

            <label>맨션 추가</label>
            <div style="position: relative;">
                <textarea id="mentionMessage" placeholder="맨션 내용을 입력하세요"></textarea>
                <div id="autocompleteBox"
                    style="display: none; position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #ddd; z-index: 1000;">
                    <!-- 자동완성 리스트가 동적으로 추가됩니다 -->
                </div>
            </div>

            <div class="activity-tabs">
                <button type="button" class="tab-button active" data-tab="all">전체</button>
                <button type="button" class="tab-button" data-tab="mentions">맨션</button>
                <button type="button" class="tab-button" data-tab="logs">기록</button>
            </div>

            <div class="activity-content" id="activityContent">
                <!-- 활동 로그 및 기록이 동적으로 표시됩니다 -->
            </div>
            <div class="popup-buttons">
                <button type="button" class="cancel-btn" id="cancelEditTaskBtn">닫기</button>
                <button type="button" class="save-btn" id="saveTaskBtn">저장</button>
                <button type="button" class="mention-btn" id="sendMentionBtn">맨션 보내기</button>
            </div>
        </form>
    </div>







    <script>

        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
        const projectId = sessionStorage.getItem("projectId");
        const userIdx = sessionStorage.getItem("userIdx"); // 로그인된 사용자 ID
        const userIdxh = localStorage.getItem("userIdx"); // 사용자 ID
        const projectIdh = localStorage.getItem("projectId"); // 프로젝트 ID
        const API_URL = "http://localhost:3000/api";
        //192.168.20.37

        let userRole = null;
        let teamMembers = []; // 전역 변수로 선언
        let allTasks = []; // 모든 작업 데이터를 저장
        let statuses = []; // 모든 상태 데이터를 저장

        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

        // 상태 목록을 불러오는 함수
        async function loadStatuses() {
            try {
                const response = await fetch(`${API_URL}/tasks/status-list`);
                const statuses = await response.json();
                return statuses;  // 상태 목록 반환
            } catch (err) {
                console.error('상태 목록을 불러오는 중 오류가 발생했습니다:', err);
            }
        }

        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

        // 작업 상태 및 작업 데이터를 가져오기
        async function fetchTasksAndMembers() {
            try {
                const statusResponse = await $.get(`${API_URL}/tasks/status-list`);
                statuses = statusResponse;

                const taskResponse = await $.get(`${API_URL}/tasks/list2`, { projectId });
                allTasks = taskResponse; // 모든 작업 데이터를 저장

                const membersResponse = await $.get(`${API_URL}/project/members`, { projectId });
                teamMembers = membersResponse;

                // teamMembers를 활용하여 userIdx -> 이름 매핑 객체 생성
                const userMap = {};
                teamMembers.forEach(member => {
                    userMap[member.userId] = member.userName;
                });

                // 전역 변수로 저장
                window.userMap = userMap;

                // 초기 렌더링
                renderTasks(statuses, allTasks, teamMembers);

                // 드롭다운 이벤트를 재연결
                document.querySelectorAll('.assignee-section .assignee-dropdown').forEach(dropdownButton => {
                    dropdownButton.addEventListener('click', function (event) {
                        const taskId = event.currentTarget.closest('.task').dataset.taskId;
                        window.toggleAssigneeDropdown(taskId);
                    });
                });
            } catch (err) {
                console.error("Error fetching tasks and members:", err);
            }
        }



        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

        // 작업 렌더링
        function renderTasks(statuses, tasks, teamMembers) {
            const sprintBoard = $("#sprintBoard");
            sprintBoard.empty(); // 화면 초기화

            // 상태별로 작업을 필터링하여 렌더링
            statuses.forEach(status => {

                // 해당 상태의 작업 필터링
                const tasksForStatus = tasks.filter(task => {
                    const taskStatusId = task.Tasks_status_id || task.statusId || task.status_id; // 상태 값을 가져옴
                    return taskStatusId === status.id;
                });
                // 작업 개수 콘솔 출력
                console.log(`상태: ${status.name}`);
                console.log(`  작업 개수: ${tasksForStatus.length}`);

                // 각 작업에 대한 HTML 생성
                const tasksHTML = tasksForStatus.map(task => {
                    // 담당자 정보 처리
                    const assignedMember = teamMembers.find(member =>
                        member.userId === task.assigned_to || member.userId === task.assignedTo
                    );
                    const profileImage = assignedMember?.profileImage || '../profile/default-profile.png';
                    const assignedToName = assignedMember?.userName || '담당자 없음';

                    // 날짜 변환 함수
                    const parseDate = dateStr => {
                        if (!dateStr) return null;
                        const standardizedDate = dateStr.replace(/[년월일]/g, '').trim().replace(/\s+/g, '-');
                        const parsedDate = new Date(standardizedDate);
                        return isNaN(parsedDate) ? null : parsedDate;
                    };

                    const adjustDate = date => {
                        if (!date) return null;
                        const adjustedDate = new Date(date);
                        adjustedDate.setDate(adjustedDate.getDate() - 1); // 날짜에서 1일을 뺌
                        return adjustedDate;
                    };

                    const formatDate = date => {
                        if (!date) return 'N/A';
                        return `${date.getFullYear()}년 ${String(date.getMonth() + 1).padStart(2, '0')}월 ${String(date.getDate()).padStart(2, '0')}일`;
                    };

                    // 날짜 정보 처리
                    const startDateRaw = task.start_date || task.startDate;
                    const dueDateRaw = task.due_date || task.dueDate;

                    // start_date와 due_date는 원래 값 유지
                    const startDateOriginal = formatDate(parseDate(task.start_date));
                    const dueDateOriginal = formatDate(parseDate(task.due_date));

                    // startDate와 dueDate는 -1일 조정
                    const startDate = formatDate(adjustDate(parseDate(startDateRaw)));
                    const dueDate = formatDate(adjustDate(parseDate(dueDateRaw)));




                    // 스프린트 이름 처리
                    const sprintName = task.sprintName || task.sprint_name || '스프린트 없음';



                    return `
                        <div class="task" draggable="true" ondragstart="dragTask(event)" data-task-id="${task.taskId || task.task_id}" data-assigned-to="${assignedToName}">
                            <div class="work-item" onclick="openEditTaskPopup(${task.taskId || task.task_id})">
                                <p class="sprint-name">${sprintName}</p>
                                <p class="task-name">${task.taskName || task.task_name || '작업 이름 없음'}</p>
                                <p class="task-dates">${startDate || startDateRaw} ~ ${dueDate || dueDateRaw}</p>
                            </div>
                
                            <div class="assignee-section">
                                <div class="assignee-dropdown" onclick="window.toggleAssigneeDropdown(${task.taskId || task.task_id})">
                                    <img src="${profileImage}" class="assignee-image" alt="프로필">
                                    <span class="assignee-name">${assignedToName}</span>
                                </div>
                                <div class="dropdown-options hidden" id="dropdown_${task.taskId || task.task_id}">
                                    ${teamMembers.map(member => `
                                        <div class="dropdown-item" onclick="selectAssignee(${task.taskId || task.task_id}, ${member.userId}, '${member.profileImage || '../profile/default-profile.png'}', '${member.userName}')">
                                            <img src="${member.profileImage || '../profile/default-profile.png'}" class="dropdown-image" alt="프로필">
                                            <span>${member.userName}</span>
                                        </div>
                                    `).join('')}
                                    <div class="dropdown-item" onclick="selectAssignee(${task.taskId || task.task_id}, null, '../profile/default-profile.png', '담당자 없음')">
                                        <img src="../profile/default-profile.png" class="dropdown-image" alt="프로필">
                                        <span>담당자 없음</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                // 상태별 작업 컬럼 생성
                const columnHTML = `
                    <div class="board-column" data-status="${status.name}">
                        <div class="status-header">
                            <span class="status-icon">●</span>
                            <h3 class="status-name">
                                ${status.name}&nbsp;&nbsp;<span class="task-count">${tasksForStatus.length}</span> 
                            </h3>
                        </div>
                        <div class="tasks ${tasksForStatus.length === 0 ? "empty" : ""}" ondragover="allowDrop(event)" ondrop="dropTask(event, '${status.id}')">
                            ${tasksHTML}
                        </div>
                    </div>
                `;

                sprintBoard.append(columnHTML);
            });
        }




        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────



        $(document).ready(function () {





            $(document).ready(async function () {
                try {
                    // 사용자 역할 로드
                    const response = await $.get(`${API_URL}/project/role`, { projectId, userIdx });
                    userRole = response.project_role_name; // "팀장" 또는 "팀원"

                    // 작업과 팀원 데이터 로드
                    fetchTasksAndMembers();
                } catch (err) {
                    console.error("사용자 역할 로드 실패:", err);
                }
            });


            if (!projectId) {
                return;
            }




            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────




            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

            window.dragTask = function (event) {
                if (!userRole) {
                    return;
                }

                const taskId = event.target.dataset.taskId;
                const assignedTo = event.target.dataset.assignedTo; // 담당자 이름
                const currentUserName = window.userMap[userIdx]; // 현재 로그인된 사용자 이름

                if (!taskId) {
                    return;
                }


                // 팀장이 아니고, 현재 사용자가 작업 담당자가 아닌 경우
                if (userRole !== "팀장" && currentUserName !== assignedTo) {
                    event.preventDefault(); // 드래그 차단
                    return;
                }

                event.dataTransfer.setData("text", taskId);
            };

            // 작업 드롭
            window.dropTask = function (event, newStatusId) {
                event.preventDefault();
                const taskId = event.dataTransfer.getData("text");

                if (!taskId) {
                    console.error("작업 ID가 유효하지 않습니다.");
                    return;
                }

                // 서버 요청 데이터
                const requestData = {
                    taskId: taskId,
                    status: newStatusId,
                    changedBy: userIdx
                };

                // 서버 요청
                $.ajax({
                    url: `${API_URL}/tasks/update_status`,
                    method: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify(requestData),
                    success: function () {
                        fetchTasksAndMembers();
                    },
                    error: function (err) {
                        console.error("작업 상태 변경 오류:", err.responseText);
                    }
                });
            };

            // 드래그 허용
            window.allowDrop = function (event) {
                event.preventDefault();
            };




            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

            // 작업 할당
            window.assignTask = function (dropdown) {
                const taskId = dropdown.dataset.taskId;
                const assignedTo = dropdown.value;

                if (!taskId) {
                    return;
                }

                $.ajax({
                    url: `${API_URL}/tasks/assign`,
                    method: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify({ taskId, assignedTo, changedBy: userIdx }),
                    success: function () {
                        fetchTasksAndMembers(); // 새로고침
                    },
                    error: function (err) {
                        console.error("작업 할당 중 오류 발생:", err);
                    }
                });
            };


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


            // 담당자 드롭다운 열기/닫기
            window.toggleAssigneeDropdown = function (taskId) {

                // 현재 열려 있는 드롭다운 닫기
                document.querySelectorAll('.dropdown-options').forEach(dropdown => {
                    if (dropdown.id !== `dropdown_${taskId}`) {
                        dropdown.classList.remove('show');
                        const taskElement = dropdown.closest('.task');
                        if (taskElement) {
                            taskElement.classList.remove('dropdown-active');
                        }
                    }
                });

                const currentDropdown = document.getElementById(`dropdown_${taskId}`);
                if (!currentDropdown) {
                    console.error(`Dropdown not found for Task ID ${taskId}`);
                    return;
                }

                const taskElement = currentDropdown.closest('.task');
                const isDropdownOpen = currentDropdown.classList.contains('show');

                if (isDropdownOpen) {
                    currentDropdown.classList.remove('show');
                    taskElement?.classList.remove('dropdown-active');
                } else {
                    currentDropdown.classList.add('show');
                    taskElement?.classList.add('dropdown-active');
                }
            };


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


            // 작업 담당자 할당 및 UI 업데이트
            window.selectAssignee = function (taskId, userId, profileImage, userName) {

                if (!taskId) {
                    console.error("Task ID가 필요합니다.");
                    return;
                }

                // 팀장만 담당자를 변경할 수 있도록 확인
                if (userRole !== "팀장") {
                    return;
                }


                // UI 업데이트
                const dropdown = document.getElementById(`dropdown_${taskId}`);
                const dropdownButton = dropdown?.previousElementSibling;

                if (dropdownButton) {
                    dropdownButton.innerHTML = `
            <img src="${profileImage}" class="assignee-image" alt="프로필">
            <span class="assignee-name">${userName || '담당자 없음'}</span>
        `;
                } else {
                    console.error("Dropdown 버튼을 찾을 수 없습니다.");
                    return;
                }

                // 드롭다운 닫기
                dropdown.classList.remove('show');
                dropdown.closest('.task')?.classList.remove('dropdown-active');


                // 서버 요청
                $.ajax({
                    url: `${API_URL}/tasks/assign`,
                    method: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify({ taskId, assignedTo: userId, changedBy: userIdx }),
                    success: function () {
                        fetchTasksAndMembers(); // 작업 목록 새로고침
                    },
                    error: function (err) {
                        console.error(`Error assigning Task ID ${taskId}:`, err);
                    }
                });
            };

            // 이벤트 위임 방식으로 드롭다운 이벤트 처리
            document.addEventListener('click', function (e) {
                const dropdownButton = e.target.closest('.assignee-dropdown');
                if (dropdownButton) {
                    const taskId = dropdownButton.closest('.task').dataset.taskId;
                    window.toggleAssigneeDropdown(taskId);
                }
            });


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────



            // 클릭 외 영역 클릭 시 드롭다운 닫기
            document.addEventListener('click', function (e) {
                if (!e.target.closest('.assignee-section')) {
                    document.querySelectorAll('.dropdown-options').forEach(dropdown => {
                        dropdown.classList.remove('show');
                        const taskElement = dropdown.closest('.task');
                        if (taskElement) {
                            taskElement.classList.remove('dropdown-active'); // 모든 task에서 dropdown-active 제거
                        }
                    });
                }
            });








            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

            // 작업 편집 팝업 열기
            window.openEditTaskPopup = function (taskId) {
                $.ajax({
                    url: `${API_URL}/tasks/${taskId}`,
                    method: "GET",
                    data: { userIdx: sessionStorage.getItem("userIdx") },
                    success: function (task) {
                        const taskAssignedTo = task.assignedTo; // 담당자 ID
                        const userRole = task.userRole; // 현재 사용자의 역할 ('팀장', '팀원')
                        const currentUserIdx = parseInt(userIdx);

                        // 권한 확인
                        const isAllowed = currentUserIdx === parseInt(taskAssignedTo) || userRole === "팀장";

                        // 팝업 열기
                        $("#editTaskName").val(task.taskName || "").prop("disabled", !isAllowed);
                        $("#editTaskDescription").val(task.description || "").prop("disabled", !isAllowed);

                        // 시작 날짜 추가
                        $("#editTaskStartDate").val(task.startDate ? task.startDate.split("T")[0] : "").prop("disabled", !isAllowed);

                        // 마감 날짜
                        $("#editTaskDueDate").val(task.dueDate ? task.dueDate.split("T")[0] : "").prop("disabled", !isAllowed);

                        $("#mentionMessage").val(""); // 맨션 입력 필드 초기화
                        $("#saveTaskBtn").prop("disabled", !isAllowed).toggle(isAllowed);
                        $("#sendMentionBtn").prop("disabled", !isAllowed).toggle(isAllowed);

                        // 기본 탭 선택: 전체
                        $(".tab-button").removeClass("active");
                        $(".tab-button[data-tab='all']").addClass("active");
                        $("#activityContent").empty(); // 기존 기록 초기화

                        // 작업 상태 및 기록 불러오기
                        loadTaskStatus(task.statusId);
                        loadActivityLogs(taskId);

                        $(".popup-background").fadeIn();
                        $("#editTaskPopup").fadeIn();

                        // 작업 ID를 팝업 및 버튼에 저장
                        $("#editTaskPopup").data("task-id", taskId);
                        $("#saveTaskBtn").data("task-id", taskId);
                        $("#sendMentionBtn").data("task-id", taskId);
                    },
                    error: function (err) {
                        console.error("Error fetching task details:", err);
                    }
                });
            };


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────



            // 작업 상태 로드
            function loadTaskStatus(selectedStatusId) {
                $.ajax({
                    url: `${API_URL}/tasks/status-list`,
                    method: "GET",
                    success: function (statuses) {
                        const statusDropdown = $("#editTaskStatus");
                        statusDropdown.empty();
                        statuses.forEach(status => {
                            const isSelected = status.id === selectedStatusId ? "selected" : "";
                            statusDropdown.append(`<option value="${status.id}" ${isSelected}>${status.name}</option>`);
                        });
                    },
                    error: function (err) {
                        console.error("작업 상태 로드 오류:", err);
                    }
                });
            }

            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────



            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

            // 작업 저장
            $("#saveTaskBtn").click(function () {
                const taskId = $(this).data("task-id");
                const updatedTask = {
                    taskId,
                    taskName: $("#editTaskName").val(),
                    description: $("#editTaskDescription").val(),
                    dueDate: $("#editTaskDueDate").val(),
                    changedBy: userIdx
                };

                $.ajax({
                    url: `${API_URL}/tasks/update`,
                    method: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify(updatedTask),
                    success: function () {
                        ;
                        $(".popup-background").fadeOut();
                        $("#editTaskPopup").fadeOut();
                    },
                    error: function (err) {
                        console.error("작업 저장 오류:", err);
                        alert("작업 저장 중 오류가 발생했습니다.");
                    }
                });
            });
            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

            // 팝업 닫기
            $("#cancelEditTaskBtn").click(function () {
                $("#editTaskPopup").fadeOut();
                $(".popup-background").fadeOut();
            });


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


            // 탭 클릭 이벤트
            $(".tab-button").click(function () {
                const tab = $(this).data("tab");
                const activityContent = $("#activityContent");
                const taskId = $("#editTaskPopup").data("task-id");
                const userId = userIdx;

                $(".tab-button").removeClass("active");
                $(this).addClass("active");

                let apiUrl = `${API_URL}/tasks/activity/task`;
                let requestData = { taskId };

                if (tab === "mentions") {
                    apiUrl = `${API_URL}/mentions/user`;
                    requestData = { userId, taskId };
                } else if (tab === "logs") {
                    apiUrl = `${API_URL}/tasks/history/task`;
                }

                $.ajax({
                    url: apiUrl,
                    method: "GET",
                    data: requestData,
                    success: function (logs) {
                        activityContent.empty();

                        // 중복 데이터 필터링
                        const uniqueLogs = [...new Map(logs.map(log => [log.log_message || log.message, log])).values()];

                        uniqueLogs.forEach((log, index) => {
                            const rawMessage = log.log_message || log.message || "내용 없음";
                            const filteredMessage = filterAndFormatDate(rawMessage); // 로그 메시지에서 날짜 필터링 및 변환
                            const date = convertToKoreanDate(log.changed_at || log.created_at || log.activity_date || new Date());
                            const logType = log.log_type || "맨션";

                            activityContent.append(`
                    <div class="activity-log">
                        <p><strong>${logType}</strong>: ${filteredMessage}</p>
                        <p class="log-time">${date}</p>
                    </div>
                `);
                        });
                    },
                    error: function (err) {
                        console.error("API 요청 실패:", err);
                        $("#activityContent").empty().append(`<p class="error-log">활동 로그를 가져오는 중 오류가 발생했습니다.</p>`);
                    },
                });
            });

            // 활동 로그 및 기록 불러오기
            function loadActivityLogs(taskId) {
                if (!taskId) {
                    console.error("작업 ID가 필요합니다.");
                    return;
                }

                $.ajax({
                    url: `${API_URL}/tasks/activity/task`,
                    method: "GET",
                    data: { taskId },
                    success: function (logs) {
                        const activityContent = $("#activityContent");
                        activityContent.empty(); // 기존 로그 제거

                        if (!logs || logs.length === 0) {
                            activityContent.append(`<p class="no-logs">활동 로그가 없습니다.</p>`);
                            return;
                        }

                        // 중복 제거 및 정렬
                        const uniqueLogs = [...new Map(logs.map(log => [log.log_message + log.activity_date, log])).values()];

                        uniqueLogs.forEach((log, index) => {
                            const logType = log.log_type || "기록";
                            const filteredMessage = filterAndFormatDate(log.log_message || log.message); // 로그 메시지에서 날짜 필터링 및 변환
                            const formattedDate = convertToKoreanDate(log.activity_date || log.created_at || log.changed_at);

                            activityContent.append(`
                    <div class="activity-log" data-log-type="${logType}">
                        <p><strong>${logType}</strong>: ${filteredMessage}</p>
                        <p class="log-time">${formattedDate}</p>
                    </div>
                `);
                        });
                    },
                    error: function (err) {
                        console.error("API 요청 실패 - 오류:", err);
                        $("#activityContent").empty().append(`<p class="error-log">활동 로그를 가져오는 중 오류가 발생했습니다.</p>`);
                    },
                });
            }

            // 날짜 필터링
            function filterAndFormatDate(logMessage) {
                const datePattern = /\b[A-Za-z]{3} [A-Za-z]{3} \d{2} \d{4} \d{2}:\d{2}:\d{2} GMT\+\d{4} \([^)]+\)|\d{4}-\d{2}-\d{2}\b/g;
                const matches = logMessage.match(datePattern);

                if (!matches) {
                    return logMessage;
                }

                let formattedMessage = logMessage;

                matches.forEach(originalDate => {
                    const date = new Date(originalDate);
                    if (!isNaN(date.getTime())) {
                        const formattedDate = `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일`;
                        formattedMessage = formattedMessage.replace(originalDate, formattedDate);
                    } else {
                        console.error("날짜 변환 실패:", originalDate);
                    }
                });

                return formattedMessage;
            }

            // 날짜 변환
            function convertToKoreanDate(dateString) {
                const date = new Date(dateString);

                if (isNaN(date.getTime())) {
                    console.error("유효하지 않은 날짜:", dateString);
                    return "유효하지 않은 날짜";
                }

                return `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일`;
            }









            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


            // 맨션 보내기
            $("#sendMentionBtn").click(function () {
                const taskId = $(this).data("task-id");
                const mentionMessage = $("#mentionMessage").val().trim();

                if (!mentionMessage) {
                    alert("멘션 메시지를 입력해주세요.");
                    return;
                }

                const mentionedUsers = extractMentionedUsers(mentionMessage);

                if (mentionedUsers.length === 0) {
                    alert("멘션 대상 사용자가 없습니다.");
                    return;
                }

                $.ajax({
                    url: `${API_URL}/mentions/send`,
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        taskId,
                        mentionMessage,
                        mentionedUsers,
                        sentBy: userIdx,
                    }),
                    success: function () {
                        $("#mentionMessage").val(""); // 입력 필드 초기화
                        loadActivityLogs(taskId); // 활동 로그 업데이트
                        $(".tab-button").removeClass("active");
                        $(".tab-button[data-tab='all']").addClass("active");
                    },
                    error: function (err) {
                        console.error("메시지 전송 오류:", err);
                        alert("메시지 전송 중 오류가 발생했습니다.");
                    },
                });
            });






            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


            // @사용자명 추출 함수
            function extractMentionedUsers(message) {
                const mentionPattern = /@([A-Za-z0-9가-힣\s]+)/g; // 공백 포함
                const matches = [];
                let match;
                while ((match = mentionPattern.exec(message)) !== null) {
                    matches.push(match[1].trim()); // 앞뒤 공백 제거 후 추가
                }
                return matches;
            }


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────



            // 맨션 입력 이벤트
            $("#mentionMessage").on("keyup", function (e) {
                const inputVal = $(this).val(); // 입력된 값
                const caretPos = this.selectionStart; // 커서 위치

                // @ 뒤의 검색어 추출
                const mentionPattern = /@([\w가-힣]*)$/;
                const match = mentionPattern.exec(inputVal.slice(0, caretPos));
                const searchQuery = match ? match[1] : "";


                if (searchQuery) {
                    // 서버에 검색 요청
                    $.ajax({
                        url: `${API_URL}/project/members/search`,
                        method: "GET",
                        data: { projectId, query: searchQuery },
                        success: function (members) {
                            const box = $("#autocompleteBox");
                            box.empty(); // 기존 리스트 초기화

                            if (members.length > 0) {
                                // 검색 결과 추가
                                members.forEach(member => {
                                    box.append(`
                            <div class="autocomplete-item" 
                                 style="padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" 
                                 data-user-name="${member.userName}">
                                @${member.userName} (${member.roleName})
                            </div>
                        `);
                                });
                            } else {
                                // 검색 결과 없음 표시
                                box.append('<div style="padding: 10px; color: #888; text-align: center;">검색 결과가 없습니다</div>');
                            }

                            // 자동완성 박스 위치를 텍스트박스 위쪽으로 조정
                            const offset = $("#mentionMessage").offset();
                            const inputHeight = $("#mentionMessage").outerHeight();
                            box.css({
                                top: 50, // 텍스트박스 위쪽
                                width: $("#mentionMessage").outerWidth(),
                                display: "block" // 표시
                            });
                        },
                        error: function (err) {
                            console.error("팀원 검색 오류:", err);
                        }
                    });
                } else {
                    $("#autocompleteBox").hide(); // 검색어가 없으면 자동완성 박스 숨김
                }
            });





            // 자동완성 항목 클릭 이벤트
            $(document).on("click", ".autocomplete-item", function () {
                const mentionName = $(this).data("user-name"); // 선택된 사용자 이름
                if (!mentionName) return;

                const textarea = $("#mentionMessage");
                const caretPos = textarea[0].selectionStart; // 커서 위치
                const message = textarea.val();

                // @ 뒤의 검색어를 지우고 새 맨션 텍스트 추가
                const updatedMessage = message.replace(/@[\w가-힣]*$/, `@${mentionName} `);
                textarea.val(updatedMessage);
                textarea.focus(); // 텍스트박스에 포커스 유지

                $("#autocompleteBox").hide(); // 자동완성 박스 숨김
            });

            // 텍스트박스 외 클릭 시 자동완성 박스 숨김
            $(document).on("click", function (e) {
                if (!$(e.target).closest("#mentionMessage, #autocompleteBox").length) {
                    $("#autocompleteBox").hide();
                }
            });





            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────















            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


            fetchTasksAndMembers();

        });

        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────



        document.addEventListener('DOMContentLoaded', function () {
            const sprintDropdownButton = document.getElementById('sprintDropdownButton');
            const sprintDropdownContent = document.getElementById('sprintDropdownContent');
            const searchInput = document.getElementById('search');
            let teamMembers = [];
            let filteredTasks = [];
            let allTasks = [];
            let statuses = [];

            if (!sprintDropdownButton || !sprintDropdownContent) {
                console.error('스프린트 드롭다운 요소를 찾을 수 없습니다.');
                return;
            }

            // 드롭다운 열기/닫기
            sprintDropdownButton.addEventListener('click', function (e) {
                e.stopPropagation(); // 이벤트 버블링 방지
                sprintDropdownContent.classList.toggle('show');
            });

            // 외부 클릭 시 드롭다운 닫기
            document.addEventListener('click', function (event) {
                if (!sprintDropdownButton.contains(event.target) && !sprintDropdownContent.contains(event.target)) {
                    sprintDropdownContent.classList.remove('show');
                }
            });

            // 스프린트 필터 로드
            async function loadSprintFilters(projectId) {
                try {
                    const response = await fetch(`${API_URL}/sprint/list?projectId=${projectId}`);
                    const sprints = await response.json();
                    sprintDropdownContent.innerHTML = ''; // 기존 콘텐츠 초기화

                    sprints.forEach(sprint => {
                        const sprintDiv = document.createElement('div');
                        sprintDiv.className = 'sprint-item'; // 개별 스프린트 클래스

                        sprintDiv.innerHTML = `
                            <input type="checkbox" class="sprint-checkbox" value="${sprint.sprintId}">
                            <span class="sprint-name">${sprint.sprintName}</span>
                        `;
                        sprintDropdownContent.appendChild(sprintDiv);
                    });
                } catch (err) {
                    console.error('스프린트 필터 로드 오류:', err);
                }
            }

            // 상태 목록을 불러오는 함수
            async function loadStatuses() {
                try {
                    const response = await fetch(`${API_URL}/tasks/status-list`);
                    statuses = await response.json();
                } catch (err) {
                    console.error('상태 목록을 불러오는 중 오류가 발생했습니다:', err);
                }
            }

            // 작업 및 팀원 로드
            async function fetchTasksAndMembers() {
                try {
                    const taskResponse = await fetch(`${API_URL}/tasks/list2?projectId=${projectId}`);
                    allTasks = await taskResponse.json();

                    const membersResponse = await fetch(`${API_URL}/project/members?projectId=${projectId}`);
                    teamMembers = await membersResponse.json();

                    await loadStatuses(); // 상태 목록 로드
                    filteredTasks = allTasks; // 초기에는 모든 작업 표시
                    renderTasks(statuses, filteredTasks, teamMembers);
                } catch (err) {
                    console.error("Error fetching tasks and members:", err);
                }
            }



            // 선택된 스프린트 필터링 및 버튼 텍스트 업데이트
            function updateSprintDropdownButton() {
                const checkedSprints = Array.from(document.querySelectorAll('.sprint-checkbox:checked')).map(cb =>
                    cb.parentElement.textContent.trim()
                );

                const sprintDropdownButton = document.getElementById('sprintDropdownButton');
                if (checkedSprints.length > 0) {
                    sprintDropdownButton.textContent = checkedSprints.join(', ');
                } else {
                    sprintDropdownButton.textContent = '전체'; // 기본 텍스트
                }
            }




            // 필터링 적용
            async function applyFilters() {
                const checkedSprints = Array.from(document.querySelectorAll('.sprint-checkbox:checked')).map(cb => cb.value);

                // 선택된 스프린트 이름 업데이트
                const sprintDropdownButton = document.getElementById('sprintDropdownButton');
                const selectedSprintNames = Array.from(document.querySelectorAll('.sprint-checkbox:checked')).map(cb =>
                    cb.parentElement.textContent.trim()
                );

                if (selectedSprintNames.length > 0) {
                    sprintDropdownButton.textContent = selectedSprintNames.join(', ');
                } else {
                    sprintDropdownButton.textContent = '전체'; // 기본 텍스트
                }

                // 필터링 조건 추가
                const params = new URLSearchParams({ projectId });
                if (checkedSprints.length > 0) {
                    params.append('sprints', checkedSprints.join(','));
                }

                try {
                    // API 호출
                    const response = await fetch(`${API_URL}/tasks/tasks/filter?${params.toString()}`);
                    filteredTasks = await response.json();

                    // 필터링된 작업이 없을 경우 처리
                    if (filteredTasks.length === 0) {
                        const sprintBoard = document.getElementById('sprintBoard');
                        sprintBoard.innerHTML = `<p class="no-tasks-message">선택된 스프린트에 작업이 없습니다.</p>`;
                        return;
                    }

                    // 필터링된 작업 렌더링
                    renderTasks(statuses, filteredTasks, teamMembers);
                } catch (err) {
                    console.error('필터링 오류:', err);
                }
            }

            // 검색 필터링
            searchInput.addEventListener('input', function () {
                const query = searchInput.value.toLowerCase().trim();
                const searchedTasks = filteredTasks.filter(task =>
                    (task.taskName || task.task_name).toLowerCase().includes(query) ||
                    (task.description || '').toLowerCase().includes(query) ||
                    (task.assignedToName || '담당자 없음').toLowerCase().includes(query)
                );
                renderTasks(statuses, searchedTasks, teamMembers);
            });

            // 필터 이벤트 연결
            sprintDropdownContent.addEventListener('change', applyFilters);

            // 초기 작업 로드
            const projectId = sessionStorage.getItem('projectId');
            if (projectId) {
                loadSprintFilters(projectId);
                fetchTasksAndMembers();
            }
        });
    </script>
</body>

</html>