<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Project Management</title>
    <link rel="stylesheet" href="../css/summary.css">
    <link rel="icon" sizes="48x48" href="../img/logo.png">
    <link rel="apple-touch-icon" sizes="48x48" href="../img/logo.png">
    <script src="../lib/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="../script/header.js"></script>
</head>

<body>
    <!-- 헤더 영역 -->
    <header> </header>

    <div class="main">
        <!-- 메인 컨테이너 -->
        <div class="container">
            <!-- 카드 섹션 -->
            <div class="header">
                <div class="card" onclick="showContent('team')">
                    <h2>팀 프로젝트 현황</h2>

                </div>

                <div class="card" onclick="showContent('resources')">
                    <h2>내 할일</h2>

                </div>
            </div>

            <!-- 콘텐츠 섹션 -->
            <div class="content" id="team">







                <!-- 첫 번째 행 -->
                <div class="row">







                    <!-- 왼쪽 위: 팀원별 작업 현황 요약 -->
                    <div class="left-column section-top-left">
                        <h3>팀원별 작업 현황 요약</h3>
                        <table id="team-tasks-table" class="team-tasks-table">
                            <thead>
                                <tr>
                                    <th class="status-th">팀원 이름</th>
                                    <th class="status-th status-완료">완료</th>
                                    <th class="status-th status-진행중">진행 중</th>
                                    <th class="status-th status-할일">할 일</th>
                                </tr>
                            </thead>
                            <tbody id="team-tasks-table-body" class="team-tasks-table-body">
                                <!-- 동적으로 추가될 행 -->
                            </tbody>
                            <tfoot id="team-tasks-table-footer" class="team-tasks-table-footer">
                                <!-- 총 작업량 행 -->
                            </tfoot>
                        </table>
                    </div>









                    <!-- 오른쪽 위: 전체 프로젝트 진행률 -->
                    <div class="right-column section-top-right">
                        <h3>전체 프로젝트 진행률</h3>
                        <!-- 원형 그래프를 표시할 캔버스 -->
                        <canvas id="projectProgressChart" width="400" height="400"></canvas>
                    </div>
                </div>









                <!-- 두 번째 행 -->
                <div class="row">





                    <!-- 왼쪽 아래: 스프린트별 작업량 -->
                    <div class="left-column section-bottom-left">
                        <h3>스프린트별 작업량</h3>
                        <label for="sprint-select"><strong>스프린트를 선택하세요:</strong></label>
                        <select id="sprint-select">
                            <!-- 동적으로 추가될 스프린트 옵션 -->
                        </select>
                        <canvas id="sprintTasksChart" width="400" height="300"></canvas>
                    </div>








                    <!-- 오른쪽 아래: 마감 임박 프로젝트 -->
                    <div class="right-column section-bottom-right">
                        <h3>마감 임박 프로젝트</h3>
                        <p>
                            <strong>목적:</strong> 마감 기한이 다가오는 프로젝트를 강조하여 표시.<br>
                            <strong>표현 방식:</strong> 리스트 또는 카드 형식으로 표시.<br>
                            <strong>구현 방식:</strong>
                        <ul>
                            <li>API를 통해 마감 기한이 임박한 프로젝트 데이터를 가져옵니다. (GET ${API_URL}/api/summary/projects/urgent)</li>
                            <li>API 응답 데이터는 프로젝트 이름, 마감 기한, 진행률을 포함합니다.</li>
                        </ul>
                        <strong>예:</strong><br>
                        AI 프로젝트: 마감일 2023-12-01, 진행률 75%<br>
                        디자인 개선: 마감일 2023-11-28, 진행률 50%<br>
                        데이터를 동적으로 렌더링하여 시각적으로 강조합니다.
                        </p>
                    </div>
                </div>



            </div>




            <div class="content hidden" id="tasks">
                <h3>작업 및 할 일</h3>
                <ul>
                    <li>내 할 일 표시</li>
                </ul>
            </div>

        </div>
    </div>










    <script>

        const projectId = sessionStorage.getItem("projectId");
        const userIdx = sessionStorage.getItem("userIdx"); // 로그인된 사용자 ID
        const userIdxh = localStorage.getItem("userIdx"); // 사용자 ID
        const projectIdh = localStorage.getItem("projectId"); // 프로젝트 ID
        const API_URL = "http://localhost:3000/api";
        //192.168.20.37





        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────




        $(document).ready(function () {





            /* 팀원별 작업 현황 요약 */

            // 팀원별 작업 현황 데이터를 가져오는 함수
            function fetchTeamTasks() {
                $.ajax({
                    url: `${API_URL}/summary/team/tasks`, // API URL
                    type: "GET",
                    data: { projectId: projectId }, // 쿼리 파라미터로 projectId 전달
                    success: function (data) {
                        renderTeamTasks(data); // 데이터를 렌더링 함수로 전달
                    },
                    error: function (xhr, status, error) {
                        console.error(error);
                        alert('팀원별 작업 데이터를 가져오는 중 오류가 발생했습니다.');
                    },
                });
            }

            // 팀원별 작업 현황 요약 렌더링
            function renderTeamTasks(tasks) {
                const tableBody = $("#team-tasks-table-body");
                const tableFooter = $("#team-tasks-table-footer"); // 테이블 푸터 영역
                tableBody.empty();
                tableFooter.empty();

                let totalCompleted = 0;
                let totalInProgress = 0;
                let totalToDo = 0;

                tasks.forEach((task, index) => {
                    // 본인 여부 확인
                    const isCurrentUser = Number(task.userIdx) === Number(userIdx);

                    // 작업 상태 합계 계산
                    totalCompleted += Number(task.completed);
                    totalInProgress += Number(task.inProgress);
                    totalToDo += Number(task.toDo);

                    // 테이블 행 생성
                    const tableRow = `
            <tr id="task-row-${index}" class="task-row ${isCurrentUser ? 'highlight-row' : ''}">
                <td id="member-name-${index}">${task.memberName}</td>
                <td id="completed-${index}">${task.completed}</td>
                <td id="in-progress-${index}">${task.inProgress}</td>
                <td id="to-do-${index}">${task.toDo}</td>
            </tr>
        `;
                    tableBody.append(tableRow);
                });

                // 총 작업량 표시
                const totalRow = `
        <tr class="total-row">
            <td><strong>총 작업량</strong></td>
            <td><strong>${totalCompleted}</strong></td>
            <td><strong>${totalInProgress}</strong></td>
            <td><strong>${totalToDo}</strong></td>
        </tr>
    `;
                tableFooter.append(totalRow);
            }


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


            /* 전체 프로젝트 진행률 */

            // Chart.js 플러그인 등록
            Chart.register(ChartDataLabels);


            // 전체 프로젝트 진행률 데이터를 가져오는 함수
            async function fetchProjectProgress() {
                try {
                    const response = await fetch(`${API_URL}/summary/all/tasks?projectId=${projectId}`);
                    const data = await response.json();
                    renderProjectProgressChart(data); // 그래프에 데이터 전달
                } catch (error) {
                    console.error("Fetch error:", error);
                }
            }


            // Chart.js를 사용하여 원형 그래프 렌더링
            function renderProjectProgressChart(data) {

                const ctx = document.getElementById("projectProgressChart").getContext("2d");

                // 상태별 데이터
                const completed = parseInt(data.completed) || 0;
                const inProgress = parseInt(data.inProgress) || 0;
                const toDo = parseInt(data.toDo) || 0;
                const totalTasks = completed + inProgress + toDo;

                if (totalTasks === 0) {
                    console.error("작업 데이터가 없습니다.");
                    alert("작업 데이터가 없습니다.");
                    return;
                }

                // Chart.js 데이터
                const chartData = {
                    labels: ["완료", "진행 중", "할 일"],
                    datasets: [
                        {
                            data: [completed, inProgress, toDo],
                            backgroundColor: ["#28a745", "#ffc107", "#007bff"],
                            hoverBackgroundColor: ["#218838", "#e0a800", "#0056b3"],
                        },
                    ],
                };

                // Chart.js 옵션
                const options = {
                    responsive: true,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const value = context.raw;
                                    const percentage = ((value / totalTasks) * 100).toFixed(2);
                                    return `${context.label}: ${value}개 (${percentage}%)`;
                                },
                            },
                        },
                        datalabels: {
                            color: "#fff", // 글자 색상
                            font: {
                                size: 14, // 글자 크기
                                weight: "bold", // 글자 굵기
                            },
                            formatter: function (value) {
                                return value; // 각 섹션의 값 표시
                            },
                        },
                    },
                };

                // 원형 그래프 생성
                new Chart(ctx, {
                    type: "pie",
                    data: chartData,
                    options: options,
                });
            }


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────



            /* 스프린트별 작업량 */

            // 그래프 인스턴스 저장 변수
            let sprintChart = null;

            // 프로젝트별 스프린트 목록 가져오기
            async function fetchProjectSprints(projectId) {
                try {
                    const response = await fetch(`${API_URL}/summary/projects/${projectId}/sprints`);
                    if (!response.ok) {
                        throw new Error(`Failed to fetch project sprints. Status: ${response.status}`);
                    }

                    const sprints = await response.json();
                    console.log("스프린트 목록:", sprints);

                    const sprintSelect = document.getElementById("sprint-select");
                    sprintSelect.innerHTML = ""; // 기존 옵션 초기화

                    // 스프린트 옵션 추가
                    sprints.forEach((sprint) => {
                        const option = document.createElement("option");
                        option.value = sprint.sprintId;
                        option.textContent = sprint.sprintName;
                        sprintSelect.appendChild(option);
                    });

                    // 첫 번째 스프린트 데이터로 초기화
                    if (sprints.length > 0) {
                        fetchSprintTasks(sprints[0].sprintId);
                    } else {
                        alert("해당 프로젝트에는 스프린트가 없습니다.");
                    }
                } catch (error) {
                    console.error("Fetch error:", error);
                    alert("스프린트 목록을 가져오는 중 오류가 발생했습니다.");
                }
            }



            // 특정 스프린트의 작업량 데이터를 가져오는 함수
            async function fetchSprintTasks(sprintId) {
                try {
                    const response = await fetch(`${API_URL}/summary/sprints/${sprintId}/team/tasks`);
                    if (!response.ok) {
                        throw new Error(`Failed to fetch sprint tasks. Status: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log(`스프린트 ID ${sprintId} 작업 데이터:`, data);

                    renderSprintTasksChart(data);
                } catch (error) {
                    console.error("Fetch error:", error);
                    alert("스프린트 작업 데이터를 가져오는 중 오류가 발생했습니다.");
                }
            }



            // 스프린트 작업량 데이터를 막대그래프로 렌더링하는 함수
            function renderSprintTasksChart(data) {
                const ctx = document.getElementById("sprintTasksChart").getContext("2d");
            
                // 기존 그래프 제거
                if (sprintChart) {
                    sprintChart.destroy();
                }
            
                // 데이터 처리
                const labels = data.map((task) => task.memberName); // 팀원 이름
                const taskCounts = data.map((task) => task.taskCount); // 작업량
                const maxValue = Math.max(...taskCounts); // 작업량 중 최대값 계산
                const yMax = maxValue < 5 ? 5 : Math.ceil(maxValue / 5) * 5; // 최대값이 5 미만일 경우 최소 5로 설정, 5의 배수로 맞춤
            
                // 랜덤 색상 생성 (팀원별로 고유 색상 설정)
                const backgroundColors = labels.map(() => getRandomColor()); // 랜덤 배경색
                const textColors = backgroundColors.map((bgColor) =>
                    getContrastingTextColor(bgColor)
                ); // 배경색에 따른 텍스트 색상
            
                // Chart.js 데이터
                const chartData = {
                    labels: labels,
                    datasets: [
                        {
                            label: "작업량",
                            data: taskCounts,
                            backgroundColor: backgroundColors, // 팀원별로 랜덤 색상 적용
                            borderColor: "#000000", // 막대 테두리 색상
                            borderWidth: 1,
                        },
                    ],
                };
            
                // Chart.js 옵션
                const options = {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            min: 0, // Y축 최솟값 설정
                            max: yMax, // 동적으로 최대값 설정
                            ticks: {
                                stepSize: 5, // 눈금 간격
                                color: "#000000", // Y축 텍스트 색상
                            },
                            title: {
                                display: true,
                                text: "작업량 (개)",
                                color: "#000000", // 제목 색상
                            },
                        },
                        x: {
                            ticks: {
                                color: textColors, // X축 텍스트 색상을 동적으로 적용
                            },
                            title: {
                                display: true,
                                text: "팀원",
                                color: "#000000", // 제목 색상
                            },
                        },
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const value = context.raw;
                                    return `${context.label}: ${value}개`;
                                },
                            },
                        },
                    },
                };
            
                // 새로운 그래프 생성
                sprintChart = new Chart(ctx, {
                    type: "bar",
                    data: chartData,
                    options: options,
                });
            }

            // 드롭다운 변경 이벤트 핸들러
            document.getElementById("sprint-select").addEventListener("change", (event) => {
                const selectedSprintId = event.target.value;
                fetchSprintTasks(selectedSprintId); // 선택된 스프린트 데이터 가져오기
            });




            // 랜덤 색상 생성 함수
            function getRandomColor() {
                const letters = "0123456789ABCDEF";
                let color = "#";
                for (let i = 0; i < 6; i++) {
                    color += letters[Math.floor(Math.random() * 16)];
                }
                return color;
            }

            // 배경색에 따른 텍스트 색상 결정 함수
            function getContrastingTextColor(bgColor) {
                const r = parseInt(bgColor.slice(1, 3), 16);
                const g = parseInt(bgColor.slice(3, 5), 16);
                const b = parseInt(bgColor.slice(5, 7), 16);

                // 명도 계산
                const brightness = (r * 299 + g * 587 + b * 114) / 1000;
                return brightness > 128 ? "#000000" : "#FFFFFF"; // 밝으면 검정, 어두우면 흰색
            }







            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

            // 페이지 로드 시 데이터 가져오기
            fetchTeamTasks();
            fetchProjectProgress();
            fetchProjectSprints(projectId);




        });
    </script>


</body>

</html>