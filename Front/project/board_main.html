<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>스프린트 보드</title>
    <link rel="icon" sizes="48x48" href="../img/logo.png">
    <link rel="apple-touch-icon" sizes="48x48" href="../img/logo.png">
    <script src="../lib/jquery-3.7.1.min.js"></script>
    <script src="../script/header.js"></script>
    <link rel="stylesheet" href="../css/board_main.css">
    <link rel="stylesheet" href="../css/form-control.css">
    <link rel="stylesheet" href="../css/popup.css">
    <link rel="stylesheet" href="../css/delect_popup.css">
</head>



<body>
    <!-- 헤더 영역 -->
    <header> </header>

    <div class="main">
        <div class="projectList-header">
            <h1>프로젝트</h1>
            <div class="btn-area">
                <button id="addSprintBtn" class="projectList-create-btn">스프린트 만들기</button>
            </div>
        </div>


        <div class="projectList-filters">
            <input type="text" id="search" placeholder="">
            <label for="search">작업 검색</label>

            <!-- 스프린트 필터 -->
            <div class="dropdown-container" style="position: relative;">
                <button id="sprintDropdownButton" class="sprint-dropdown-button">전체</button>
                <div id="sprintDropdownContent" class="sprint-dropdown-content">
                    <!-- 스프린트 항목이 여기에 동적으로 추가됩니다 -->
                </div>
            </div>
        </div>

        <div id="sprintBoard" class="sprint-board">

        </div>
        <div class="delete-popup-background" style="display: none;"></div>
        <!-- 작업 삭제 팝업 -->
        <div id="popup-delete-task" class="delete-popup" style="display: none;">
            <div class="delete-popup-header">
                <img src="../img/warning-icon.png" alt="아이콘" class="header-icon"> <!-- 이미지 삽입 -->
                <div class="header-text">이 작업을 삭제하시겠습니까</div>
            </div>
            <div class="delete-popup-form">
                <p>삭제하면 영구적으로 제거됩니다.</p>
            </div>
            <div class="delete-popup-buttons">
                <button class="cancel-btn">취소</button>
                <button class="delete-btn">삭제</button>
            </div>
        </div>


        <!-- 팝업 배경 (오버레이) -->
        <div class="popup-background" id="popupBackground"></div>

        <!-- 작업 편집 팝업 -->
        <div class="popup" id="editTaskPopup" style="display: none;">
            <div class="popup-header">
                <div class="header-text">작업 편집</div>
                <button type="button" class="delete-btn" id="deleteTaskBtn"></button>
            </div>
            <form class="popup-form">
                <label>작업 이름</label>
                <input type="text" id="editTaskName" placeholder="작업 이름을 입력하세요" required />

                <label>작업 설명</label>
                <textarea id="editTaskDescription" placeholder="작업 설명을 입력하세요"></textarea>
                <div class="date-container">
                    <div class="date-field">
                        <label>시작 날짜</label>
                        <input type="date" id="editTaskStartDate" />
                    </div>
                    <div class="date-field">
                        <label>마감 날짜</label>
                        <input type="date" id="editTaskDueDate" />
                    </div>
                </div>


                <div class="popup-buttons">
                    <button type="button" class="cancel-btn" id="cancelEditTaskBtn">취소</button>
                    <button type="button" class="save-btn" id="saveEditTaskBtn">저장</button>

                </div>
            </form>
        </div>

        <!-- 작업 추가 팝업 -->
        <div class="popup" id="addTaskPopup">
            <div class="popup-header">작업 추가</div>
            <form class="popup-form">
                <label>작업 이름</label>
                <input type="text" id="taskName" placeholder="작업 이름을 입력하세요" required />

                <label>작업 설명</label>
                <textarea id="taskDescription" placeholder="작업 설명을 입력하세요"></textarea>
                <div class="date-container">
                    <div class="date-field">
                        <label>시작 날짜</label>
                        <input type="date" id="taskStartDate" required />
                    </div>
                    <div class="date-field">
                        <label>마감 날짜</label>
                        <input type="date" id="taskDueDate" required />
                    </div>
                </div>




                <!-- 담당자 선택 추가 -->
                <label>담당자</label>
                <select id="taskAssignedTo" required>
                    <option value="" selected>담당자 없음</option> <!-- 기본값 설정 -->
                    <!-- 팀원 목록은 JavaScript로 동적 추가 -->
                </select>

                <div class="popup-buttons">
                    <button type="button" class="cancel-btn" id="cancelTaskBtn">취소</button>
                    <button type="button" class="save-btn" id="taskCreateBtn" data-sprint-id="">저장</button>
                </div>
            </form>
        </div>

        <!-- 스프린트 생성 팝업 -->
        <div class="popup" id="sprintPopup">
            <div class="popup-header">스프린트 생성</div>
            <form class="popup-form">
                <label>스프린트 이름</label>
                <input type="text" id="sprintName" placeholder="스프린트 이름을 입력하세요" required>


                <div class="popup-buttons">
                    <button type="button" class="cancel-btn" id="cancelBtn">취소</button>
                    <button type="button" class="save-btn" id="createBtn">저장</button>
                </div>
            </form>
        </div>


        <!-- 스프린트 편집 팝업 -->
        <div class="popup" id="editSprintPopup">
            <div class="popup-header">스프린트 편집</div>
            <form class="popup-form">
                <label>스프린트 이름</label>
                <input type="text" id="editSprintName" required>

                <div class="popup-buttons">
                    <button type="button" class="cancel-btn" id="editCancelBtn">취소</button>
                    <button type="button" class="save-btn" id="editSaveBtn">저장</button>
                </div>
            </form>
        </div>


    </div>



    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = sessionStorage.getItem("projectId");
        const userIdx = sessionStorage.getItem("userIdx");
        const userIdxh = localStorage.getItem("userIdx"); // 사용자 ID
        const projectIdh = localStorage.getItem("projectId"); // 프로젝트 ID
        const API_URL = "http://192.168.20.37:3000/api";
        //192.168.20.37

        let userRole = null; // 초기값






        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


        // 스프린트 렌더링 함수
        function renderSprints(sprints) {
            const sprintBoard = $("#sprintBoard");
            sprintBoard.empty();

            if (!sprints || sprints.length === 0) {
                sprintBoard.append("<p>스프린트 데이터가 없습니다.</p>");
                return;
            }

            // "임시저장" 스프린트와 기타 스프린트 분리
            const unassignedSprint = sprints.find(sprint => sprint.sprintName === "임시저장");
            const otherSprints = sprints.filter(sprint => sprint.sprintName !== "임시저장");

            // 선택된 스프린트 필터링
            const checkedSprintIds = Array.from(document.querySelectorAll('.sprint-checkbox:checked')).map(cb => cb.value);

            // 선택된 스프린트만 포함
            const filteredSprints = sprints.filter(sprint =>
                checkedSprintIds.length === 0 || checkedSprintIds.includes(String(sprint.sprintId))
            );

            filteredSprints.forEach(sprint => {
                if (!sprint) return;
                // 상태 ID를 상태 이름으로 매핑
                const statusNames = {
                    1: "할 일",
                    2: "진행 중",
                    3: "완료"
                };

                const taskCounts = sprint.tasks.reduce((counts, task) => {
                    counts.total += 1;
                    if (task.statusId === 1) counts.todo += 1;       // 할 일 작업
                    if (task.statusId === 2) counts.inProgress += 1; // 진행 중 작업
                    if (task.statusId === 3) counts.completed += 1;  // 완료된 작업
                    return counts;
                }, { total: 0, todo: 0, inProgress: 0, completed: 0 });


                // 콘솔에 상태 정보 출력
                sprint.tasks.forEach(task => {
                });


                const tasksHTML = sprint.tasks.map(task => {
                    return `
                        <div class="task-card" 
                            ${userRole === "팀원" ? '' : `draggable="true" ondragstart="dragTask(event)"`} 
                            data-task-id="${task.taskId}" 
                            data-sprint-id="${sprint.sprintId}" 
                            data-status-id="${task.statusId}" 
                            data-assigned-to="${task.assignedTo}">
                            
                            <p class="task-name" onclick="openEditTaskPopup(${task.taskId})">
                                <strong>${task.taskName}</strong>
                            </p>

                            <p style="visibility: ${task.statusId === 3 ? 'hidden' : 'visible'};">
                                <span class="readonly-priority priority-${task.priority}">
                                    ${task.priority}
                                </span>
                            </p>
                            <p>
<div class="task-status-dropdown-wrapper">
    <div class="task-status-dropdown" id="statusDropdown-${task.taskId}" data-task-id="${task.taskId}" data-assigned-to="${task.assignedTo}">
     
        <span class="selected-status"></span>
      
        <div class="dropdown-icon"></div>
    </div>
    <div class="dropdown-status-options" id="dropdown-options-${task.taskId}">
        <!-- 동적으로 추가될 옵션들 -->
    </div>
</div>
                            </p>
                            <!-- 담당자 드롭다운 섹션 -->
                            <div class="assignee-section">
                                <div class="assignee-dropdown" style="text-align: center;">
                                    <img src="${task.assignedToImage || '../profile/default-profile.png'}" class="assignee-image" alt="프로필" onclick="toggleAssigneeDropdown(${task.taskId})" >
                                    <span class="assignee-name">${task.assignedToName || '담당자 없음'}</span>
                                </div>

                                <div class="dropdown-options hidden" id="dropdown_${task.taskId}">
                                </div>

                            </div>
                        </div>
                    `;
                }).join('');

                // 스프린트 옵션 메뉴 생성
                const optionsMenu = sprint.sprintName === "임시저장" ? "" : `
                        <button class="options-btn"> <img src="../img/Settings-icon.png" alt="Options" class="settings-icon"></button>
                        <div class="options-menu">
                            ${userRole === "팀장" ? `
                                <button class="edit-sprint-btn" data-sprint-id="${sprint.sprintId}">편집</button>
                                <button class="delete-sprint-btn" data-sprint-id="${sprint.sprintId}">삭제</button>
                            ` : ''}
                        </div>
                    `;

                // 스프린트 HTML 생성
                const sprintHTML = `
                    <div class="sprint" data-sprint-id="${sprint.sprintId}">
                        <div class="sprint-header">
                            <h3>${sprint.sprintName}</h3>
                  <div class="board-column" data-status="할 일">
    <div class="status-header">
        <span class="status-icon">●</span> <!-- 예시 아이콘 (●) -->
        <p class="status-name">${taskCounts.todo} </p>
    </div>
</div>

<div class="board-column" data-status="진행 중">
    <div class="status-header">
        <span class="status-icon">●</span> <!-- 예시 아이콘 (●) -->
        <p class="status-name">${taskCounts.inProgress}</p>
    </div>
</div>

<div class="board-column" data-status="완료">
    <div class="status-header">
        <span class="status-icon">●</span> <!-- 예시 아이콘 (●) -->
        <p class="status-name">${taskCounts.completed} </p>
    </div>
</div>

                            ${optionsMenu}
                        </div>
                        <div class="sprint-content" 
                            ondragover="allowDrop(event, ${sprint.sprintId})" 
                            ondrop="dropTask(event, ${sprint.sprintId})">
                            ${tasksHTML || "<p></p>"}
                      
                        ${sprint.sprintName !== "임시저장" && userRole !== "팀원" // 팀원이 아닌 경우만 추가 버튼을 렌더링
                        ? `
                                    <button class="add-task-btn" 
                                            onclick="openAddTaskPopup(${sprint.sprintId}, '${sprint.endDate || ""}', '${sprint.sprintName}')">
                                        + 추가
                                    </button>
                                
                                  </div>`

                        : ""}
                    </div>`;
                sprintBoard.append(sprintHTML);

                // 각 작업의 상태 드롭다운 로드
                (sprint.tasks || []).forEach(task => {
                    loadStatusDropdown(task);
                });
            });

            // 스프린트 관련 이벤트 바인딩
            bindSprintEvents();
        }



        // 삭제 요청
        function deleteSprint(sprintId) {
            $.ajax({
                url: `${API_URL}/sprint/delete`,
                method: "DELETE",
                contentType: "application/json",
                data: JSON.stringify({ sprintId, projectId }),
                success: function (response) {
                    fetchSprints(); // 스프린트 목록 새로고침
                },
                error: function (err) {
                }
            });
        }

        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

        // 편집 팝업 열기
        function openEditPopup(sprintId) {
            $.ajax({
                url: `${API_URL}/sprint/${sprintId}`,
                method: "GET",
                success: function (data) {
                    // 팝업에 기존 데이터 채우기
                    $("#editSprintName").val(data.sprintName);

                    // 저장 버튼에 스프린트 ID 저장
                    $("#editSaveBtn").data("sprint-id", sprintId);

                    // 팝업 열기
                    $(".popup-background").fadeIn();
                    $("#editSprintPopup").fadeIn();
                },
                error: function (err) {
                    console.error(err);
                }
            });
        }






        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


        // 스프린트 및 태스크 불러오기
        function fetchSprints() {
            // 선택된 스프린트 체크박스 가져오기
            const checkedSprints = Array.from(document.querySelectorAll('.sprint-checkbox:checked')).map(cb => cb.value);

            // 쿼리 파라미터 설정
            const params = new URLSearchParams({ projectId });
            if (checkedSprints.length > 0) {
                params.append('sprints', checkedSprints.join(',')); // 선택된 스프린트 ID들을 추가
            }

            // AJAX 요청
            $.ajax({
                url: `${API_URL}/sprint/list-with-tasks?${params.toString()}`, // 필터링된 스프린트를 요청
                method: "GET",
                success: function (sprints) {
                    renderSprints(sprints); // 필터링된 스프린트를 렌더링
                    updateSprintDropdownButton(); // 스프린트 드롭다운 버튼 텍스트 업데이트
                },
                error: function (err) {
                    console.error("스프린트 조회 오류:", err);
                }
            });
        }



        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


        // 필터링 적용
        async function applyFilters() {
            const checkedSprints = Array.from(document.querySelectorAll('.sprint-checkbox:checked')).map(cb => cb.value);

            // 필터링 조건 추가
            const params = new URLSearchParams({ projectId });
            if (checkedSprints.length > 0) {
                params.append('sprints', checkedSprints.join(','));
            }

            try {
                // API 호출
                const response = await fetch(`${API_URL}/sprint/list-with-tasks?${params.toString()}`);
                const sprints = await response.json();

                // 필터링된 작업이 없을 경우 처리
                if (sprints.length === 0) {
                    const sprintBoard = document.getElementById('sprintBoard');
                    sprintBoard.innerHTML = `<p class="no-tasks-message">선택된 스프린트에 작업이 없습니다.</p>`;
                    return;
                }

                // 필터링된 작업 렌더링
                renderSprints(sprints);

                // 스프린트 드롭다운 버튼 텍스트 업데이트
                updateSprintDropdownButton();
            } catch (err) {
                console.error('필터링 오류:', err);
            }
        }



        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

        function bindSprintEvents() {
            // 옵션 버튼
            $(".options-btn").off("click").on("click", function (e) {
                if (userRole === "팀원") return; // 팀원은 옵션 버튼 사용 불가
                e.stopPropagation(); // 다른 클릭 이벤트 방지
                const menu = $(this).siblings(".options-menu");
                $(".options-menu").not(menu).hide(); // 다른 메뉴 닫기
                menu.toggle(); // 현재 메뉴 열기/닫기
            });

            $(document).off("click").on("click", function () {
                $(".options-menu").hide();
            });

            // 삭제 버튼
            $(".delete-sprint-btn").off("click").on("click", function () {
                if (userRole === "팀원") return; // 팀원은 삭제 버튼 사용 불가
                const sprintId = $(this).data("sprint-id");
                if (confirm("스프린트를 삭제하시겠습니까? 관련 작업은 '임시저장'으로 이동됩니다.")) {
                    deleteSprint(sprintId);
                }
            });

            // 편집 버튼
            $(".edit-sprint-btn").off("click").on("click", function () {
                if (userRole === "팀원") return; // 팀원은 편집 버튼 사용 불가
                const sprintId = $(this).data("sprint-id");
                openEditPopup(sprintId);
            });
        }


        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

        function loadStatusDropdown(task) {
            $.ajax({
                url: `${API_URL}/tasks/status-list`,
                method: "GET",
                success: function (statuses) {
                    if (!Array.isArray(statuses) || statuses.length === 0) {
                        console.error("상태 목록 데이터가 비어 있습니다.");
                        return;
                    }

                    // 현재 상태를 제외한 나머지 상태 필터링
                    const filteredStatuses = statuses.filter(status => status.id !== task.statusId);

                    // 상태 목록 HTML 생성
                    const statusOptions = filteredStatuses.map(status => {
                        const statusClass = `status-${status.name.replace(/\s+/g, '')}`;
                        return `
                        <div 
                            class="dropdown-status-option ${statusClass}" 
                            data-status-id="${status.id}" 
                            data-status-name="${status.name}">
                            <span class="status-icon">●</span>
                            ${status.name}
                        </div>
                    `;
                    }).join("");

                    const dropdown = $(`#statusDropdown-${task.taskId}`);
                    const dropdownOptions = $(`#dropdown-options-${task.taskId}`);

                    if (!dropdown.length) {
                        console.error(`드롭다운 요소를 찾을 수 없습니다. 작업 ID: ${task.taskId}`);
                        return;
                    }

                    dropdownOptions.html(statusOptions);

                    // 현재 상태 표시
                    const selectedStatus = statuses.find(status => status.id === task.statusId);
                    if (selectedStatus) {
                        const selectedClass = `status-${selectedStatus.name.replace(/\s+/g, '')}`;
                        dropdown.addClass(selectedClass);
                        dropdown.find(".selected-status").text(selectedStatus.name);
                    } else {
                        console.warn(`선택된 상태를 찾을 수 없습니다. 작업 ID: ${task.taskId}`);
                    }

                    dropdown.on("click", function () {
                        dropdownOptions.toggle();
                    });

                    dropdownOptions.on("click", ".dropdown-status-option", function () {
                        const selectedStatus = $(this).data("status-name");
                        const selectedStatusId = $(this).data("status-id");

                        dropdown.find(".selected-status").text(selectedStatus);
                        dropdownOptions.hide();

                        task.statusId = selectedStatusId;

                        // 상태 변경을 서버에 반영
                        $.ajax({
                            url: `${API_URL}/tasks/update`,
                            method: "PUT",
                            contentType: "application/json",
                            data: JSON.stringify({
                                taskId: task.taskId,
                                status: selectedStatusId,
                                changedBy: sessionStorage.getItem("userIdx"),
                            }),
                            success: function (response) {
                                fetchSprints();
                            },
                            error: function (err) {
                                console.error(`작업 ID ${task.taskId} 상태 업데이트 중 오류 발생:`, err);
                                alert("상태 변경에 실패했습니다. 다시 시도해주세요.");
                            },
                        });
                    });

                    dropdownOptions.hide();
                },
                error: function (err) {
                    console.error("상태 목록 API 호출 오류:", err);
                }
            });
        }




        // 전역 이벤트 리스너 등록
        $(document).off("change", ".task-status-dropdown").on("change", ".task-status-dropdown", function () {
            const dropdown = $(this);
            const newStatus = dropdown.val(); // 선택한 새로운 상태 값
            const taskId = dropdown.data("task-id"); // 작업 ID
            const changedBy = sessionStorage.getItem("userIdx"); // 변경한 사용자 ID (세션에서 가져옴)


            if (!taskId || !newStatus) {
                console.error("작업 ID 또는 새로운 상태 값이 유효하지 않습니다.");
                return;
            }

            // 상태 업데이트 요청
            $.ajax({
                url: `${API_URL}/tasks/update`,
                method: "PUT",
                contentType: "application/json",
                data: JSON.stringify({
                    taskId: parseInt(taskId, 10), // 작업 ID를 숫자로 변환
                    status: parseInt(newStatus, 10), // 상태 ID를 숫자로 변환
                    changedBy: parseInt(changedBy, 10) // 변경한 사용자 ID를 숫자로 변환
                }),
                beforeSend: function () {
                    if (!taskId || !newStatus || !changedBy) {
                        console.error("필수 데이터 누락:", { taskId, newStatus, changedBy });
                        alert("업데이트에 필요한 데이터가 누락되었습니다.");
                        return false; // 요청 중단
                    }
                },
                success: function (response) {

                    // 화면 전체 새로고침 대신 필요한 부분만 갱신
                    fetchSprints(); // 데이터 새로고침 함수 호출
                },
                error: function (err) {
                    console.error(`작업 ID ${taskId} 상태 업데이트 중 오류 발생:`, {
                        status: err.status,
                        response: err.responseJSON || err.responseText
                    });

                    // 오류 시 사용자에게 알림
                    if (err.status === 400) {
                        alert("잘못된 요청입니다. 입력값을 확인해주세요.");
                    } else if (err.status === 500) {
                        alert("서버에서 문제가 발생했습니다. 잠시 후 다시 시도해주세요.");
                    } else {
                        alert("상태 변경에 실패했습니다. 다시 시도해주세요.");
                    }
                }
            });
        });






        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


        function updateSprintDropdownButton() {
            const checkedSprints = Array.from(document.querySelectorAll('.sprint-checkbox:checked'))
                .map(cb => cb.nextElementSibling.textContent.trim()); // 스프린트 이름 추출
            const sprintDropdownButton = document.getElementById('sprintDropdownButton');
            if (checkedSprints.length > 0) {
                sprintDropdownButton.textContent = checkedSprints.join(', ');
            } else {
                sprintDropdownButton.textContent = '전체';
            }
        }


        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


        // 검색 필터링 함수
        function filterTasksBySearch(query) {
            const sprints = document.querySelectorAll(".sprint");

            sprints.forEach(sprint => {
                const taskCards = sprint.querySelectorAll(".task-card");
                let sprintHasVisibleTasks = false;
                let taskCounts = { todo: 0, inProgress: 0, completed: 0 }; // 상태별 작업 수 초기화

                taskCards.forEach(taskCard => {
                    // task-name과 assignee-name 요소를 안전하게 가져옴
                    const taskNameElement = taskCard.querySelector(".task-name");
                    const assigneeNameElement = taskCard.querySelector(".assignee-name");

                    // taskName 및 taskAssignee의 기본값 설정
                    const taskName = taskNameElement ? taskNameElement.textContent.toLowerCase() : "";
                    const taskAssignee = assigneeNameElement ? assigneeNameElement.textContent.toLowerCase() : "";

                    // 작업 상태 ID 가져오기
                    const statusId = parseInt(taskCard.dataset.statusId, 10);

                    // 검색어 필터링 조건
                    if (taskName.includes(query) || taskAssignee.includes(query)) {
                        taskCard.style.display = ""; // 보이기
                        sprintHasVisibleTasks = true;

                        // 필터된 작업의 상태 카운트 증가
                        if (statusId === 1) taskCounts.todo++;
                        else if (statusId === 2) taskCounts.inProgress++;
                        else if (statusId === 3) taskCounts.completed++;
                    } else {
                        taskCard.style.display = "none"; // 숨기기
                    }
                });

                // 상태 카운트 업데이트
                const sprintTaskCounts = sprint.querySelector(".sprint-task-counts");
                if (sprintTaskCounts) {
                    sprintTaskCounts.textContent = `할 일: ${taskCounts.todo}, 진행 중: ${taskCounts.inProgress}, 완료: ${taskCounts.completed}`;
                }

                // 스프린트 전체 숨김/표시 처리
                if (sprintHasVisibleTasks) {
                    sprint.style.display = ""; // 보이기
                } else {
                    sprint.style.display = "none"; // 숨기기
                }
            });
        }

        // 검색 이벤트 핸들러
        document.getElementById("search").addEventListener("input", function () {
            const query = this.value.toLowerCase().trim();
            filterTasksBySearch(query);
        });




        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


        $(document).ready(function () {



            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

            // projectId와 userIdx 유효성 검증
            if (!projectId || !userIdx) {
                console.error("프로젝트 ID 또는 사용자 ID가 유효하지 않습니다.");
                return;
            }

            // 역할 정보 가져오기
            $.ajax({
                url: `${API_URL}/project/role`,
                method: "GET",
                data: { projectId, userIdx }, // projectId와 userIdx 전달
                success: function (roleInfo) {
                    if (roleInfo && roleInfo.project_role_name) {
                        userRole = roleInfo.project_role_name; // 예: '팀장' 또는 '팀원'
                        updateUIBasedOnRole();
                        fetchSprints(); // 역할 정보를 기반으로 스프린트 렌더링
                    } else {
                        console.error("역할 정보가 유효하지 않습니다.", roleInfo);
                    }
                },
                error: function (err) {
                    console.error("역할 정보 로드 오류:", err);
                }
            });


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


            // 역할에 따른 UI 업데이트
            function updateUIBasedOnRole() {
                if (userRole === "팀원") {
                    // 데스크 추가 버튼 숨기기
                    $("#taskCreateBtn").hide();


                    // 스프린트 생성 버튼 비활성화
                    $("#addSprintBtn").prop("disabled", true).hide();

                    // 작업 편집 팝업 읽기 전용 설정
                    $("#editTaskPopup input, #editTaskPopup textarea, #editTaskPopup select").prop("disabled", true);
                    $("#saveEditTaskBtn, #deleteTaskBtn").hide();

                    // 데스크 추가 버튼 비활성화
                    $("#taskCreateBtn").prop("disabled", true).hide();

                } else {
                }
            }
            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

            if (!projectId) {
                return;
            }

            // 드롭 가능 여부를 확인하고 기본 동작을 방지
            window.allowDrop = function (event) {
                if (!isDragAllowed()) return;
                event.preventDefault();
            };

            // 작업을 드래그할 때 작업 ID를 설정
            window.dragTask = function (event) {
                if (!isDragAllowed()) return;
                const taskId = event.target.dataset.taskId;
                event.dataTransfer.setData("text", taskId);
            };

            // 작업을 새로운 스프린트로 이동
            window.dropTask = function (event, sprintId) {
                if (!isDragAllowed()) return;
                event.preventDefault();
                const taskId = event.dataTransfer.getData("text");

                if (!taskId || !sprintId) {
                    console.error("유효하지 않은 작업 ID 또는 스프린트 ID입니다.");
                    return;
                }

                $.ajax({
                    url: `${API_URL}/tasks/move-sprint`,
                    method: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify({
                        taskId: taskId,
                        newSprintId: sprintId,
                        changedBy: userIdx
                    }),
                    success: function () {
                        fetchSprints();
                    },
                    error: function (err) {
                        console.error("작업 이동 오류:", err);
                    }
                });
            };

            // 드래그 및 드롭 작업이 허용되는지 확인
            function isDragAllowed() {
                if (userRole === "팀원") {
                    console.warn("팀원은 드래그 및 드롭 작업을 수행할 수 없습니다.");
                    return false;
                }
                return true;
            }


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────






            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


            $("#createBtn").off("click").on("click", function () {
                const sprintName = $("#sprintName").val();

                // 서버로 데이터 전송
                $.ajax({
                    url: `${API_URL}/sprint/create`, // API URL 확인
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        projectId, // 프로젝트 ID
                        sprintName,
                    }),
                    success: function (response) {
                        $(".popup-background").fadeOut();
                        $("#sprintPopup").fadeOut();
                        fetchSprints(); // 목록 새로고침
                    },
                    error: function (err) {
                    },
                });
            });




            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────





            // 팀원 목록 렌더링 함수
            async function renderTeamMembers(taskId, projectId) {
                try {

                    // API 호출
                    const response = await $.get(`${API_URL}/project/members`, { projectId });

                    const teamMembers = response;

                    // 드롭다운 요소 찾기
                    const dropdown = document.getElementById(`dropdown_${taskId}`);
                    if (!dropdown) {
                        console.error(`[오류] 작업 ID ${taskId}에 대한 드롭다운을 찾을 수 없습니다.`);
                        return;
                    }


                    // 팀원 목록 추가 + '담당자 없음' 옵션 추가
                    dropdown.innerHTML = `
                        ${teamMembers.map(member => `
                            <div class="dropdown-item" onclick="selectAssignee(${taskId}, ${member.userId}, '${member.profileImage || '../profile/default-profile.png'}', '${member.userName}')">
                                <img src="${member.profileImage || '../profile/default-profile.png'}" class="dropdown-image" alt="프로필">
                                <span>${member.userName}</span>
                            </div>
                        `).join('')}
                        <div class="dropdown-item" onclick="selectAssignee(${taskId}, null, '../profile/default-profile.png', '담당자 없음')">
                            <img src="../profile/default-profile.png" class="dropdown-image" alt="프로필">
                            <span>담당자 없음</span>
                        </div>
                    `;
                } catch (err) {
                    console.error('[오류] 팀원 목록 가져오기 중 오류 발생:', err);
                }
            }


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────



            // 드롭다운 열기/닫기
            window.toggleAssigneeDropdown = async function (taskId) {
                const currentDropdown = document.getElementById(`dropdown_${taskId}`);
                if (!currentDropdown) {
                    console.error(`Dropdown not found for Task ID ${taskId}`);
                    return;
                }

                // 드롭다운 데이터가 없는 경우 팀원 목록 로드
                if (!currentDropdown.innerHTML.trim()) {
                    await renderTeamMembers(taskId, projectId); // 프로젝트 ID를 전달
                }

                // 모든 드롭다운 닫기
                document.querySelectorAll('.dropdown-options').forEach(dropdown => {
                    if (dropdown.id !== `dropdown_${taskId}`) {
                        dropdown.classList.remove('show');
                    }
                });

                // 현재 드롭다운 열기/닫기
                currentDropdown.classList.toggle('show');
            };


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


            // 담당자 변경
            window.selectAssignee = function (taskId, userId, profileImage, userName) {

                // 서버 요청
                $.ajax({
                    url: `${API_URL}/tasks/assign`,
                    method: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify({ taskId, assignedTo: userId, changedBy: userIdx }), // userId가 null일 경우 "담당자 없음"
                    success: function () {

                        // 전체 스프린트를 다시 렌더링
                        fetchSprints();

                        // 드롭다운 닫기
                        const dropdown = document.getElementById(`dropdown_${taskId}`);
                        if (dropdown) {
                            dropdown.classList.remove('show');
                        }
                    },
                    error: function (err) {
                        console.error(`[오류] 작업 ID ${taskId}의 담당자 변경 중 오류 발생:`, err);
                    }
                });
            };






            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


            // 날짜를 "1월 5일" 형식으로 변환하는 함수
            function formatDateToKorean(dateString) {
                const date = new Date(dateString);
                const month = date.getMonth() + 1; // 월 (1~12)
                const day = date.getDate(); // 일 (1~31)
                return `${month}월 ${day}일`;
            }

            // 마감일 포맷 함수
            function formatDueDate(dueDate) {
                const date = new Date(dueDate);
                const month = (date.getMonth() + 1).toString().padStart(2, "0");
                const day = date.getDate().toString().padStart(2, "0");
                return `${month}-${day}`;
            }

            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────



            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

            $("#addSprintBtn").click(function () {
                // 오늘 날짜 디폴트 값 설정
                const today = getTodayDate();
                $("#sprintName").val(""); // 스프린트 이름 초기화

                // 팝업 열기
                $(".popup-background").fadeIn();
                $("#sprintPopup").fadeIn();
            });



            // 오늘 날짜를 YYYY-MM-DD 형식으로 가져오는 함수
            function getTodayDate() {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0'); // 월은 0부터 시작하므로 +1
                const day = String(today.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

            function closePopup() {
                $(".popup-background").fadeOut();
                $(".popup").fadeOut();
            }

            $("#cancelBtn, #editCancelBtn").click(closePopup);



            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────



            $("#editSaveBtn").off("click").on("click", function () {
                const sprintId = $(this).data("sprint-id");
                const sprintName = $("#editSprintName").val();

                $.ajax({
                    url: `${API_URL}/sprint/update`,
                    method: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify({ sprintId, sprintName }),
                    success: function (response) {
                        closePopup();
                        fetchSprints(); // 스프린트 목록 새로고침
                    },
                    error: function (err) {
                        console.error(err);
                    }
                });
            });

            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


            function fetchSprints() {
                $.ajax({
                    url: `${API_URL}/sprint/list-with-tasks`,
                    method: "GET",
                    data: { projectId },
                    success: function (sprints) {
                        renderSprints(sprints);
                    },
                    error: function (err) {
                        console.error("스프린트 조회 오류:", err);
                    }
                });
            }



            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────







            // 초기 값 저장
            $(document).on("focus", ".priority-dropdown", function () {
                // 드롭다운 초기 값 저장
                const currentValue = $(this).val();
                $(this).data("previous-value", currentValue);
            });



            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────









            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────



            // 작업 추가 버튼 클릭 이벤트
            $("#taskCreateBtn").click(function () {
                const taskName = $("#taskName").val();
                const description = $("#taskDescription").val();
                const startDate = $("#taskStartDate").val(); // 시작 날짜
                const dueDate = $("#taskDueDate").val(); // 마감 날짜
                const sprintId = $(this).data("sprint-id");
                const projectId = sessionStorage.getItem("projectId");
                const assignedTo = $("#taskAssignedTo").val(); // 선택한 담당자 ID

                // 필수 필드 확인
                if (!taskName || !startDate || !dueDate) {
                    alert("모든 필드를 입력해주세요.");
                    return;
                }

                // 날짜 유효성 검증
                if (new Date(startDate) > new Date(dueDate)) {
                    alert("시작 날짜는 마감 날짜보다 앞서야 합니다.");
                    return;
                }

                // 작업 추가 요청
                $.ajax({
                    url: `${API_URL}/tasks/create`,
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        projectId,
                        sprintId,
                        taskName,
                        description,
                        startDate,
                        dueDate,
                        assignedTo: assignedTo || null, // 선택한 담당자 ID 또는 null
                    }),
                    success: function () {
                        alert("작업이 성공적으로 추가되었습니다.");
                        $("#addTaskPopup").fadeOut();
                        $(".popup-background").fadeOut();
                        fetchSprints(); // 스프린트 새로고침
                    },
                    error: function (err) {
                        console.error("작업 추가 오류:", err);
                        alert("작업 추가 중 오류가 발생했습니다.");
                    }
                });
            });

            // 담당자 드롭다운 렌더링
            async function renderAssigneeDropdown(projectId) {
                try {
                    // API 호출로 프로젝트 팀원 목록 가져오기
                    const response = await $.get(`${API_URL}/project/members`, { projectId });
                    const teamMembers = response;

                    // 드롭다운 요소 찾기
                    const dropdown = document.getElementById("taskAssignedTo");
                    if (!dropdown) {
                        console.error("[오류] 'taskAssignedTo' 드롭다운을 찾을 수 없습니다.");
                        return;
                    }

                    // 드롭다운 초기화
                    dropdown.innerHTML = `
            <option value="" selected>담당자 없음</option> <!-- 기본값 설정 -->
        `;

                    // 팀원 목록 추가
                    teamMembers.forEach(member => {
                        const option = document.createElement("option");
                        option.value = member.userId;
                        option.textContent = member.userName;
                        dropdown.appendChild(option);
                    });

                } catch (err) {
                    console.error("[오류] 담당자 목록 가져오기 중 오류 발생:", err);
                }
            }


            // 작업 추가 팝업 닫기 버튼 클릭 이벤트
            $("#cancelTaskBtn").click(function () {
                $("#addTaskPopup").fadeOut();
                $(".popup-background").fadeOut();
            });


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────



            //편집 팝업
            $(document).ready(function () {
                // 편집 팝업 닫기
                $("#cancelEditTaskBtn").click(function () {
                    $("#editTaskPopup").fadeOut();
                    $(".popup-background").fadeOut();
                });

                // 작업 저장
                $("#saveEditTaskBtn").click(function () {
                    const taskId = $(this).data("task-id");
                    const taskName = $("#editTaskName").val();
                    const description = $("#editTaskDescription").val();
                    const startDate = $("#editTaskStartDate").val();
                    const dueDate = $("#editTaskDueDate").val();
                    const status = $("#editTaskStatus").val();
                    let assignedTo = $("#editTaskAssignedTo").val();

                    // "담당자 없음" 처리: 빈 값일 경우 null로 설정
                    assignedTo = assignedTo === "" ? null : assignedTo;

                    // **작업 ID 확인**
                    if (!taskId) {
                        alert("작업 ID가 설정되지 않았습니다.");
                        return;
                    }

                    // 필수 필드 확인
                    if (!taskName || !startDate || !dueDate) {
                        alert("모든 필드를 입력해주세요.");
                        return;
                    }

                    // 날짜 유효성 확인
                    if (new Date(startDate) > new Date(dueDate)) {
                        alert("시작 날짜는 마감 날짜보다 앞서야 합니다.");
                        return;
                    }

                    // 권한 검증
                    const isEditable = userRole === "팀장" || userIdx == assignedTo || assignedTo === null;

                    if (!isEditable) {
                        alert("작업을 저장할 권한이 없습니다.");
                        return;
                    }

                    // AJAX 요청
                    // AJAX 요청
                    $.ajax({
                        url: `${API_URL}/tasks/update`,
                        method: "PUT",
                        contentType: "application/json",
                        data: JSON.stringify({
                            taskId: taskId || null, // 작업 ID, null일 경우 오류 방지
                            taskName: taskName || null, // 작업 이름
                            description: description || null, // 작업 설명
                            startDate: startDate || null, // 시작 날짜
                            dueDate: dueDate || null, // 종료 날짜
                            status: status || 1, // 상태 ID, 기본값 1
                            changedBy: userIdx || null, // 변경한 사용자 ID
                            assignedTo: assignedTo || null // 담당자 ID
                        }),
                        beforeSend: function () {
                            // 필수 데이터 유효성 검사
                            if (!taskId || !taskName || !changedBy) {
                                console.error("필수 데이터 누락:", { taskId, taskName, changedBy });
                                alert("작업 저장에 필요한 데이터가 누락되었습니다.");
                                return false; // 요청 중단
                            }
                        },
                        success: function (response) {

                            // 팝업 및 배경 숨기기
                            $("#editTaskPopup").fadeOut();
                            $(".popup-background").fadeOut();

                            // 화면 새로고침 또는 일부 업데이트
                            fetchSprints();
                        },
                        error: function (err) {
                            console.error("작업 저장 오류:", {
                                status: err.status,
                                response: err.responseJSON || err.responseText
                            });

                            // 사용자 알림
                            if (err.status === 400) {
                                alert("잘못된 요청입니다. 입력값을 확인해주세요.");
                            } else if (err.status === 500) {
                                alert("서버에서 문제가 발생했습니다. 잠시 후 다시 시도해주세요.");
                            } else {
                                alert("작업 저장 중 오류가 발생했습니다. 다시 시도해주세요.");
                            }
                        }
                    });

                });



                // 작업 삭제 버튼 클릭 시 팝업 열기
                $("#deleteTaskBtn").click(function () {
                    // 팝업 배경과 삭제 팝업 보이기
                    $(".delete-popup-background").fadeIn();
                    $("#popup-delete-task").fadeIn();

                    // 삭제 버튼 클릭 시 실제 삭제 진행
                    $("#popup-delete-task .delete-btn").click(function () {
                        const taskId = $(this).data("task-id"); // 삭제할 작업 ID (필요시 전달)

                        $.ajax({
                            url: `${API_URL}/tasks/delete`,
                            method: "DELETE",
                            contentType: "application/json",
                            data: JSON.stringify({ taskId }),
                            success: function () {
                                $(".delete-popup-background").fadeOut(); // 배경 닫기
                                $("#popup-delete-task").fadeOut(); // 삭제 팝업 닫기
                                fetchSprints(); // 스프린트 새로고침
                            },
                            error: function (err) {
                                console.error("작업 삭제 실패:", err);
                            },
                        });
                    });

                    // 취소 버튼 클릭 시 팝업 닫기
                    $("#popup-delete-task .cancel-btn").click(function () {
                        $(".delete-popup-background").fadeOut(); // 배경 닫기
                        $("#popup-delete-task").fadeOut(); // 삭제 팝업 닫기
                    });

                    // 배경 클릭 시 팝업 닫기
                    $(".popup-background").click(function () {
                        $(this).fadeOut();
                        $("#popup-delete-task").fadeOut();
                    });
                });

            });

            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────



            // 초기 데이터 로드
            fetchSprints();
        });


        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


        // 함수 정의
        function openAddTaskPopup(sprintId, sprintEndDate, sprintName) {
            if (!sprintId || !sprintEndDate || !sprintName) {
                alert("스프린트 정보를 확인해주세요.");
                return;
            }

            // 팝업에 스프린트 이름 설정
            $("#addTaskPopup .popup-header").text(`작업 추가 - ${sprintName}`);

            // 스프린트 ID와 종료 날짜를 팝업에 설정
            $("#taskCreateBtn").data("sprint-id", sprintId);
            $("#taskDueDate").attr("max", sprintEndDate); // 마감 날짜의 최대값 설정

            // 시작 날짜와 마감 날짜 기본값 설정
            const today = new Date().toISOString().split("T")[0];
            $("#taskStartDate").val(today); // 시작 날짜 기본값
            $("#taskDueDate").val(today);   // 마감 날짜 기본값

            // 팝업 초기화
            $("#taskName").val("");
            $("#taskDescription").val("");

            // 프로젝트 ID 가져오기
            const projectId = sessionStorage.getItem("projectId");
            if (!projectId) {
                alert("프로젝트 ID를 확인할 수 없습니다.");
                return;
            }

            // 담당자 드롭다운 렌더링
            renderAssigneeDropdown(projectId);

            // 팝업 열기
            $("#addTaskPopup").fadeIn();
            $(".popup-background").fadeIn();
        }

        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


        // 작업 편집 팝업 열기
        function openEditTaskPopup(taskId) {
            if (!taskId) {
                console.error("작업 ID가 전달되지 않았습니다.");
                alert("작업 ID가 유효하지 않습니다. 페이지를 새로고침합니다.");
                window.location.reload(); // 작업 ID가 없으면 새로고침
                return;
            }

            $.ajax({
                url: `${API_URL}/tasks/${taskId}`,
                method: "GET",
                success: async function (task) {
                    $("#saveEditTaskBtn").data("task-id", taskId);

                    $("#editTaskName").val(task.taskName || "");
                    $("#editTaskDescription").val(task.description || "");
                    $("#editTaskStartDate").val(task.startDate ? task.startDate.split("T")[0] : "");
                    $("#editTaskDueDate").val(task.dueDate ? task.dueDate.split("T")[0] : "");

                    const isEditable = userRole === "팀장" || userIdx == task.assignedTo;
                    $("#editTaskName, #editTaskDescription, #editTaskStartDate, #editTaskDueDate, #editTaskStatus, #editTaskAssignedTo")
                        .prop("disabled", !isEditable);
                    $("#saveEditTaskBtn, #deleteTaskBtn").toggle(isEditable);

                    loadTaskStatus(task.statusId, isEditable);

                    const projectId = sessionStorage.getItem("projectId");
                    if (projectId) {
                        await renderEditAssigneeDropdown(projectId, task.assignedTo);
                    } else {
                        console.error("프로젝트 ID를 찾을 수 없습니다.");
                    }

                    $(".popup-background").fadeIn();
                    $("#editTaskPopup").fadeIn();
                },
                error: function (err) {
                    console.error("작업 편집 로드 오류:", err);
                    alert("작업 정보를 불러오는 중 오류가 발생했습니다. 페이지를 새로고침합니다.");
                    window.location.reload();
                }
            });
        }




        async function renderEditAssigneeDropdown(projectId, selectedAssigneeId) {
            try {
                const response = await $.get(`${API_URL}/project/members`, { projectId });
                const teamMembers = response;

                const dropdown = document.getElementById("editTaskAssignedTo");
                if (!dropdown) {
                    console.error("[오류] 'editTaskAssignedTo' 드롭다운을 찾을 수 없습니다.");
                    return;
                }

                // 드롭다운 초기화
                dropdown.innerHTML = `
                    <option value="">담당자를 선택하세요</option>
                `;

                // 팀원 목록 추가
                teamMembers.forEach(member => {
                    const option = document.createElement("option");
                    option.value = member.userId;
                    option.textContent = member.userName;
                    if (member.userId === selectedAssigneeId) {
                        option.selected = true; // 기본값 설정
                    }
                    dropdown.appendChild(option);
                });

                // '담당자 없음' 옵션 추가
                const noAssigneeOption = document.createElement("option");
                noAssigneeOption.value = "";
                noAssigneeOption.textContent = "담당자 없음";
                if (!selectedAssigneeId) {
                    noAssigneeOption.selected = true;
                }
                dropdown.appendChild(noAssigneeOption);

            } catch (err) {
                console.error("[오류] 담당자 목록 가져오기 중 오류 발생:", err);
            }
        }

        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────



        // 작업 상태 드롭다운을 로드하고 선택된 상태를 표시
        function loadTaskStatus(selectedStatusId, isEditable) {
            $.ajax({
                url: `${API_URL}/tasks/status-list`,
                method: "GET",
                success: function (statuses) {
                    const statusDropdown = $("#editTaskStatus");
                    statusDropdown.empty();

                    statuses.forEach(status => {
                        const isSelected = status.id === selectedStatusId ? "selected" : "";
                        statusDropdown.append(`<option value="${status.id}" ${isSelected}>${status.name}</option>`);
                    });

                    // 상태 변경 권한 설정
                    if (!isEditable) {
                        statusDropdown.prop("disabled", true);
                    }
                },
                error: function (err) {
                    console.error("작업 상태 로드 오류:", err);
                }
            });
        }



        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

        async function renderAssigneeDropdown(projectId) {
            try {
                const response = await $.get(`${API_URL}/project/members`, { projectId });
                const teamMembers = response;

                const dropdown = document.getElementById("taskAssignedTo");
                if (!dropdown) {
                    console.error("[오류] 'taskAssignedTo' 드롭다운을 찾을 수 없습니다.");
                    return;
                }

                dropdown.innerHTML = `<option value="">담당자를 선택하세요</option>`;

                teamMembers.forEach(member => {
                    const option = document.createElement("option");
                    option.value = member.userId;
                    option.textContent = member.userName;
                    dropdown.appendChild(option);
                });

                const noAssigneeOption = document.createElement("option");
                noAssigneeOption.value = "";
                noAssigneeOption.textContent = "담당자 없음";
                dropdown.appendChild(noAssigneeOption);

            } catch (err) {
                console.error("[오류] 담당자 목록 가져오기 중 오류 발생:", err);
            }
        }



        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

        // 드래그 시작 이벤트
        let draggedSprint = null;

        window.dragSprint = function (event) {
            draggedSprint = event.target; // 드래그 시작된 스프린트를 저장
            event.target.style.opacity = "0.5"; // 시각적으로 반투명 처리
        };

        // 드래그 종료 이벤트
        window.dragSprintEnd = function (event) {
            event.target.style.opacity = "1"; // 투명도 복원
            draggedSprint = null; // 드래그 완료 후 초기화
        };

        // 드롭 가능 영역 진입 이벤트
        window.allowDropSprint = function (event) {
            event.preventDefault(); // 기본 브라우저 동작 방지
        };

        // 드롭 이벤트
        window.dropSprint = function (event) {
            event.preventDefault();

            const targetSprint = event.target.closest(".sprint"); // 드롭된 위치의 스프린트를 찾음
            const sprintBoard = document.querySelector("#sprintBoard"); // 전체 스프린트 보드

            if (targetSprint && draggedSprint !== targetSprint) {
                const allSprints = Array.from(sprintBoard.children); // 모든 스프린트 가져오기
                const draggedIndex = allSprints.indexOf(draggedSprint); // 드래그한 스프린트의 인덱스
                const targetIndex = allSprints.indexOf(targetSprint); // 드롭 위치의 스프린트 인덱스

                if (draggedIndex < targetIndex) {
                    sprintBoard.insertBefore(draggedSprint, targetSprint.nextSibling); // 아래로 이동
                } else {
                    sprintBoard.insertBefore(draggedSprint, targetSprint); // 위로 이동
                }

                saveSprintOrder(); // 변경된 순서를 서버로 저장
            }

            draggedSprint.style.opacity = "1"; // 드래그한 스프린트 투명도 복원
            draggedSprint = null; // 드래그한 스프린트 초기화
        };

        // 스프린트 순서를 서버에 저장
        function saveSprintOrder() {
            const sprintOrder = Array.from(document.querySelectorAll(".sprint")).map((el, index) => ({
                sprintId: el.dataset.sprintId, // 스프린트 ID
                order: index + 1, // 순서
            }));

            // 서버로 AJAX 요청 전송
            $.ajax({
                url: `${API_URL}/sprint/order`, // 서버의 API 엔드포인트
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify(sprintOrder),
                success: function () {
                },
                error: function (err) {
                    console.error("스프린트 순서 저장 실패", err);
                },
            });
        }










        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


        document.addEventListener('DOMContentLoaded', function () {
            const sprintDropdownButton = document.getElementById('sprintDropdownButton');
            const sprintDropdownContent = document.getElementById('sprintDropdownContent');
            const searchInput = document.getElementById('search');
            let teamMembers = [];
            let filteredTasks = [];
            let allTasks = [];
            let statuses = [];

            if (!sprintDropdownButton || !sprintDropdownContent) {
                console.error('스프린트 드롭다운 요소를 찾을 수 없습니다.');
                return;
            }

            // 드롭다운 열기/닫기
            sprintDropdownButton.addEventListener('click', function (e) {
                e.stopPropagation(); // 이벤트 버블링 방지
                sprintDropdownContent.classList.toggle('show');
            });

            // 외부 클릭 시 드롭다운 닫기
            document.addEventListener('click', function (event) {
                if (!sprintDropdownButton.contains(event.target) && !sprintDropdownContent.contains(event.target)) {
                    sprintDropdownContent.classList.remove('show');
                }
            });

            // 스프린트 필터 로드
            async function loadSprintFilters(projectId) {
                try {
                    const response = await fetch(`${API_URL}/sprint/list?projectId=${projectId}`);
                    const sprints = await response.json();
                    sprintDropdownContent.innerHTML = ''; // 기존 콘텐츠 초기화

                    sprints.forEach(sprint => {
                        const sprintDiv = document.createElement('div');
                        sprintDiv.className = 'sprint-item'; // 개별 스프린트 클래스

                        sprintDiv.innerHTML = `
                            <input type="checkbox" class="sprint-checkbox" value="${sprint.sprintId}">
                            <span class="sprint-name">${sprint.sprintName}</span>
                        `;
                        sprintDropdownContent.appendChild(sprintDiv);
                    });

                    // 필터링 이벤트 연결
                    sprintDropdownContent.addEventListener('change', applyFilters);
                } catch (err) {
                    console.error('스프린트 필터 로드 오류:', err);
                }
            }



            // 작업 및 팀원 로드
            async function fetchTasksAndMembers() {
                try {
                    const taskResponse = await fetch(`${API_URL}/tasks/list2?projectId=${projectId}`);
                    allTasks = await taskResponse.json();

                    const membersResponse = await fetch(`${API_URL}/project/members?projectId=${projectId}`);
                    teamMembers = await membersResponse.json();

                    await loadStatuses(); // 상태 목록 로드
                    filteredTasks = allTasks; // 초기에는 모든 작업 표시
                    renderTasks(statuses, filteredTasks, teamMembers);
                } catch (err) {
                    console.error("Error fetching tasks and members:", err);
                }
            }

            // 초기 데이터 로드
            const projectId = sessionStorage.getItem('projectId');
            if (projectId) {
                loadSprintFilters(projectId);
                applyFilters(); // 초기 필터링 적용
            }
        });


        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

    </script>



</body>

</html>