<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>스프린트 보드</title>
    <link rel="icon" sizes="48x48" href="../img/android-icon-48x48.png">
    <link rel="apple-touch-icon" sizes="48x48" href="../img/android-icon-48x48.png">
    <script src="../lib/jquery-3.7.1.min.js"></script>
    <script src="../script/header.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f5f7;
        }

        .main {
            padding: 15px;
            margin-top: 80px;
        }

        .sprint-board {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }

        /* 스프린트 카드 스타일 */
        .sprint {
            border: 1px solid #ddd;
            background-color: #fff;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            width: 700px;
            max-width: 90%;
            margin-bottom: 20px;
            /* 스프린트 간 간격 추가 */
            transition: transform 0.2s ease;
        }

        .sprint:hover {
            transform: translateY(-2px);
            /* 살짝 떠오르는 효과 */
        }

        .sprint-header {
            display: flex;
            justify-content: space-between;
            /* 좌우로 배치 */
            align-items: center;
            margin-bottom: 8px;
            text-align: left;
            /* 텍스트는 왼쪽 정렬 */
            position: relative;
            /* 삭제 버튼 위치 기준 */
            padding: 0 10px;
            /* 좌우 여백 추가 */
        }

        /* 스프린트 제목 스타일 */
        .sprint-header h3 {
            margin: 0;
            font-size: 18px;
            /* 크기를 약간 키움 */
            font-weight: bold;
            color: #333;
            text-align: left;
            /* 제목은 왼쪽 정렬 */
            flex-grow: 1;
            /* 제목이 가능한 공간을 차지하도록 */
        }

        /* 스프린트 날짜 스타일 */
        .sprint-dates {
            font-size: 14px;
            /* 약간 크기 키움 */
            color: #666;
            /* 더 차분한 색상 */
            text-align: right;
            /* 날짜는 오른쪽 정렬 */
            margin: 0;
            flex-shrink: 0;
            /* 날짜 영역 크기 고정 */
            margin-right: 50px;
        }

        /* 스프린트 컨텐츠 */
        .sprint-content {
            padding: 10px;
            /* 연한 배경 추가 */
            border-radius: 4px;
            /* 모서리 둥글게 */
        }



        /* 작업 이름 기본 스타일 */
        .task-name {
            cursor: pointer;
            color: #007bff;
            /* 파란색 */
            font-weight: normal;
            /* 기본 글씨 두께 */
            transition: color 0.2s ease, font-weight 0.2s ease;
            /* 전환 효과 */
        }

        /* 작업 이름에 마우스 오버 시 스타일 */
        .task-name:hover {
            color: #0056b3;
            /* 더 진한 파란색 */
            font-weight: bold;
            /* 글씨 두께를 굵게 변경 */
            text-decoration: underline;
            /* 밑줄 추가 (선택 사항) */
        }


        .task-priority {
            flex-shrink: 0;
            font-size: 12px;
            color: #888;
        }

        #addSprintBtn {
            margin-top: 15px;
            display: inline-block;
            background-color: #40a9ff;
            color: #fff;
            border: none;
            padding: 8px 12px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease;
        }

        #addSprintBtn:hover {
            background-color: #1890ff;
        }











        /* 팝업 스타일 */
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            padding: 20px;
        }

        .popup-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }

        .popup-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .popup-form input {
            padding: 8px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .popup-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .popup-buttons button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .popup-buttons .cancel-btn {
            background-color: #ddd;
        }

        .popup-buttons .cancel-btn:hover {
            background-color: #bbb;
        }

        .popup-buttons .create-btn {
            background-color: #40a9ff;
            color: #fff;
        }

        .popup-buttons .create-btn:hover {
            background-color: #1890ff;
        }

        /* 팝업 배경 */
        .popup-background {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.3);
            z-index: 999;
        }



        /* 옵션 버튼 스타일 */
        .sprint-header .options-btn {
            background-color: transparent;
            border: none;
            font-size: 20px;
            cursor: pointer;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #333;
        }

        .sprint-header .options-btn:hover {
            color: #888;
        }

        /* 드롭다운 메뉴 스타일 */
        .options-menu {
            display: none;
            position: absolute;
            right: 10px;
            top: 100%;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 100;
            width: 120px;
        }

        .options-menu button {

            display: block;
            width: 100%;
            padding: 8px;
            background-color: transparent;
            border: none;
            text-align: left;
            font-size: 14px;
            cursor: pointer;
            color: #333;
        }

        .options-menu button:hover {
            background-color: #f9f9f9;
            color: #000;
        }








        /* 우선순위 및 상태 드롭다운 스타일 */
        /* 드롭다운 기본 스타일 */
        .priority-dropdown,
        .status-dropdown {
            -webkit-appearance: none;
            /* Chrome, Safari, Edge 등 웹킷 기반 브라우저 */
            -moz-appearance: none;
            /* Firefox */
            appearance: none;
            /* 최신 브라우저 */
            width: 40%;
            /* 드롭다운이 셀을 꽉 채우도록 */
            height: 35px;
            /* 드롭다운 높이를 약간 늘려 가독성 향상 */
            font-size: 14px;
            /* 텍스트 크기 조정 */
            padding: 6px 10px;
            /* 안쪽 여백 */
            border: 1px solid #ddd;
            /* 테두리 색상 */
            border-radius: 6px;
            /* 둥근 테두리 */
            background-color: #fff;
            /* 배경색 */
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
            /* 그림자 효과 */
            text-align: center;
            /* 드롭다운 내부 텍스트 가운데 정렬 */
            color: #333;
            /* 텍스트 색상 */
            transition: box-shadow 0.3s ease, border-color 0.3s ease;
            /* 포커스 시 효과 */
        }

        /* 드롭다운 선택 시 스타일 */
        .priority-dropdown:focus,
        .status-dropdown:focus {
            border-color: #40a9ff;
            /* 선택 시 테두리 색상 변경 */
            outline: none;
            /* 기본 outline 제거 */
            box-shadow: 0 0 6px rgba(64, 169, 255, 0.5);
            /* 선택 시 그림자 효과 */
            background-color: #f0f9ff;
            /* 포커스 시 배경색 변경 */
        }

        /* 드롭다운 호버 효과 */
        .priority-dropdown:hover,
        .status-dropdown:hover {
            background-color: #f7faff;
            /* 호버 시 배경색 */
            cursor: pointer;
            /* 포인터 커서로 변경 */
        }


        /* 작업 카드 */
        .task-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            /* 각 요소 간의 간격 균등 분배 */
            padding: 8px 10px;
            background-color: #f9f9f9;
            border: 1px solid #b3d9ff;
            /* 연한 하늘색 테두리 */
            border-radius: 4px;
            /* 테두리에 약간의 곡선 추가 */
            cursor: pointer;
            margin-top: 5px;
            margin-bottom: 5px;
            font-size: 14px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            /* 인터렉션 효과 추가 */
        }

        /* 작업 이름 텍스트 스타일 */
        .task-card p {
            flex: 1;
            /* 가능한 공간을 차지하도록 */
            margin: 0;
            padding-right: 10px;
            /* 우선순위와의 간격 확보 */
            overflow: hidden;
            /* 넘치는 텍스트 숨김 */
            text-overflow: ellipsis;
            /* 말줄임표 추가 */
            white-space: nowrap;
            /* 텍스트 줄바꿈 방지 */
        }


        .task-card:hover {
            background-color: #e6f7ff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }



        /* 작업 이름과 상태 간격 조정 */
        .task-card p+p {
            margin-left: 15px;
            /* 요소 간 간격 추가 */
        }

        /* 작업 이름 스타일 */
        .task-card p strong {
            display: block;
            /* 작업 이름을 블록 요소로 변경 */
            font-weight: bold;
            color: #333;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }




        /* 팀원 읽기 전용 스타일 */
        .readonly-dropdown {
            background-color: #f9f9f9;
            /* 읽기 전용 스타일 배경 */
            color: #555;
            /* 텍스트 색상 */
            pointer-events: none;
            /* 클릭 불가 */
            border: none;
            /* 테두리 제거 */
            font-size: 14px;
            /* 텍스트 크기 */
            text-align: center;
            /* 텍스트 가운데 정렬 */
        }



        /* + 추가 버튼 */
        .add-task-btn-wrapper {
            text-align: center;
            margin-top: 10px;
        }

        .add-task-btn {
            background-color: #40a9ff;
            color: #fff;
            border: none;
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .add-task-btn:hover {
            background-color: #1890ff;
            transform: scale(1.05);
            /* 살짝 확대 */
        }





        textarea#taskDescription {
            width: 100%;
            /* 부모 요소의 전체 폭을 사용 */
            height: 120px;
            /* 높이를 늘려 가독성 향상 */
            padding: 10px;
            /* 안쪽 여백 */
            border: 1px solid #ccc;
            /* 연한 테두리 */
            border-radius: 6px;
            /* 둥근 모서리 */
            font-size: 14px;
            /* 글씨 크기 */
            font-family: Arial, sans-serif;
            /* 글씨체 */
            resize: none;
            /* 크기 조절 불가능 */
            background-color: #f9f9f9;
            /* 배경색 */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            /* 약간의 그림자 */
            transition: box-shadow 0.3s ease, border-color 0.3s ease;
            /* 포커스 시 효과 */
        }

        textarea#taskDescription:focus {
            outline: none;
            /* 기본 포커스 테두리 제거 */
            border-color: #40a9ff;
            /* 포커스 시 테두리 색 변경 */
            box-shadow: 0 0 6px rgba(64, 169, 255, 0.5);
            /* 포커스 시 그림자 효과 */
        }

        /* 작업 이름 입력 박스 */
        input#taskName {
            width: 100%;
            /* 전체 폭 */
            height: 40px;
            /* 높이 */
            padding: 10px;
            /* 안쪽 여백 */
            border: 1px solid #ccc;
            /* 테두리 색 */
            border-radius: 6px;
            /* 둥근 모서리 */
            font-size: 14px;
            /* 글씨 크기 */
            font-family: Arial, sans-serif;
            /* 글씨체 */
            background-color: #f9f9f9;
            /* 배경색 */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            /* 그림자 효과 */
            transition: box-shadow 0.3s ease, border-color 0.3s ease;
            /* 포커스 시 효과 */
        }

        input#taskName:focus {
            outline: none;
            /* 기본 포커스 테두리 제거 */
            border-color: #40a9ff;
            /* 포커스 시 테두리 색 변경 */
            box-shadow: 0 0 6px rgba(64, 169, 255, 0.5);
            /* 포커스 시 그림자 효과 */
        }

        /* 마감 날짜 입력 박스 */
        input#taskDueDate {
            width: 100%;
            /* 전체 폭 */
            height: 40px;
            /* 높이 */
            padding: 10px;
            /* 안쪽 여백 */
            border: 1px solid #ccc;
            /* 테두리 색 */
            border-radius: 6px;
            /* 둥근 모서리 */
            font-size: 14px;
            /* 글씨 크기 */
            font-family: Arial, sans-serif;
            /* 글씨체 */
            background-color: #f9f9f9;
            /* 배경색 */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            /* 그림자 효과 */
            transition: box-shadow 0.3s ease, border-color 0.3s ease;
            /* 포커스 시 효과 */
        }

        input#taskDueDate:focus {
            outline: none;
            /* 기본 포커스 테두리 제거 */
            border-color: #40a9ff;
            /* 포커스 시 테두리 색 변경 */
            box-shadow: 0 0 6px rgba(64, 169, 255, 0.5);
            /* 포커스 시 그림자 효과 */
        }


        /* 버튼 스타일 */
        #saveEditTaskBtn {
            background-color: #40a9ff;
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }

        #saveEditTaskBtn:hover {
            background-color: #1890ff;
        }

        #deleteTaskBtn {
            background-color: #ff4d4f;
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }

        #deleteTaskBtn:hover {
            background-color: #d9363e;
        }










        /* 작업 편집 팝업 */
        #editTaskPopup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            padding: 20px;
        }

        /* 팝업 헤더 */
        #editTaskPopup .popup-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
            color: #333;
        }

        /* 작업 이름 입력 */
        #editTaskName {
            width: 100%;
            height: 40px;
            padding: 10px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background-color: #f9f9f9;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        #editTaskName:focus {
            outline: none;
            border-color: #40a9ff;
            box-shadow: 0 0 6px rgba(64, 169, 255, 0.5);
        }

        /* 작업 설명 입력 */
        #editTaskDescription {
            width: 100%;
            height: 100px;
            padding: 10px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background-color: #f9f9f9;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            resize: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        #editTaskDescription:focus {
            outline: none;
            border-color: #40a9ff;
            box-shadow: 0 0 6px rgba(64, 169, 255, 0.5);
        }

        /* 마감 날짜 */
        #editTaskDueDate {
            width: 100%;
            height: 40px;
            padding: 10px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background-color: #f9f9f9;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        #editTaskDueDate:focus {
            outline: none;
            border-color: #40a9ff;
            box-shadow: 0 0 6px rgba(64, 169, 255, 0.5);
        }

        /* 작업 상태 선택 */
        #editTaskStatus {
            width: 100%;
            height: 40px;
            padding: 10px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background-color: #f9f9f9;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            appearance: none;
        }

        #editTaskStatus:focus {
            outline: none;
            border-color: #40a9ff;
            box-shadow: 0 0 6px rgba(64, 169, 255, 0.5);
        }

        /* 작업 우선순위 선택 */
        #editTaskPriority {
            width: 100%;
            height: 40px;
            padding: 10px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background-color: #f9f9f9;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            appearance: none;
        }

        #editTaskPriority:focus {
            outline: none;
            border-color: #40a9ff;
            box-shadow: 0 0 6px rgba(64, 169, 255, 0.5);
        }

        /* 팝업 버튼 */
        #editTaskPopup .popup-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        /* 취소 버튼 */
        #cancelEditTaskBtn {
            background-color: #ddd;
            color: #333;
            border: none;
            padding: 10px 15px;
            font-size: 14px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #cancelEditTaskBtn:hover {
            background-color: #bbb;
        }

        /* 저장 버튼 */
        #saveEditTaskBtn {
            background-color: #40a9ff;
            color: #fff;
            border: none;
            padding: 10px 15px;
            font-size: 14px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #saveEditTaskBtn:hover {
            background-color: #1890ff;
        }

        /* 삭제 버튼 */
        #deleteTaskBtn {
            background-color: #ff4d4f;
            color: #fff;
            border: none;
            padding: 10px 15px;
            font-size: 14px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #deleteTaskBtn:hover {
            background-color: #d9363e;
        }
    </style>
</head>






<body>
    <!-- 헤더 영역 -->
    <header>
        <script>loadHTML("./header.html")</script>
    </header>

    <div class="main">
        <button id="addSprintBtn">스프린트 만들기</button>
        <div id="sprintBoard" class="sprint-board"></div>
    </div>



    <!-- 작업편집 팝업 -->
    <div class="popup" id="editTaskPopup">
        <div class="popup-header">작업 편집</div>
        <form class="popup-form">
            <label>작업 이름</label>
            <input type="text" id="editTaskName" placeholder="작업 이름을 입력하세요" required />

            <label>작업 설명</label>
            <textarea id="editTaskDescription" placeholder="작업 설명을 입력하세요"></textarea>

            <label>마감 날짜</label>
            <input type="date" id="editTaskDueDate" />

            <label>작업 상태</label>
            <select id="editTaskStatus"></select>

            <label>작업 우선순위</label>
            <select id="editTaskPriority">
                <option value="낮음">낮음</option>
                <option value="중간">중간</option>
                <option value="높음">높음</option>
                <option value="긴급">긴급</option>
            </select>

            <div class="popup-buttons">
                <button type="button" class="cancel-btn" id="cancelEditTaskBtn">취소</button>
                <button type="button" class="save-btn" id="saveEditTaskBtn">저장</button>
                <button type="button" class="delete-btn" id="deleteTaskBtn">삭제</button>
            </div>
        </form>
    </div>

    <!-- 작업 추가 팝업 -->
    <div class="popup" id="addTaskPopup">
        <div class="popup-header">작업 추가</div>
        <form class="popup-form">
            <label>작업 이름</label>
            <input type="text" id="taskName" placeholder="작업 이름을 입력하세요" required />

            <label>작업 설명</label>
            <textarea id="taskDescription" placeholder="작업 설명을 입력하세요"></textarea>

            <label>마감 날짜</label>
            <input type="date" id="taskDueDate" required />

            <div class="popup-buttons">
                <button type="button" class="cancel-btn" id="cancelTaskBtn">취소</button>
                <button type="button" class="create-btn" id="taskCreateBtn" data-sprint-id="">추가</button>
            </div>
        </form>
    </div>





    <!-- 팝업 배경 -->
    <div class="popup-background"></div>

    <!-- 스프린트 생성 팝업 -->
    <div class="popup" id="sprintPopup">
        <div class="popup-header">스프린트 생성</div>
        <form class="popup-form">
            <label>스프린트 이름</label>
            <input type="text" id="sprintName" placeholder="스프린트 이름을 입력하세요" required>

            <label>시작 날짜</label>
            <input type="date" id="startDate" required>

            <label>종료 날짜</label>
            <input type="date" id="endDate" required>

            <div class="popup-buttons">
                <button type="button" class="cancel-btn" id="cancelBtn">취소</button>
                <button type="button" class="create-btn" id="createBtn">생성</button>
            </div>
        </form>
    </div>


    <!-- 스프린트 편집 팝업 -->
    <div class="popup" id="editSprintPopup">
        <div class="popup-header">스프린트 편집</div>
        <form class="popup-form">
            <label>스프린트 이름</label>
            <input type="text" id="editSprintName" required>

            <label>시작 날짜</label>
            <input type="date" id="editStartDate" required>

            <label>종료 날짜</label>
            <input type="date" id="editEndDate" required>

            <div class="popup-buttons">
                <button type="button" class="cancel-btn" id="editCancelBtn">취소</button>
                <button type="button" class="create-btn" id="editSaveBtn">저장</button>
            </div>
        </form>
    </div>






    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = sessionStorage.getItem("projectId");
        const userIdx = sessionStorage.getItem("userIdx");
        const API_URL = "http://localhost:3000/api";

        let userRole = null; // 초기값

        $(document).ready(function () {


            // projectId와 userIdx 유효성 검증
            if (!projectId || !userIdx) {
                console.error("프로젝트 ID 또는 사용자 ID가 유효하지 않습니다.");
                return;
            }

            // 역할 정보 가져오기
            $.ajax({
                url: `${API_URL}/project/role`,
                method: "GET",
                data: { projectId, userIdx }, // projectId와 userIdx 전달
                success: function (roleInfo) {
                    if (roleInfo && roleInfo.project_role_name) {
                        userRole = roleInfo.project_role_name; // 예: '팀장' 또는 '팀원'
                        updateUIBasedOnRole();
                        fetchSprints(); // 역할 정보를 기반으로 스프린트 렌더링
                    } else {
                        console.error("역할 정보가 유효하지 않습니다.", roleInfo);
                    }
                },
                error: function (err) {
                    console.error("역할 정보 로드 오류:", err);
                }
            });

            // 역할에 따른 UI 업데이트
            function updateUIBasedOnRole() {
                if (userRole === "팀원") {
                    // 데스크 추가 버튼 숨기기
                    $("#taskCreateBtn").hide();


                    // 스프린트 생성 버튼 비활성화
                    $("#addSprintBtn").prop("disabled", true).hide();

                    // 작업 편집 팝업 읽기 전용 설정
                    $("#editTaskPopup input, #editTaskPopup textarea, #editTaskPopup select").prop("disabled", true);
                    $("#saveEditTaskBtn, #deleteTaskBtn").hide();

                    // 데스크 추가 버튼 비활성화
                    $("#taskCreateBtn").prop("disabled", true).hide();

                    console.log("팀원은 제한된 작업만 수행할 수 있습니다.");
                } else {
                    console.log("팀장은 모든 작업을 수행할 수 있습니다.");
                }
            }
            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

            if (!projectId) {
                return;
            }

            // 드래그 앤 드롭 핸들러 정의
            window.allowDrop = function (event) {
                if (userRole === "팀원") return; // 팀원은 드래그 허용 안함
                event.preventDefault();
            };

            window.dragTask = function (event) {
                if (userRole === "팀원") return; // 팀원은 드래그 허용 안함
                const taskId = event.target.dataset.taskId;
                event.dataTransfer.setData("text", taskId);
            };

            window.dropTask = function (event, sprintId) {
                if (userRole === "팀원") return; // 팀원은 드롭 허용 안함
                event.preventDefault();
                const taskId = event.dataTransfer.getData("text");

                $.ajax({
                    url: `${API_URL}/tasks/move-sprint`,
                    method: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify({
                        taskId: taskId,
                        newSprintId: sprintId,
                        changedBy: userIdx
                    }),
                    success: function () {
                        fetchSprints();
                    },
                    error: function (err) {
                        console.error("작업 이동 오류:", err);
                    }
                });
            };



            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────



            // 스프린트 및 태스크 불러오기
            function fetchSprints() {
                $.ajax({
                    url: `${API_URL}/sprint/list-with-tasks`,
                    method: "GET",
                    data: { projectId },
                    success: function (sprints) {
                        renderSprints(sprints);
                    },
                    error: function (err) {
                        console.error("스프린트 조회 오류:", err);
                    }
                });
            }


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


            $("#createBtn").off("click").on("click", function () {
                const sprintName = $("#sprintName").val();
                const startDate = $("#startDate").val();
                const endDate = $("#endDate").val();

                if (!sprintName || !startDate || !endDate) {
                    return;
                }

                if (new Date(startDate) > new Date(endDate)) {
                    return;
                }

                // 서버로 데이터 전송
                $.ajax({
                    url: `${API_URL}/sprint/create`, // API URL 확인
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        projectId, // 프로젝트 ID
                        sprintName,
                        startDate,
                        endDate,
                    }),
                    success: function (response) {
                        $(".popup-background").fadeOut();
                        $("#sprintPopup").fadeOut();
                        fetchSprints(); // 목록 새로고침
                    },
                    error: function (err) {
                    },
                });
            });




            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────



            // 스프린트 렌더링 함수
            function renderSprints(sprints) {
                const sprintBoard = $("#sprintBoard");
                sprintBoard.empty();

                if (!sprints || sprints.length === 0) {
                    sprintBoard.append("<p>스프린트 데이터가 없습니다.</p>");
                    return;
                }

                // "임시저장" 스프린트와 기타 스프린트 분리
                const unassignedSprint = sprints.find(sprint => sprint.sprintName === "임시저장");
                const otherSprints = sprints.filter(sprint => sprint.sprintName !== "임시저장");

                // 스프린트를 렌더링
                [...otherSprints, unassignedSprint].forEach(sprint => {
                    if (!sprint) return;

                    // 작업 카드 HTML 생성
                    const tasksHTML = (sprint.tasks || []).map(task => `
                        <div class="task-card" 
                            ${userRole === "팀원" ? '' : 'draggable="true" ondragstart="dragTask(event)"'} 
                            data-task-id="${task.taskId}">
                            <p class="task-name" onclick="openEditTaskPopup(${task.taskId})">
                                <strong>${task.taskName}</strong>
                            </p>
                            <p>
                                ${userRole === "팀장" ? `
                                    <select id="priorityDropdown-${task.taskId}" class="priority-dropdown" data-task-id="${task.taskId}">
                                        <option value="낮음" ${task.priority === '낮음' ? 'selected' : ''}>낮음</option>
                                        <option value="중간" ${task.priority === '중간' ? 'selected' : ''}>중간</option>
                                        <option value="높음" ${task.priority === '높음' ? 'selected' : ''}>높음</option>
                                        <option value="긴급" ${task.priority === '긴급' ? 'selected' : ''}>긴급</option>
                                    </select>
                                ` : `<span class="readonly-dropdown">${task.priority}</span>`}
                            </p>
                            <p>
                                <select id="statusDropdown-${task.taskId}" class="status-dropdown" data-task-id="${task.taskId}">
                                    <option value="">로딩 중...</option>
                                </select>
                            </p>
                        </div>
                    `).join("");

                    // 스프린트 옵션 메뉴 생성
                    const optionsMenu = sprint.sprintName === "임시저장" ? "" : `
                        <button class="options-btn">...</button>
                        <div class="options-menu">
                            ${userRole === "팀장" ? `
                                <button class="edit-sprint-btn" data-sprint-id="${sprint.sprintId}">편집</button>
                                <button class="delete-sprint-btn" data-sprint-id="${sprint.sprintId}">삭제</button>
                            ` : ''}
                        </div>
                    `;

                    // 스프린트 HTML 생성
                    const sprintHTML = `
                        <div class="sprint" data-sprint-id="${sprint.sprintId}">
                            <div class="sprint-header">
                                <h3>${sprint.sprintName}</h3>
                                ${sprint.sprintName !== "임시저장"
                            ? `<p class="sprint-dates">${formatDateToKorean(sprint.startDate)} ~ ${formatDateToKorean(sprint.endDate)}</p>`
                            : ""}
                                ${optionsMenu}
                            </div>
                            <div class="sprint-content" 
                                ondragover="allowDrop(event)" 
                                ondrop="dropTask(event, ${sprint.sprintId})">
                                ${tasksHTML || "<p></p>"}
                            </div>
                            ${sprint.sprintName !== "임시저장" && userRole !== "팀원" // 팀원이 아닌 경우만 추가 버튼을 렌더링
                            ? `<div class="add-task-btn-wrapper">
                                        <button class="add-task-btn" 
                                                onclick="openAddTaskPopup(${sprint.sprintId}, '${sprint.endDate || ""}', '${sprint.sprintName}')">
                                            + 추가
                                        </button>
                                    </div>`
                            : ""
                        }
                        </div>`;
                    sprintBoard.append(sprintHTML);

                    // 각 작업의 상태 드롭다운 로드
                    (sprint.tasks || []).forEach(task => {
                        loadStatusDropdown(task);
                    });
                });

                // 스프린트 관련 이벤트 바인딩
                bindSprintEvents();
            }


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


            // 날짜를 "1월 5일" 형식으로 변환하는 함수
            function formatDateToKorean(dateString) {
                const date = new Date(dateString);
                const month = date.getMonth() + 1; // 월 (1~12)
                const day = date.getDate(); // 일 (1~31)
                return `${month}월 ${day}일`;
            }

            // 마감일 포맷 함수
            function formatDueDate(dueDate) {
                const date = new Date(dueDate);
                const month = (date.getMonth() + 1).toString().padStart(2, "0");
                const day = date.getDate().toString().padStart(2, "0");
                return `${month}-${day}`;
            }

            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

            function bindSprintEvents() {
                // 옵션 버튼
                $(".options-btn").off("click").on("click", function (e) {
                    if (userRole === "팀원") return; // 팀원은 옵션 버튼 사용 불가
                    e.stopPropagation(); // 다른 클릭 이벤트 방지
                    const menu = $(this).siblings(".options-menu");
                    $(".options-menu").not(menu).hide(); // 다른 메뉴 닫기
                    menu.toggle(); // 현재 메뉴 열기/닫기
                });

                $(document).off("click").on("click", function () {
                    $(".options-menu").hide();
                });

                // 삭제 버튼
                $(".delete-sprint-btn").off("click").on("click", function () {
                    if (userRole === "팀원") return; // 팀원은 삭제 버튼 사용 불가
                    const sprintId = $(this).data("sprint-id");
                    if (confirm("스프린트를 삭제하시겠습니까? 관련 작업은 '임시저장'으로 이동됩니다.")) {
                        deleteSprint(sprintId);
                    }
                });

                // 편집 버튼
                $(".edit-sprint-btn").off("click").on("click", function () {
                    if (userRole === "팀원") return; // 팀원은 편집 버튼 사용 불가
                    const sprintId = $(this).data("sprint-id");
                    openEditPopup(sprintId);
                });
            }

            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

            // 삭제 요청
            function deleteSprint(sprintId) {
                $.ajax({
                    url: `${API_URL}/sprint/delete`,
                    method: "DELETE",
                    contentType: "application/json",
                    data: JSON.stringify({ sprintId, projectId }),
                    success: function (response) {
                        fetchSprints(); // 스프린트 목록 새로고침
                    },
                    error: function (err) {
                    }
                });
            }

            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

            // 편집 팝업 열기
            function openEditPopup(sprintId) {
                $.ajax({
                    url: `${API_URL}/sprint/${sprintId}`,
                    method: "GET",
                    success: function (data) {
                        // 팝업에 기존 데이터 채우기
                        $("#editSprintName").val(data.sprintName);
                        $("#editStartDate").val(data.startDate.split("T")[0]); // YYYY-MM-DD 형식
                        $("#editEndDate").val(data.endDate.split("T")[0]);     // YYYY-MM-DD 형식

                        // 저장 버튼에 스프린트 ID 저장
                        $("#editSaveBtn").data("sprint-id", sprintId);

                        // 팝업 열기
                        $(".popup-background").fadeIn();
                        $("#editSprintPopup").fadeIn();
                    },
                    error: function (err) {
                        console.error(err);
                    }
                });
            }


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

            $("#addSprintBtn").click(function () {
                // 오늘 날짜 디폴트 값 설정
                const today = getTodayDate();
                $("#sprintName").val(""); // 스프린트 이름 초기화
                $("#startDate").val(today); // 시작 날짜 초기화
                $("#endDate").val(today);   // 종료 날짜 초기화

                // 팝업 열기
                $(".popup-background").fadeIn();
                $("#sprintPopup").fadeIn();
            });



            // 오늘 날짜를 YYYY-MM-DD 형식으로 가져오는 함수
            function getTodayDate() {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0'); // 월은 0부터 시작하므로 +1
                const day = String(today.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

            function closePopup() {
                $(".popup-background").fadeOut();
                $(".popup").fadeOut();
            }

            $("#cancelBtn, #editCancelBtn").click(closePopup);



            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────



            $("#editSaveBtn").off("click").on("click", function () {
                const sprintId = $(this).data("sprint-id");
                const sprintName = $("#editSprintName").val();
                const startDate = $("#editStartDate").val();
                const endDate = $("#editEndDate").val();

                if (!sprintName || !startDate || !endDate) {
                    return;
                }

                if (new Date(startDate) > new Date(endDate)) {
                    return;
                }

                $.ajax({
                    url: `${API_URL}/sprint/update`,
                    method: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify({ sprintId, sprintName, startDate, endDate }),
                    success: function (response) {
                        closePopup();
                        fetchSprints(); // 스프린트 목록 새로고침
                    },
                    error: function (err) {
                        console.error(err);
                    }
                });
            });

            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


            function fetchSprints() {
                $.ajax({
                    url: `${API_URL}/sprint/list-with-tasks`,
                    method: "GET",
                    data: { projectId },
                    success: function (sprints) {
                        renderSprints(sprints);
                    },
                    error: function (err) {
                        console.error("스프린트 조회 오류:", err);
                    }
                });
            }



            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


            $(document).on("change", ".status-dropdown", function () {
                const taskId = $(this).closest(".task-card").data("task-id");
                const newStatus = $(this).val();
                const changedBy = userIdx; // 로그인 사용자 ID
                const taskName = $(this).closest(".task-card").find("p strong").text(); // 작업 이름

                const requestData = {
                    taskId,
                    taskName,
                    status: newStatus,
                    changedBy
                };


                // AJAX 요청
                $.ajax({
                    url: `${API_URL}/tasks/update`,
                    method: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify(requestData),
                    success: function (response) {
                    },
                    error: function (err) {
                    }
                });
            });


            $(document).on("change", ".priority-dropdown", function () {
                if (userRole === "팀원") {
                    // 드롭다운 값을 변경 이전 상태로 복원
                    const previousValue = $(this).data("previous-value");
                    $(this).val(previousValue);
                    return;
                }

                const taskId = $(this).data("task-id") || $(this).attr("id").split("-")[1]; // taskId 추출
                const newPriority = $(this).val(); // 새 우선순위 값
                const changedBy = userIdx; // 로그인 사용자 ID

                if (!taskId) {
                    console.error("taskId가 정의되지 않았습니다. data-task-id 속성을 확인하세요.");
                    return; // taskId가 없으면 요청을 보내지 않음
                }

                const requestData = {
                    taskId,
                    priority: newPriority,
                    changedBy
                };

                // AJAX 요청
                $.ajax({
                    url: `${API_URL}/tasks/update`,
                    method: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify(requestData),
                    success: function (response) {
                        // 성공적으로 업데이트된 경우, 새로운 값을 저장
                        $(this).data("previous-value", newPriority);
                    },
                    error: function (err) {
                        // 오류 발생 시, 이전 값으로 복원
                        $(this).val($(this).data("previous-value"));
                    }
                });
            });

            // 초기 값 저장
            $(document).on("focus", ".priority-dropdown", function () {
                const currentValue = $(this).val();
                $(this).data("previous-value", currentValue);
            });



            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


            function loadStatusDropdown(task) {
                $.ajax({
                    url: `${API_URL}/tasks/status-list`, // 상태 목록 API 호출
                    method: "GET",
                    success: function (statuses) {
                        // 상태 목록 데이터를 옵션으로 변환
                        const statusOptions = statuses.map(status => `
                <option value="${status.id}" ${task.statusId === status.id ? 'selected' : ''}>
                    ${status.name}
                </option>
            `).join("");

                        // 드롭다운 업데이트
                        $(`#statusDropdown-${task.taskId}`).html(statusOptions);
                    },
                    error: function (err) {
                    }
                });
            }





            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


            $("#taskCreateBtn").click(function () {
                const taskName = $("#taskName").val();
                const description = $("#taskDescription").val();
                const dueDate = $("#taskDueDate").val();
                const sprintId = $(this).data("sprint-id");
                const projectId = sessionStorage.getItem("projectId");
                const userIdx = sessionStorage.getItem("userIdx");

                if (!taskName) {
                    return;
                }

                if (!dueDate) {
                    return;
                }

                $.ajax({
                    url: `${API_URL}/tasks/create`,
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        projectId,
                        sprintId,
                        taskName,
                        description,
                        dueDate,
                        assignedTo: userIdx, // 현재 사용자를 작업에 할당
                    }),
                    success: function (response) {
                        $("#addTaskPopup").fadeOut();
                        $(".popup-background").fadeOut();
                        fetchSprints(); // 스프린트 새로고침
                    },
                    error: function (err) {
                    },
                });
            });


            $("#cancelTaskBtn").click(function () {
                $("#addTaskPopup").fadeOut();
                $(".popup-background").fadeOut();
            });


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


            $(document).ready(function () {
                // 편집 팝업 닫기
                $("#cancelEditTaskBtn").click(function () {
                    $("#editTaskPopup").fadeOut();
                    $(".popup-background").fadeOut();
                });

                // 작업 저장
                $("#saveEditTaskBtn").click(function () {
                    const taskId = $(this).data("task-id");
                    const taskName = $("#editTaskName").val();
                    const description = $("#editTaskDescription").val();
                    const dueDate = $("#editTaskDueDate").val();

                    if (!taskName) {
                        return;
                    }

                    $.ajax({
                        url: `${API_URL}/tasks/update`,
                        method: "PUT",
                        contentType: "application/json",
                        data: JSON.stringify({
                            taskId,
                            taskName,
                            description,
                            dueDate,
                            changedBy: sessionStorage.getItem("userIdx"),
                        }),
                        success: function () {
                            $("#editTaskPopup").fadeOut();
                            $(".popup-background").fadeOut();
                            fetchSprints(); // 스프린트 새로고침
                        },
                        error: function (err) {
                        },
                    });
                });

                // 작업 삭제
                $("#deleteTaskBtn").click(function () {
                    const taskId = $(this).data("task-id");

                    if (!confirm("정말로 이 작업을 삭제하시겠습니까?")) {
                        return;
                    }

                    $.ajax({
                        url: `${API_URL}/tasks/delete`,
                        method: "DELETE",
                        contentType: "application/json",
                        data: JSON.stringify({ taskId }),
                        success: function () {
                            $("#editTaskPopup").fadeOut();
                            $(".popup-background").fadeOut();
                            fetchSprints(); // 스프린트 새로고침
                        },
                        error: function (err) {
                        },
                    });
                });
            });

            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────



            // 초기 데이터 로드
            fetchSprints();
        });
        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


        // 함수 정의
        function openAddTaskPopup(sprintId, sprintEndDate, sprintName) {
            if (!sprintId || !sprintEndDate || !sprintName) {
                return;
            }


            // 팝업에 스프린트 이름 설정
            $("#addTaskPopup .popup-header").text(`작업 추가 - ${sprintName}`);

            // 스프린트 ID와 종료 날짜를 팝업에 설정
            $("#taskCreateBtn").data("sprint-id", sprintId);
            $("#taskDueDate").attr("max", sprintEndDate); // 마감 날짜의 최대값 설정

            // 마감 날짜 기본값을 오늘 날짜로 설정
            const today = new Date().toISOString().split("T")[0];
            $("#taskDueDate").val(today);

            // 팝업 초기화 및 열기
            $("#taskName").val("");
            $("#taskDescription").val("");
            $("#addTaskPopup").fadeIn();
            $(".popup-background").fadeIn();
        }

        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


        // 작업 편집 팝업 열기
        function openEditTaskPopup(taskId) {
            $.ajax({
                url: `${API_URL}/tasks/${taskId}`,
                method: "GET",
                success: function (task) {
                    $("#editTaskName").val(task.task_name || "");
                    $("#editTaskDescription").val(task.description || "");
                    $("#editTaskDueDate").val(task.due_date ? task.due_date.split("T")[0] : "");

                    // 저장 및 삭제 버튼 활성화 여부
                    if (userRole === "팀원") {
                        $("#saveEditTaskBtn, #deleteTaskBtn").hide();
                    } else {
                        $("#saveEditTaskBtn, #deleteTaskBtn").show();
                    }

                    $(".popup-background").fadeIn();
                    $("#editTaskPopup").fadeIn();
                },
                error: function (err) {
                    console.error("작업 편집 로드 오류:", err);
                }
            });
        }

        function loadTaskStatus(selectedStatusId) {
            $.ajax({
                url: `${API_URL}/tasks/status-list`,
                method: "GET",
                success: function (statuses) {
                    const statusDropdown = $("#editTaskStatus");
                    statusDropdown.empty();

                    statuses.forEach(status => {
                        const isSelected = status.id === selectedStatusId ? "selected" : "";
                        statusDropdown.append(`<option value="${status.id}" ${isSelected}>${status.name}</option>`);
                    });
                },
                error: function (err) {
                }
            });
        }

        function loadTaskPriority(selectedPriority) {
            const priorities = ["낮음", "중간", "높음", "긴급"];
            const priorityDropdown = $("#editTaskPriority");
            priorityDropdown.empty();

            priorities.forEach(priority => {
                const isSelected = priority === selectedPriority ? "selected" : "";
                priorityDropdown.append(`<option value="${priority}" ${isSelected}>${priority}</option>`);
            });
        }



        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

        // 드래그 시작 이벤트
        let draggedSprint = null;

        window.dragSprint = function (event) {
            draggedSprint = event.target; // 드래그 시작된 스프린트를 저장
            event.target.style.opacity = "0.5"; // 시각적으로 반투명 처리
        };

        // 드래그 종료 이벤트
        window.dragSprintEnd = function (event) {
            event.target.style.opacity = "1"; // 투명도 복원
            draggedSprint = null; // 드래그 완료 후 초기화
        };

        // 드롭 가능 영역 진입 이벤트
        window.allowDropSprint = function (event) {
            event.preventDefault(); // 기본 브라우저 동작 방지
        };

        // 드롭 이벤트
        window.dropSprint = function (event) {
            event.preventDefault();

            const targetSprint = event.target.closest(".sprint"); // 드롭된 위치의 스프린트를 찾음
            const sprintBoard = document.querySelector("#sprintBoard"); // 전체 스프린트 보드

            if (targetSprint && draggedSprint !== targetSprint) {
                const allSprints = Array.from(sprintBoard.children); // 모든 스프린트 가져오기
                const draggedIndex = allSprints.indexOf(draggedSprint); // 드래그한 스프린트의 인덱스
                const targetIndex = allSprints.indexOf(targetSprint); // 드롭 위치의 스프린트 인덱스

                if (draggedIndex < targetIndex) {
                    sprintBoard.insertBefore(draggedSprint, targetSprint.nextSibling); // 아래로 이동
                } else {
                    sprintBoard.insertBefore(draggedSprint, targetSprint); // 위로 이동
                }

                saveSprintOrder(); // 변경된 순서를 서버로 저장
            }

            draggedSprint.style.opacity = "1"; // 드래그한 스프린트 투명도 복원
            draggedSprint = null; // 드래그한 스프린트 초기화
        };

        // 스프린트 순서를 서버에 저장
        function saveSprintOrder() {
            const sprintOrder = Array.from(document.querySelectorAll(".sprint")).map((el, index) => ({
                sprintId: el.dataset.sprintId, // 스프린트 ID
                order: index + 1, // 순서
            }));

            // 서버로 AJAX 요청 전송
            $.ajax({
                url: `${API_URL}/sprint/order`, // 서버의 API 엔드포인트
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify(sprintOrder),
                success: function () {
                    console.log("스프린트 순서 저장 완료");
                },
                error: function (err) {
                    console.error("스프린트 순서 저장 실패", err);
                },
            });
        }




    </script>



</body>

</html>