<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>스프린트 보드</title>
    <link rel="icon" sizes="48x48" href="../img/android-icon-48x48.png">
    <link rel="apple-touch-icon" sizes="48x48" href="../img/android-icon-48x48.png">
    <script src="../lib/jquery-3.7.1.min.js"></script>
    <script src="../script/header.js"></script>
    <link rel="stylesheet" href="../css/board_main.css">
</head>



<body>
    <!-- 헤더 영역 -->
    <header>
        <script>loadHTML("./header.html")</script>
    </header>

    <div class="main">
        <button id="addSprintBtn">스프린트 만들기</button>
        <div id="sprintBoard" class="sprint-board"></div>
    </div>



    <!-- 작업편집 팝업 -->
    <div class="popup" id="editTaskPopup">
        <div class="popup-header">작업 편집</div>
        <form class="popup-form">
            <label>작업 이름</label>
            <input type="text" id="editTaskName" placeholder="작업 이름을 입력하세요" required />

            <label>작업 설명</label>
            <textarea id="editTaskDescription" placeholder="작업 설명을 입력하세요"></textarea>

            <label>마감 날짜</label>
            <input type="date" id="editTaskDueDate" />

            <label>작업 상태</label>
            <select id="editTaskStatus"></select>

            <label>작업 우선순위</label>
            <select id="editTaskPriority">
                <option value="낮음">낮음</option>
                <option value="중간">중간</option>
                <option value="높음">높음</option>
                <option value="긴급">긴급</option>
            </select>

            <div class="popup-buttons">
                <button type="button" class="cancel-btn" id="cancelEditTaskBtn">취소</button>
                <button type="button" class="save-btn" id="saveEditTaskBtn">저장</button>
                <button type="button" class="delete-btn" id="deleteTaskBtn">삭제</button>
            </div>
        </form>
    </div>

    <!-- 작업 추가 팝업 -->
    <div class="popup" id="addTaskPopup">
        <div class="popup-header">작업 추가</div>
        <form class="popup-form">
            <label>작업 이름</label>
            <input type="text" id="taskName" placeholder="작업 이름을 입력하세요" required />

            <label>작업 설명</label>
            <textarea id="taskDescription" placeholder="작업 설명을 입력하세요"></textarea>

            <label>마감 날짜</label>
            <input type="date" id="taskDueDate" required />

            <div class="popup-buttons">
                <button type="button" class="cancel-btn" id="cancelTaskBtn">취소</button>
                <button type="button" class="create-btn" id="taskCreateBtn" data-sprint-id="">추가</button>
            </div>
        </form>
    </div>





    <!-- 팝업 배경 -->
    <div class="popup-background"></div>

    <!-- 스프린트 생성 팝업 -->
    <div class="popup" id="sprintPopup">
        <div class="popup-header">스프린트 생성</div>
        <form class="popup-form">
            <label>스프린트 이름</label>
            <input type="text" id="sprintName" placeholder="스프린트 이름을 입력하세요" required>

            <label>시작 날짜</label>
            <input type="date" id="startDate" required>

            <label>종료 날짜</label>
            <input type="date" id="endDate" required>

            <div class="popup-buttons">
                <button type="button" class="cancel-btn" id="cancelBtn">취소</button>
                <button type="button" class="create-btn" id="createBtn">생성</button>
            </div>
        </form>
    </div>


    <!-- 스프린트 편집 팝업 -->
    <div class="popup" id="editSprintPopup">
        <div class="popup-header">스프린트 편집</div>
        <form class="popup-form">
            <label>스프린트 이름</label>
            <input type="text" id="editSprintName" required>

            <label>시작 날짜</label>
            <input type="date" id="editStartDate" required>

            <label>종료 날짜</label>
            <input type="date" id="editEndDate" required>

            <div class="popup-buttons">
                <button type="button" class="cancel-btn" id="editCancelBtn">취소</button>
                <button type="button" class="create-btn" id="editSaveBtn">저장</button>
            </div>
        </form>
    </div>






    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = sessionStorage.getItem("projectId");
        const userIdx = sessionStorage.getItem("userIdx");
        const API_URL = "http://192.168.20.37:3000/api";
        //192.168.20.37
        
        let userRole = null; // 초기값

        $(document).ready(function () {


            // projectId와 userIdx 유효성 검증
            if (!projectId || !userIdx) {
                console.error("프로젝트 ID 또는 사용자 ID가 유효하지 않습니다.");
                return;
            }

            // 역할 정보 가져오기
            $.ajax({
                url: `${API_URL}/project/role`,
                method: "GET",
                data: { projectId, userIdx }, // projectId와 userIdx 전달
                success: function (roleInfo) {
                    if (roleInfo && roleInfo.project_role_name) {
                        userRole = roleInfo.project_role_name; // 예: '팀장' 또는 '팀원'
                        updateUIBasedOnRole();
                        fetchSprints(); // 역할 정보를 기반으로 스프린트 렌더링
                    } else {
                        console.error("역할 정보가 유효하지 않습니다.", roleInfo);
                    }
                },
                error: function (err) {
                    console.error("역할 정보 로드 오류:", err);
                }
            });

            // 역할에 따른 UI 업데이트
            function updateUIBasedOnRole() {
                if (userRole === "팀원") {
                    // 데스크 추가 버튼 숨기기
                    $("#taskCreateBtn").hide();


                    // 스프린트 생성 버튼 비활성화
                    $("#addSprintBtn").prop("disabled", true).hide();

                    // 작업 편집 팝업 읽기 전용 설정
                    $("#editTaskPopup input, #editTaskPopup textarea, #editTaskPopup select").prop("disabled", true);
                    $("#saveEditTaskBtn, #deleteTaskBtn").hide();

                    // 데스크 추가 버튼 비활성화
                    $("#taskCreateBtn").prop("disabled", true).hide();

                    console.log("팀원은 제한된 작업만 수행할 수 있습니다.");
                } else {
                    console.log("팀장은 모든 작업을 수행할 수 있습니다.");
                }
            }
            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

            if (!projectId) {
                return;
            }

            // 드롭 가능 여부를 확인하고 기본 동작을 방지
            window.allowDrop = function (event) {
                if (!isDragAllowed()) return;
                event.preventDefault();
            };

            // 작업을 드래그할 때 작업 ID를 설정
            window.dragTask = function (event) {
                if (!isDragAllowed()) return;
                const taskId = event.target.dataset.taskId;
                event.dataTransfer.setData("text", taskId);
            };

            // 작업을 새로운 스프린트로 이동
            window.dropTask = function (event, sprintId) {
                if (!isDragAllowed()) return;
                event.preventDefault();
                const taskId = event.dataTransfer.getData("text");

                if (!taskId || !sprintId) {
                    console.error("유효하지 않은 작업 ID 또는 스프린트 ID입니다.");
                    return;
                }

                $.ajax({
                    url: `${API_URL}/tasks/move-sprint`,
                    method: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify({
                        taskId: taskId,
                        newSprintId: sprintId,
                        changedBy: userIdx
                    }),
                    success: function () {
                        fetchSprints();
                    },
                    error: function (err) {
                        console.error("작업 이동 오류:", err);
                    }
                });
            };

            // 드래그 및 드롭 작업이 허용되는지 확인
            function isDragAllowed() {
                if (userRole === "팀원") {
                    console.warn("팀원은 드래그 및 드롭 작업을 수행할 수 없습니다.");
                    return false;
                }
                return true;
            }


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────



            // 스프린트 및 태스크 불러오기
            function fetchSprints() {
                $.ajax({
                    url: `${API_URL}/sprint/list-with-tasks`,
                    method: "GET",
                    data: { projectId },
                    success: function (sprints) {
                        renderSprints(sprints);
                    },
                    error: function (err) {
                        console.error("스프린트 조회 오류:", err);
                    }
                });
            }


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


            $("#createBtn").off("click").on("click", function () {
                const sprintName = $("#sprintName").val();
                const startDate = $("#startDate").val();
                const endDate = $("#endDate").val();

                if (!sprintName || !startDate || !endDate) {
                    return;
                }

                if (new Date(startDate) > new Date(endDate)) {
                    return;
                }

                // 서버로 데이터 전송
                $.ajax({
                    url: `${API_URL}/sprint/create`, // API URL 확인
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        projectId, // 프로젝트 ID
                        sprintName,
                        startDate,
                        endDate,
                    }),
                    success: function (response) {
                        $(".popup-background").fadeOut();
                        $("#sprintPopup").fadeOut();
                        fetchSprints(); // 목록 새로고침
                    },
                    error: function (err) {
                    },
                });
            });




            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────



            // 스프린트 렌더링 함수
            function renderSprints(sprints) {
                const sprintBoard = $("#sprintBoard");
                sprintBoard.empty();

                if (!sprints || sprints.length === 0) {
                    sprintBoard.append("<p>스프린트 데이터가 없습니다.</p>");
                    return;
                }

                // "임시저장" 스프린트와 기타 스프린트 분리
                const unassignedSprint = sprints.find(sprint => sprint.sprintName === "임시저장");
                const otherSprints = sprints.filter(sprint => sprint.sprintName !== "임시저장");

                // 스프린트를 렌더링
                [...otherSprints, unassignedSprint].forEach(sprint => {
                    if (!sprint) return;

                    // 작업 카드 HTML 생성
                    const tasksHTML = (sprint.tasks || []).map(task => `
                    <div class="task-card" 
                        ${userRole === "팀원" ? '' : `draggable="true" ondragstart="dragTask(event)"`} 
                        data-task-id="${task.taskId}" 
                        data-sprint-id="${sprint.sprintId}">
                        <p class="task-name" onclick="openEditTaskPopup(${task.taskId})">
                            <strong>${task.taskName}</strong>
                        </p>
                        <p>
                            ${userRole === "팀장" ? `
                                <select id="priorityDropdown-${task.taskId}" class="priority-dropdown" data-task-id="${task.taskId}">
                                    <option value="낮음" ${task.priority === '낮음' ? 'selected' : ''}>낮음</option>
                                    <option value="중간" ${task.priority === '중간' ? 'selected' : ''}>중간</option>
                                    <option value="높음" ${task.priority === '높음' ? 'selected' : ''}>높음</option>
                                    <option value="긴급" ${task.priority === '긴급' ? 'selected' : ''}>긴급</option>
                                </select>
                            ` : `<span class="readonly-dropdown">${task.priority}</span>`}
                        </p>
                        <p>
                            <select id="statusDropdown-${task.taskId}" class="status-dropdown" data-task-id="${task.taskId}">
                                <option value="">로딩 중...</option>
                            </select>
                        </p>
                    </div>
                    `).join("");

                    // 스프린트 옵션 메뉴 생성
                    const optionsMenu = sprint.sprintName === "임시저장" ? "" : `
                        <button class="options-btn">...</button>
                        <div class="options-menu">
                            ${userRole === "팀장" ? `
                                <button class="edit-sprint-btn" data-sprint-id="${sprint.sprintId}">편집</button>
                                <button class="delete-sprint-btn" data-sprint-id="${sprint.sprintId}">삭제</button>
                            ` : ''}
                        </div>
                    `;

                    // 스프린트 HTML 생성
                    const sprintHTML = `
                    <div class="sprint" data-sprint-id="${sprint.sprintId}">
                        <div class="sprint-header">
                            <h3>${sprint.sprintName}</h3>
                            ${sprint.sprintName !== "임시저장"
                        ? `<p class="sprint-dates">${formatDateToKorean(sprint.startDate)} ~ ${formatDateToKorean(sprint.endDate)}</p>`
                        : ""}
                            ${optionsMenu}
                        </div>
                        <div class="sprint-content" 
                            ondragover="allowDrop(event, ${sprint.sprintId})" 
                            ondrop="dropTask(event, ${sprint.sprintId})">
                            ${tasksHTML || "<p></p>"}
                        </div>
                        ${sprint.sprintName !== "임시저장" && userRole !== "팀원" // 팀원이 아닌 경우만 추가 버튼을 렌더링
                        ? `<div class="add-task-btn-wrapper">
                                    <button class="add-task-btn" 
                                            onclick="openAddTaskPopup(${sprint.sprintId}, '${sprint.endDate || ""}', '${sprint.sprintName}')">
                                        + 추가
                                    </button>
                                </div>`
                        : ""}
                    </div>`;
                    sprintBoard.append(sprintHTML);

                    // 각 작업의 상태 드롭다운 로드
                    (sprint.tasks || []).forEach(task => {
                        loadStatusDropdown(task);
                    });
                });

                // 스프린트 관련 이벤트 바인딩
                bindSprintEvents();
            }


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


            // 날짜를 "1월 5일" 형식으로 변환하는 함수
            function formatDateToKorean(dateString) {
                const date = new Date(dateString);
                const month = date.getMonth() + 1; // 월 (1~12)
                const day = date.getDate(); // 일 (1~31)
                return `${month}월 ${day}일`;
            }

            // 마감일 포맷 함수
            function formatDueDate(dueDate) {
                const date = new Date(dueDate);
                const month = (date.getMonth() + 1).toString().padStart(2, "0");
                const day = date.getDate().toString().padStart(2, "0");
                return `${month}-${day}`;
            }

            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

            function bindSprintEvents() {
                // 옵션 버튼
                $(".options-btn").off("click").on("click", function (e) {
                    if (userRole === "팀원") return; // 팀원은 옵션 버튼 사용 불가
                    e.stopPropagation(); // 다른 클릭 이벤트 방지
                    const menu = $(this).siblings(".options-menu");
                    $(".options-menu").not(menu).hide(); // 다른 메뉴 닫기
                    menu.toggle(); // 현재 메뉴 열기/닫기
                });

                $(document).off("click").on("click", function () {
                    $(".options-menu").hide();
                });

                // 삭제 버튼
                $(".delete-sprint-btn").off("click").on("click", function () {
                    if (userRole === "팀원") return; // 팀원은 삭제 버튼 사용 불가
                    const sprintId = $(this).data("sprint-id");
                    if (confirm("스프린트를 삭제하시겠습니까? 관련 작업은 '임시저장'으로 이동됩니다.")) {
                        deleteSprint(sprintId);
                    }
                });

                // 편집 버튼
                $(".edit-sprint-btn").off("click").on("click", function () {
                    if (userRole === "팀원") return; // 팀원은 편집 버튼 사용 불가
                    const sprintId = $(this).data("sprint-id");
                    openEditPopup(sprintId);
                });
            }

            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

            // 삭제 요청
            function deleteSprint(sprintId) {
                $.ajax({
                    url: `${API_URL}/sprint/delete`,
                    method: "DELETE",
                    contentType: "application/json",
                    data: JSON.stringify({ sprintId, projectId }),
                    success: function (response) {
                        fetchSprints(); // 스프린트 목록 새로고침
                    },
                    error: function (err) {
                    }
                });
            }

            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

            // 편집 팝업 열기
            function openEditPopup(sprintId) {
                $.ajax({
                    url: `${API_URL}/sprint/${sprintId}`,
                    method: "GET",
                    success: function (data) {
                        // 팝업에 기존 데이터 채우기
                        $("#editSprintName").val(data.sprintName);
                        $("#editStartDate").val(data.startDate.split("T")[0]); // YYYY-MM-DD 형식
                        $("#editEndDate").val(data.endDate.split("T")[0]);     // YYYY-MM-DD 형식

                        // 저장 버튼에 스프린트 ID 저장
                        $("#editSaveBtn").data("sprint-id", sprintId);

                        // 팝업 열기
                        $(".popup-background").fadeIn();
                        $("#editSprintPopup").fadeIn();
                    },
                    error: function (err) {
                        console.error(err);
                    }
                });
            }


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

            $("#addSprintBtn").click(function () {
                // 오늘 날짜 디폴트 값 설정
                const today = getTodayDate();
                $("#sprintName").val(""); // 스프린트 이름 초기화
                $("#startDate").val(today); // 시작 날짜 초기화
                $("#endDate").val(today);   // 종료 날짜 초기화

                // 팝업 열기
                $(".popup-background").fadeIn();
                $("#sprintPopup").fadeIn();
            });



            // 오늘 날짜를 YYYY-MM-DD 형식으로 가져오는 함수
            function getTodayDate() {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0'); // 월은 0부터 시작하므로 +1
                const day = String(today.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

            function closePopup() {
                $(".popup-background").fadeOut();
                $(".popup").fadeOut();
            }

            $("#cancelBtn, #editCancelBtn").click(closePopup);



            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────



            $("#editSaveBtn").off("click").on("click", function () {
                const sprintId = $(this).data("sprint-id");
                const sprintName = $("#editSprintName").val();
                const startDate = $("#editStartDate").val();
                const endDate = $("#editEndDate").val();

                if (!sprintName || !startDate || !endDate) {
                    return;
                }

                if (new Date(startDate) > new Date(endDate)) {
                    return;
                }

                $.ajax({
                    url: `${API_URL}/sprint/update`,
                    method: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify({ sprintId, sprintName, startDate, endDate }),
                    success: function (response) {
                        closePopup();
                        fetchSprints(); // 스프린트 목록 새로고침
                    },
                    error: function (err) {
                        console.error(err);
                    }
                });
            });

            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


            function fetchSprints() {
                $.ajax({
                    url: `${API_URL}/sprint/list-with-tasks`,
                    method: "GET",
                    data: { projectId },
                    success: function (sprints) {
                        renderSprints(sprints);
                    },
                    error: function (err) {
                        console.error("스프린트 조회 오류:", err);
                    }
                });
            }



            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


            $(document).on("change", ".status-dropdown", function () {
                const taskId = $(this).closest(".task-card").data("task-id");
                const newStatus = $(this).val();
                const changedBy = userIdx; // 로그인 사용자 ID
                const taskName = $(this).closest(".task-card").find("p strong").text(); // 작업 이름

                const requestData = {
                    taskId,
                    taskName,
                    status: newStatus,
                    changedBy
                };


                // AJAX 요청
                $.ajax({
                    url: `${API_URL}/tasks/update`,
                    method: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify(requestData),
                    success: function (response) {
                    },
                    error: function (err) {
                    }
                });
            });


            $(document).on("change", ".priority-dropdown", function () {
                if (userRole === "팀원") {
                    // 드롭다운 값을 변경 이전 상태로 복원
                    const previousValue = $(this).data("previous-value");
                    $(this).val(previousValue);
                    return;
                }

                const taskId = $(this).data("task-id") || $(this).attr("id").split("-")[1]; // taskId 추출
                const newPriority = $(this).val(); // 새 우선순위 값
                const changedBy = userIdx; // 로그인 사용자 ID

                if (!taskId) {
                    console.error("taskId가 정의되지 않았습니다. data-task-id 속성을 확인하세요.");
                    return; // taskId가 없으면 요청을 보내지 않음
                }

                const requestData = {
                    taskId,
                    priority: newPriority,
                    changedBy
                };

                // AJAX 요청
                $.ajax({
                    url: `${API_URL}/tasks/update`,
                    method: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify(requestData),
                    success: function (response) {
                        // 성공적으로 업데이트된 경우, 새로운 값을 저장
                        $(this).data("previous-value", newPriority);
                    },
                    error: function (err) {
                        // 오류 발생 시, 이전 값으로 복원
                        $(this).val($(this).data("previous-value"));
                    }
                });
            });

            // 초기 값 저장
            $(document).on("focus", ".priority-dropdown", function () {
                const currentValue = $(this).val();
                $(this).data("previous-value", currentValue);
            });



            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


            function loadStatusDropdown(task) {
                $.ajax({
                    url: `${API_URL}/tasks/status-list`, // 상태 목록 API 호출
                    method: "GET",
                    success: function (statuses) {
                        // 상태 목록 데이터를 옵션으로 변환
                        const statusOptions = statuses.map(status => `
                <option value="${status.id}" ${task.statusId === status.id ? 'selected' : ''}>
                    ${status.name}
                </option>
            `).join("");

                        // 드롭다운 업데이트
                        $(`#statusDropdown-${task.taskId}`).html(statusOptions);
                    },
                    error: function (err) {
                    }
                });
            }





            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


            $("#taskCreateBtn").click(function () {
                const taskName = $("#taskName").val();
                const description = $("#taskDescription").val();
                const dueDate = $("#taskDueDate").val();
                const sprintId = $(this).data("sprint-id");
                const projectId = sessionStorage.getItem("projectId");
                const userIdx = sessionStorage.getItem("userIdx");

                if (!taskName) {
                    return;
                }

                if (!dueDate) {
                    return;
                }

                $.ajax({
                    url: `${API_URL}/tasks/create`,
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        projectId,
                        sprintId,
                        taskName,
                        description,
                        dueDate,
                        assignedTo: userIdx, // 현재 사용자를 작업에 할당
                    }),
                    success: function (response) {
                        $("#addTaskPopup").fadeOut();
                        $(".popup-background").fadeOut();
                        fetchSprints(); // 스프린트 새로고침
                    },
                    error: function (err) {
                    },
                });
            });


            $("#cancelTaskBtn").click(function () {
                $("#addTaskPopup").fadeOut();
                $(".popup-background").fadeOut();
            });


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


            $(document).ready(function () {
                // 편집 팝업 닫기
                $("#cancelEditTaskBtn").click(function () {
                    $("#editTaskPopup").fadeOut();
                    $(".popup-background").fadeOut();
                });

                // 작업 저장
                $("#saveEditTaskBtn").click(function () {
                    const taskId = $(this).data("task-id");
                    const taskName = $("#editTaskName").val();
                    const description = $("#editTaskDescription").val();
                    const dueDate = $("#editTaskDueDate").val();

                    if (!taskName) {
                        return;
                    }

                    $.ajax({
                        url: `${API_URL}/tasks/update`,
                        method: "PUT",
                        contentType: "application/json",
                        data: JSON.stringify({
                            taskId,
                            taskName,
                            description,
                            dueDate,
                            changedBy: sessionStorage.getItem("userIdx"),
                        }),
                        success: function () {
                            $("#editTaskPopup").fadeOut();
                            $(".popup-background").fadeOut();
                            fetchSprints(); // 스프린트 새로고침
                        },
                        error: function (err) {
                        },
                    });
                });

                // 작업 삭제
                $("#deleteTaskBtn").click(function () {
                    const taskId = $(this).data("task-id");

                    if (!confirm("정말로 이 작업을 삭제하시겠습니까?")) {
                        return;
                    }

                    $.ajax({
                        url: `${API_URL}/tasks/delete`,
                        method: "DELETE",
                        contentType: "application/json",
                        data: JSON.stringify({ taskId }),
                        success: function () {
                            $("#editTaskPopup").fadeOut();
                            $(".popup-background").fadeOut();
                            fetchSprints(); // 스프린트 새로고침
                        },
                        error: function (err) {
                        },
                    });
                });
            });

            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────



            // 초기 데이터 로드
            fetchSprints();
        });
        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


        // 함수 정의
        function openAddTaskPopup(sprintId, sprintEndDate, sprintName) {
            if (!sprintId || !sprintEndDate || !sprintName) {
                return;
            }


            // 팝업에 스프린트 이름 설정
            $("#addTaskPopup .popup-header").text(`작업 추가 - ${sprintName}`);

            // 스프린트 ID와 종료 날짜를 팝업에 설정
            $("#taskCreateBtn").data("sprint-id", sprintId);
            $("#taskDueDate").attr("max", sprintEndDate); // 마감 날짜의 최대값 설정

            // 마감 날짜 기본값을 오늘 날짜로 설정
            const today = new Date().toISOString().split("T")[0];
            $("#taskDueDate").val(today);

            // 팝업 초기화 및 열기
            $("#taskName").val("");
            $("#taskDescription").val("");
            $("#addTaskPopup").fadeIn();
            $(".popup-background").fadeIn();
        }

        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


        // 작업 편집 팝업 열기
        function openEditTaskPopup(taskId) {
            $.ajax({
                url: `${API_URL}/tasks/${taskId}`,
                method: "GET",
                success: function (task) {
                    $("#editTaskName").val(task.task_name || "");
                    $("#editTaskDescription").val(task.description || "");
                    $("#editTaskDueDate").val(task.due_date ? task.due_date.split("T")[0] : "");

                    // 저장 및 삭제 버튼 활성화 여부
                    if (userRole === "팀원") {
                        $("#saveEditTaskBtn, #deleteTaskBtn").hide();
                    } else {
                        $("#saveEditTaskBtn, #deleteTaskBtn").show();
                    }

                    $(".popup-background").fadeIn();
                    $("#editTaskPopup").fadeIn();
                },
                error: function (err) {
                    console.error("작업 편집 로드 오류:", err);
                }
            });
        }

        function loadTaskStatus(selectedStatusId) {
            $.ajax({
                url: `${API_URL}/tasks/status-list`,
                method: "GET",
                success: function (statuses) {
                    const statusDropdown = $("#editTaskStatus");
                    statusDropdown.empty();

                    statuses.forEach(status => {
                        const isSelected = status.id === selectedStatusId ? "selected" : "";
                        statusDropdown.append(`<option value="${status.id}" ${isSelected}>${status.name}</option>`);
                    });
                },
                error: function (err) {
                }
            });
        }

        function loadTaskPriority(selectedPriority) {
            const priorities = ["낮음", "중간", "높음", "긴급"];
            const priorityDropdown = $("#editTaskPriority");
            priorityDropdown.empty();

            priorities.forEach(priority => {
                const isSelected = priority === selectedPriority ? "selected" : "";
                priorityDropdown.append(`<option value="${priority}" ${isSelected}>${priority}</option>`);
            });
        }



        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

        // 드래그 시작 이벤트
        let draggedSprint = null;

        window.dragSprint = function (event) {
            draggedSprint = event.target; // 드래그 시작된 스프린트를 저장
            event.target.style.opacity = "0.5"; // 시각적으로 반투명 처리
        };

        // 드래그 종료 이벤트
        window.dragSprintEnd = function (event) {
            event.target.style.opacity = "1"; // 투명도 복원
            draggedSprint = null; // 드래그 완료 후 초기화
        };

        // 드롭 가능 영역 진입 이벤트
        window.allowDropSprint = function (event) {
            event.preventDefault(); // 기본 브라우저 동작 방지
        };

        // 드롭 이벤트
        window.dropSprint = function (event) {
            event.preventDefault();

            const targetSprint = event.target.closest(".sprint"); // 드롭된 위치의 스프린트를 찾음
            const sprintBoard = document.querySelector("#sprintBoard"); // 전체 스프린트 보드

            if (targetSprint && draggedSprint !== targetSprint) {
                const allSprints = Array.from(sprintBoard.children); // 모든 스프린트 가져오기
                const draggedIndex = allSprints.indexOf(draggedSprint); // 드래그한 스프린트의 인덱스
                const targetIndex = allSprints.indexOf(targetSprint); // 드롭 위치의 스프린트 인덱스

                if (draggedIndex < targetIndex) {
                    sprintBoard.insertBefore(draggedSprint, targetSprint.nextSibling); // 아래로 이동
                } else {
                    sprintBoard.insertBefore(draggedSprint, targetSprint); // 위로 이동
                }

                saveSprintOrder(); // 변경된 순서를 서버로 저장
            }

            draggedSprint.style.opacity = "1"; // 드래그한 스프린트 투명도 복원
            draggedSprint = null; // 드래그한 스프린트 초기화
        };

        // 스프린트 순서를 서버에 저장
        function saveSprintOrder() {
            const sprintOrder = Array.from(document.querySelectorAll(".sprint")).map((el, index) => ({
                sprintId: el.dataset.sprintId, // 스프린트 ID
                order: index + 1, // 순서
            }));

            // 서버로 AJAX 요청 전송
            $.ajax({
                url: `${API_URL}/sprint/order`, // 서버의 API 엔드포인트
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify(sprintOrder),
                success: function () {
                    console.log("스프린트 순서 저장 완료");
                },
                error: function (err) {
                    console.error("스프린트 순서 저장 실패", err);
                },
            });
        }




    </script>



</body>

</html>