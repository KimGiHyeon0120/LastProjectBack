<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>스프린트 보드</title>
    <link rel="icon" sizes="48x48" href="../img/logo.png">
    <link rel="apple-touch-icon" sizes="48x48" href="../img/logo.png">
    <script src="../lib/jquery-3.7.1.min.js"></script>
    <script src="../script/header.js"></script>
    <link rel="stylesheet" href="../css/board_main.css">
</head>



<body>
    <!-- 헤더 영역 -->
    <header> </header>

    <div class="main">
        <div class="projectList-header">
            <h1>프로젝트</h1>
            <div class="btn-area">
                <button id="addSprintBtn">스프린트 만들기</button>
            </div>
        </div>


        <div id="sprintBoard" class="sprint-board">

        </div>




        <!-- 작업 편집 팝업 -->
        <div class="popup" id="editTaskPopup" style="display: none;">
            <div class="popup-header">작업 편집</div>
            <form class="popup-form">
                <label>작업 이름</label>
                <input type="text" id="editTaskName" placeholder="작업 이름을 입력하세요" required />

                <label>작업 설명</label>
                <textarea id="editTaskDescription" placeholder="작업 설명을 입력하세요"></textarea>

                <label>시작 날짜</label>
                <input type="date" id="editTaskStartDate" />

                <label>마감 날짜</label>
                <input type="date" id="editTaskDueDate" />

                <label>작업 상태</label>
                <select id="editTaskStatus"></select>

                <label>담당자</label>
                <select id="editTaskAssignedTo" required>
                    <option value="">담당자를 선택하세요</option>
                    <!-- JavaScript로 동적 추가 -->
                </select>

                <div class="popup-buttons">
                    <button type="button" class="cancel-btn" id="cancelEditTaskBtn">취소</button>
                    <button type="button" class="save-btn" id="saveEditTaskBtn">저장</button>
                    <button type="button" class="delete-btn" id="deleteTaskBtn">삭제</button>
                </div>
            </form>
        </div>


        <!-- 작업 추가 팝업 -->
        <div class="popup" id="addTaskPopup">
            <div class="popup-header">작업 추가</div>
            <form class="popup-form">
                <label>작업 이름</label>
                <input type="text" id="taskName" placeholder="작업 이름을 입력하세요" required />

                <label>작업 설명</label>
                <textarea id="taskDescription" placeholder="작업 설명을 입력하세요"></textarea>

                <label>시작 날짜</label>
                <input type="date" id="taskStartDate" required />

                <label>마감 날짜</label>
                <input type="date" id="taskDueDate" required />

                <!-- 담당자 선택 추가 -->
                <label>담당자</label>
                <select id="taskAssignedTo" required>
                    <option value="" selected>담당자 없음</option> <!-- 기본값 설정 -->
                    <!-- 팀원 목록은 JavaScript로 동적 추가 -->
                </select>

                <div class="popup-buttons">
                    <button type="button" class="cancel-btn" id="cancelTaskBtn">취소</button>
                    <button type="button" class="create-btn" id="taskCreateBtn" data-sprint-id="">추가</button>
                </div>
            </form>
        </div>





        <!-- 팝업 배경 -->
        <div class="popup-background"></div>

        <!-- 스프린트 생성 팝업 -->
        <div class="popup" id="sprintPopup">
            <div class="popup-header">스프린트 생성</div>
            <form class="popup-form">
                <label>스프린트 이름</label>
                <input type="text" id="sprintName" placeholder="스프린트 이름을 입력하세요" required>

                <label>시작 날짜</label>
                <input type="date" id="startDate" required>

                <label>종료 날짜</label>
                <input type="date" id="endDate" required>

                <div class="popup-buttons">
                    <button type="button" class="cancel-btn" id="cancelBtn">취소</button>
                    <button type="button" class="create-btn" id="createBtn">생성</button>
                </div>
            </form>
        </div>


        <!-- 스프린트 편집 팝업 -->
        <div class="popup" id="editSprintPopup">
            <div class="popup-header">스프린트 편집</div>
            <form class="popup-form">
                <label>스프린트 이름</label>
                <input type="text" id="editSprintName" required>

                <label>시작 날짜</label>
                <input type="date" id="editStartDate" required>

                <label>종료 날짜</label>
                <input type="date" id="editEndDate" required>

                <div class="popup-buttons">
                    <button type="button" class="cancel-btn" id="editCancelBtn">취소</button>
                    <button type="button" class="create-btn" id="editSaveBtn">저장</button>
                </div>
            </form>
        </div>


    </div>



    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = sessionStorage.getItem("projectId");
        const userIdx = sessionStorage.getItem("userIdx");
        const userIdxh = localStorage.getItem("userIdx"); // 사용자 ID
        const projectIdh = localStorage.getItem("projectId"); // 프로젝트 ID
        const API_URL = "http://192.168.20.37:3000/api";
        //192.168.20.37

        let userRole = null; // 초기값

        $(document).ready(function () {


            // projectId와 userIdx 유효성 검증
            if (!projectId || !userIdx) {
                console.error("프로젝트 ID 또는 사용자 ID가 유효하지 않습니다.");
                return;
            }

            // 역할 정보 가져오기
            $.ajax({
                url: `${API_URL}/project/role`,
                method: "GET",
                data: { projectId, userIdx }, // projectId와 userIdx 전달
                success: function (roleInfo) {
                    if (roleInfo && roleInfo.project_role_name) {
                        userRole = roleInfo.project_role_name; // 예: '팀장' 또는 '팀원'
                        updateUIBasedOnRole();
                        fetchSprints(); // 역할 정보를 기반으로 스프린트 렌더링
                    } else {
                        console.error("역할 정보가 유효하지 않습니다.", roleInfo);
                    }
                },
                error: function (err) {
                    console.error("역할 정보 로드 오류:", err);
                }
            });

            // 역할에 따른 UI 업데이트
            function updateUIBasedOnRole() {
                if (userRole === "팀원") {
                    // 데스크 추가 버튼 숨기기
                    $("#taskCreateBtn").hide();


                    // 스프린트 생성 버튼 비활성화
                    $("#addSprintBtn").prop("disabled", true).hide();

                    // 작업 편집 팝업 읽기 전용 설정
                    $("#editTaskPopup input, #editTaskPopup textarea, #editTaskPopup select").prop("disabled", true);
                    $("#saveEditTaskBtn, #deleteTaskBtn").hide();

                    // 데스크 추가 버튼 비활성화
                    $("#taskCreateBtn").prop("disabled", true).hide();

                    console.log("팀원은 제한된 작업만 수행할 수 있습니다.");
                } else {
                    console.log("팀장은 모든 작업을 수행할 수 있습니다.");
                }
            }
            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

            if (!projectId) {
                return;
            }

            // 드롭 가능 여부를 확인하고 기본 동작을 방지
            window.allowDrop = function (event) {
                if (!isDragAllowed()) return;
                event.preventDefault();
            };

            // 작업을 드래그할 때 작업 ID를 설정
            window.dragTask = function (event) {
                if (!isDragAllowed()) return;
                const taskId = event.target.dataset.taskId;
                event.dataTransfer.setData("text", taskId);
            };

            // 작업을 새로운 스프린트로 이동
            window.dropTask = function (event, sprintId) {
                if (!isDragAllowed()) return;
                event.preventDefault();
                const taskId = event.dataTransfer.getData("text");

                if (!taskId || !sprintId) {
                    console.error("유효하지 않은 작업 ID 또는 스프린트 ID입니다.");
                    return;
                }

                $.ajax({
                    url: `${API_URL}/tasks/move-sprint`,
                    method: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify({
                        taskId: taskId,
                        newSprintId: sprintId,
                        changedBy: userIdx
                    }),
                    success: function () {
                        fetchSprints();
                    },
                    error: function (err) {
                        console.error("작업 이동 오류:", err);
                    }
                });
            };

            // 드래그 및 드롭 작업이 허용되는지 확인
            function isDragAllowed() {
                if (userRole === "팀원") {
                    console.warn("팀원은 드래그 및 드롭 작업을 수행할 수 없습니다.");
                    return false;
                }
                return true;
            }


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────



            // 스프린트 및 태스크 불러오기
            function fetchSprints() {
                $.ajax({
                    url: `${API_URL}/sprint/list-with-tasks`,
                    method: "GET",
                    data: { projectId },
                    success: function (sprints) {
                        renderSprints(sprints);
                    },
                    error: function (err) {
                        console.error("스프린트 조회 오류:", err);
                    }
                });
            }


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


            $("#createBtn").off("click").on("click", function () {
                const sprintName = $("#sprintName").val();
                const startDate = $("#startDate").val();
                const endDate = $("#endDate").val();

                if (!sprintName || !startDate || !endDate) {
                    return;
                }

                if (new Date(startDate) > new Date(endDate)) {
                    return;
                }

                // 서버로 데이터 전송
                $.ajax({
                    url: `${API_URL}/sprint/create`, // API URL 확인
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        projectId, // 프로젝트 ID
                        sprintName,
                        startDate,
                        endDate,
                    }),
                    success: function (response) {
                        $(".popup-background").fadeOut();
                        $("#sprintPopup").fadeOut();
                        fetchSprints(); // 목록 새로고침
                    },
                    error: function (err) {
                    },
                });
            });




            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────



            // 스프린트 렌더링 함수
            function renderSprints(sprints) {
                const sprintBoard = $("#sprintBoard");
                sprintBoard.empty();

                if (!sprints || sprints.length === 0) {
                    sprintBoard.append("<p>스프린트 데이터가 없습니다.</p>");
                    return;
                }

                // "임시저장" 스프린트와 기타 스프린트 분리
                const unassignedSprint = sprints.find(sprint => sprint.sprintName === "임시저장");
                const otherSprints = sprints.filter(sprint => sprint.sprintName !== "임시저장");

                // 스프린트를 렌더링
                [...otherSprints, unassignedSprint].forEach(sprint => {
                    if (!sprint) return;


                    const taskCounts = sprint.tasks.reduce((counts, task) => {
                        counts.total += 1;
                        if (task.statusId === 1) counts.todo += 1;       // 할 일 작업
                        if (task.statusId === 2) counts.inProgress += 1; // 진행 중 작업
                        if (task.statusId === 3) counts.completed += 1;  // 완료된 작업
                        return counts;
                    }, { total: 0, todo: 0, inProgress: 0, completed: 0 });
                    
                    // 콘솔 출력
                    console.log(`스프린트 이름: ${sprint.sprintName}`);
                    console.log(`  총 작업 수: ${taskCounts.total}`);
                    console.log(`  할 일 작업: ${taskCounts.todo}`);
                    console.log(`  진행 중 작업: ${taskCounts.inProgress}`);
                    console.log(`  완료 작업: ${taskCounts.completed}`);
                    

                    // 작업 카드 HTML 생성
                    const tasksHTML = (sprint && sprint.tasks ? sprint.tasks.map(task => {
                        console.log("Rendering task:", task); // 콘솔: 현재 렌더링 중인 작업
                        return `
                            <div class="task-card" 
                                ${userRole === "팀원" ? '' : `draggable="true" ondragstart="dragTask(event)"`} 
                                data-task-id="${task.taskId}" 
                                data-sprint-id="${sprint.sprintId}" 
                                data-assigned-to="${task.assignedTo}">
                                
                                <p class="task-name" onclick="openEditTaskPopup(${task.taskId})">
                                    <strong>${task.taskName}</strong>
                                </p>
                                <p>
                                    <span class="readonly-priority priority-${task.priority}">
                                        ${task.priority}
                                    </span>
                                </p> 
                                <p>
                                    <select id="statusDropdown-${task.taskId}" class="task-status-dropdown" data-task-id="${task.taskId}" data-assigned-to="${task.assignedTo}">
                                        <option value="">로딩 중...</option>
                                    </select>
                                </p>
                                
                                <!-- 담당자 드롭다운 섹션 -->
                                <div class="assignee-section">
                                    <div class="assignee-dropdown" style="text-align: center;">
                                        <img src="${task.assignedToImage || '../profile/default-profile.png'}" class="assignee-image" alt="프로필" onclick="toggleAssigneeDropdown(${task.taskId})" >
                                        <span class="assignee-name">${task.assignedToName || '담당자 없음'}</span>
                                    </div>
                                    <div class="dropdown-options hidden" id="dropdown_${task.taskId}">
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('') : (() => {
                        console.log("No sprint or tasks available:", { sprint }); // 콘솔: 스프린트 또는 작업이 없는 경우
                        return '';
                    })());

                    // 스프린트 옵션 메뉴 생성
                    const optionsMenu = sprint.sprintName === "임시저장" ? "" : `
                        <button class="options-btn">...</button>
                        <div class="options-menu">
                            ${userRole === "팀장" ? `
                                <button class="edit-sprint-btn" data-sprint-id="${sprint.sprintId}">편집</button>
                                <button class="delete-sprint-btn" data-sprint-id="${sprint.sprintId}">삭제</button>
                            ` : ''}
                        </div>
                    `;

                    // 스프린트 HTML 생성
                    const sprintHTML = `
                    <div class="sprint" data-sprint-id="${sprint.sprintId}">
                        <div class="sprint-header">
                            <h3>${sprint.sprintName}</h3>
                            <p class="sprint-task-counts">
                                할 일: ${taskCounts.todo}, 진행 중: ${taskCounts.inProgress}, 완료: ${taskCounts.completed}
                            </p>
                            ${optionsMenu}
                        </div>
                        <div class="sprint-content" 
                            ondragover="allowDrop(event, ${sprint.sprintId})" 
                            ondrop="dropTask(event, ${sprint.sprintId})">
                            ${tasksHTML || "<p></p>"}
                      
                        ${sprint.sprintName !== "임시저장" && userRole !== "팀원" // 팀원이 아닌 경우만 추가 버튼을 렌더링
                            ? `
                                    <button class="add-task-btn" 
                                            onclick="openAddTaskPopup(${sprint.sprintId}, '${sprint.endDate || ""}', '${sprint.sprintName}')">
                                        + 추가
                                    </button>
                                
                                  </div>`

                            : ""}
                    </div>`;
                    sprintBoard.append(sprintHTML);

                    // 각 작업의 상태 드롭다운 로드
                    (sprint.tasks || []).forEach(task => {
                        loadStatusDropdown(task);
                    });
                });

                // 스프린트 관련 이벤트 바인딩
                bindSprintEvents();
            }


            // 팀원 목록 렌더링 함수
            async function renderTeamMembers(taskId, projectId) {
                try {

                    // API 호출
                    const response = await $.get(`${API_URL}/project/members`, { projectId });

                    const teamMembers = response;

                    // 드롭다운 요소 찾기
                    const dropdown = document.getElementById(`dropdown_${taskId}`);
                    if (!dropdown) {
                        console.error(`[오류] 작업 ID ${taskId}에 대한 드롭다운을 찾을 수 없습니다.`);
                        return;
                    }


                    // 팀원 목록 추가 + '담당자 없음' 옵션 추가
                    dropdown.innerHTML = `
                        ${teamMembers.map(member => `
                            <div class="dropdown-item" onclick="selectAssignee(${taskId}, ${member.userId}, '${member.profileImage || '../profile/default-profile.png'}', '${member.userName}')">
                                <img src="${member.profileImage || '../profile/default-profile.png'}" class="dropdown-image" alt="프로필">
                                <span>${member.userName}</span>
                            </div>
                        `).join('')}
                        <div class="dropdown-item" onclick="selectAssignee(${taskId}, null, '../profile/default-profile.png', '담당자 없음')">
                            <img src="../profile/default-profile.png" class="dropdown-image" alt="프로필">
                            <span>담당자 없음</span>
                        </div>
                    `;
                } catch (err) {
                    console.error('[오류] 팀원 목록 가져오기 중 오류 발생:', err);
                }
            }



            // 드롭다운 열기/닫기
            window.toggleAssigneeDropdown = async function (taskId) {
                const currentDropdown = document.getElementById(`dropdown_${taskId}`);
                if (!currentDropdown) {
                    console.error(`Dropdown not found for Task ID ${taskId}`);
                    return;
                }

                // 드롭다운 데이터가 없는 경우 팀원 목록 로드
                if (!currentDropdown.innerHTML.trim()) {
                    await renderTeamMembers(taskId, projectId); // 프로젝트 ID를 전달
                }

                // 모든 드롭다운 닫기
                document.querySelectorAll('.dropdown-options').forEach(dropdown => {
                    if (dropdown.id !== `dropdown_${taskId}`) {
                        dropdown.classList.remove('show');
                    }
                });

                // 현재 드롭다운 열기/닫기
                currentDropdown.classList.toggle('show');
            };


            // 담당자 변경
            window.selectAssignee = function (taskId, userId, profileImage, userName) {

                // 서버 요청
                $.ajax({
                    url: `${API_URL}/tasks/assign`,
                    method: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify({ taskId, assignedTo: userId, changedBy: userIdx }), // userId가 null일 경우 "담당자 없음"
                    success: function () {

                        // 전체 스프린트를 다시 렌더링
                        fetchSprints();

                        // 드롭다운 닫기
                        const dropdown = document.getElementById(`dropdown_${taskId}`);
                        if (dropdown) {
                            dropdown.classList.remove('show');
                        }
                    },
                    error: function (err) {
                        console.error(`[오류] 작업 ID ${taskId}의 담당자 변경 중 오류 발생:`, err);
                    }
                });
            };






            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


            // 날짜를 "1월 5일" 형식으로 변환하는 함수
            function formatDateToKorean(dateString) {
                const date = new Date(dateString);
                const month = date.getMonth() + 1; // 월 (1~12)
                const day = date.getDate(); // 일 (1~31)
                return `${month}월 ${day}일`;
            }

            // 마감일 포맷 함수
            function formatDueDate(dueDate) {
                const date = new Date(dueDate);
                const month = (date.getMonth() + 1).toString().padStart(2, "0");
                const day = date.getDate().toString().padStart(2, "0");
                return `${month}-${day}`;
            }

            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

            function bindSprintEvents() {
                // 옵션 버튼
                $(".options-btn").off("click").on("click", function (e) {
                    if (userRole === "팀원") return; // 팀원은 옵션 버튼 사용 불가
                    e.stopPropagation(); // 다른 클릭 이벤트 방지
                    const menu = $(this).siblings(".options-menu");
                    $(".options-menu").not(menu).hide(); // 다른 메뉴 닫기
                    menu.toggle(); // 현재 메뉴 열기/닫기
                });

                $(document).off("click").on("click", function () {
                    $(".options-menu").hide();
                });

                // 삭제 버튼
                $(".delete-sprint-btn").off("click").on("click", function () {
                    if (userRole === "팀원") return; // 팀원은 삭제 버튼 사용 불가
                    const sprintId = $(this).data("sprint-id");
                    if (confirm("스프린트를 삭제하시겠습니까? 관련 작업은 '임시저장'으로 이동됩니다.")) {
                        deleteSprint(sprintId);
                    }
                });

                // 편집 버튼
                $(".edit-sprint-btn").off("click").on("click", function () {
                    if (userRole === "팀원") return; // 팀원은 편집 버튼 사용 불가
                    const sprintId = $(this).data("sprint-id");
                    openEditPopup(sprintId);
                });
            }

            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

            // 삭제 요청
            function deleteSprint(sprintId) {
                $.ajax({
                    url: `${API_URL}/sprint/delete`,
                    method: "DELETE",
                    contentType: "application/json",
                    data: JSON.stringify({ sprintId, projectId }),
                    success: function (response) {
                        fetchSprints(); // 스프린트 목록 새로고침
                    },
                    error: function (err) {
                    }
                });
            }

            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

            // 편집 팝업 열기
            function openEditPopup(sprintId) {
                $.ajax({
                    url: `${API_URL}/sprint/${sprintId}`,
                    method: "GET",
                    success: function (data) {
                        // 팝업에 기존 데이터 채우기
                        $("#editSprintName").val(data.sprintName);
                        $("#editStartDate").val(data.startDate.split("T")[0]); // YYYY-MM-DD 형식
                        $("#editEndDate").val(data.endDate.split("T")[0]);     // YYYY-MM-DD 형식

                        // 저장 버튼에 스프린트 ID 저장
                        $("#editSaveBtn").data("sprint-id", sprintId);

                        // 팝업 열기
                        $(".popup-background").fadeIn();
                        $("#editSprintPopup").fadeIn();
                    },
                    error: function (err) {
                        console.error(err);
                    }
                });
            }


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

            $("#addSprintBtn").click(function () {
                // 오늘 날짜 디폴트 값 설정
                const today = getTodayDate();
                $("#sprintName").val(""); // 스프린트 이름 초기화
                $("#startDate").val(today); // 시작 날짜 초기화
                $("#endDate").val(today);   // 종료 날짜 초기화

                // 팝업 열기
                $(".popup-background").fadeIn();
                $("#sprintPopup").fadeIn();
            });



            // 오늘 날짜를 YYYY-MM-DD 형식으로 가져오는 함수
            function getTodayDate() {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0'); // 월은 0부터 시작하므로 +1
                const day = String(today.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

            function closePopup() {
                $(".popup-background").fadeOut();
                $(".popup").fadeOut();
            }

            $("#cancelBtn, #editCancelBtn").click(closePopup);



            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────



            $("#editSaveBtn").off("click").on("click", function () {
                const sprintId = $(this).data("sprint-id");
                const sprintName = $("#editSprintName").val();
                const startDate = $("#editStartDate").val();
                const endDate = $("#editEndDate").val();

                if (!sprintName || !startDate || !endDate) {
                    return;
                }

                if (new Date(startDate) > new Date(endDate)) {
                    return;
                }

                $.ajax({
                    url: `${API_URL}/sprint/update`,
                    method: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify({ sprintId, sprintName, startDate, endDate }),
                    success: function (response) {
                        closePopup();
                        fetchSprints(); // 스프린트 목록 새로고침
                    },
                    error: function (err) {
                        console.error(err);
                    }
                });
            });

            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


            function fetchSprints() {
                $.ajax({
                    url: `${API_URL}/sprint/list-with-tasks`,
                    method: "GET",
                    data: { projectId },
                    success: function (sprints) {
                        renderSprints(sprints);
                    },
                    error: function (err) {
                        console.error("스프린트 조회 오류:", err);
                    }
                });
            }



            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


            // 작업 상태 변경 이벤트 처리
            $(document).on("change", ".status-dropdown", function () {
                const taskId = $(this).closest(".task-card").data("task-id");
                const newStatus = $(this).val();
                const assignedTo = $(this).data("assigned-to"); // 담당자 ID
                const changedBy = userIdx;

                // 디버깅 로그
                console.log("Status Change Request:", { taskId, newStatus, changedBy, assignedTo });

                // 데이터 유효성 확인
                if (!taskId || !newStatus) {

                    location.href = location.href; // 이전 값으로 복원
                    return;
                }

                // 권한 검증
                if (userRole !== "팀장" && userIdx != assignedTo) {

                    location.href = location.href; // 이전 값으로 복원
                    return;
                }

                // AJAX 요청
                $.ajax({
                    url: `${API_URL}/tasks/update`,
                    method: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify({ taskId, status: newStatus, changedBy }),
                    success: function (response) {
                        console.log("상태 변경 성공:", response);
                        $(this).data("previous-value", newStatus); // 새로운 상태 저장
                    },
                    error: function (err) {
                        console.error("상태 변경 중 오류:", err);
                        $(this).val($(this).data("previous-value")); // 이전 값으로 복원
                        alert("상태 변경에 실패했습니다. 권한을 확인하거나 관리자에게 문의하세요.");
                    }
                });
            });





            // 초기 값 저장
            $(document).on("focus", ".priority-dropdown", function () {
                // 드롭다운 초기 값 저장
                const currentValue = $(this).val();
                $(this).data("previous-value", currentValue);
            });



            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────



            // 작업 상태 드롭다운 로드 함수
            function loadStatusDropdown(task) {
                $.ajax({
                    url: `${API_URL}/tasks/status-list`, // 상태 목록 API 호출
                    method: "GET",
                    success: function (statuses) {
                        // 상태 목록 데이터를 옵션으로 변환
                        const statusOptions = statuses.map(status => {
                            // 상태명에서 띄어쓰기를 제거하고 하이픈으로 변환
                            const statusClass = `status-${status.name.replace(/\s+/g, '')}`;

                            return `
                    <option 
                        value="${status.id}" 
                        ${task.statusId === status.id ? 'selected' : ''} 
                        data-status="${status.name}"
                        class="${statusClass}">
                        ${status.name} 
                    </option>
                `;
                        }).join("");

                        // 드롭다운 업데이트
                        const dropdown = $(`#statusDropdown-${task.taskId}`);
                        dropdown.html(statusOptions);

                        // 상태에 맞는 디자인 클래스를 <select>에 적용
                        const selectedStatus = statuses.find(status => status.id === task.statusId);
                        if (selectedStatus) {
                            const selectedClass = `status-${selectedStatus.name.replace(/\s+/g, '')}`;
                            dropdown.addClass(selectedClass); // <select>에 상태 클래스 추가
                        }
                    },
                    error: function (err) {
                        console.error(err);
                    }
                });
            }






            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────



            // 작업 추가 버튼 클릭 이벤트
            $("#taskCreateBtn").click(function () {
                const taskName = $("#taskName").val();
                const description = $("#taskDescription").val();
                const startDate = $("#taskStartDate").val(); // 시작 날짜
                const dueDate = $("#taskDueDate").val(); // 마감 날짜
                const sprintId = $(this).data("sprint-id");
                const projectId = sessionStorage.getItem("projectId");
                const assignedTo = $("#taskAssignedTo").val(); // 선택한 담당자 ID

                // 필수 필드 확인
                if (!taskName || !startDate || !dueDate) {
                    alert("모든 필드를 입력해주세요.");
                    return;
                }

                // 날짜 유효성 검증
                if (new Date(startDate) > new Date(dueDate)) {
                    alert("시작 날짜는 마감 날짜보다 앞서야 합니다.");
                    return;
                }

                // 작업 추가 요청
                $.ajax({
                    url: `${API_URL}/tasks/create`,
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        projectId,
                        sprintId,
                        taskName,
                        description,
                        startDate,
                        dueDate,
                        assignedTo: assignedTo || null, // 선택한 담당자 ID 또는 null
                    }),
                    success: function () {
                        alert("작업이 성공적으로 추가되었습니다.");
                        $("#addTaskPopup").fadeOut();
                        $(".popup-background").fadeOut();
                        fetchSprints(); // 스프린트 새로고침
                    },
                    error: function (err) {
                        console.error("작업 추가 오류:", err);
                        alert("작업 추가 중 오류가 발생했습니다.");
                    }
                });
            });

            // 담당자 드롭다운 렌더링
            async function renderAssigneeDropdown(projectId) {
                try {
                    // API 호출로 프로젝트 팀원 목록 가져오기
                    const response = await $.get(`${API_URL}/project/members`, { projectId });
                    const teamMembers = response;

                    // 드롭다운 요소 찾기
                    const dropdown = document.getElementById("taskAssignedTo");
                    if (!dropdown) {
                        console.error("[오류] 'taskAssignedTo' 드롭다운을 찾을 수 없습니다.");
                        return;
                    }

                    // 드롭다운 초기화
                    dropdown.innerHTML = `
            <option value="" selected>담당자 없음</option> <!-- 기본값 설정 -->
        `;

                    // 팀원 목록 추가
                    teamMembers.forEach(member => {
                        const option = document.createElement("option");
                        option.value = member.userId;
                        option.textContent = member.userName;
                        dropdown.appendChild(option);
                    });

                } catch (err) {
                    console.error("[오류] 담당자 목록 가져오기 중 오류 발생:", err);
                }
            }


            // 작업 추가 팝업 닫기 버튼 클릭 이벤트
            $("#cancelTaskBtn").click(function () {
                $("#addTaskPopup").fadeOut();
                $(".popup-background").fadeOut();
            });


            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────



            //편집 팝업
            $(document).ready(function () {
                // 편집 팝업 닫기
                $("#cancelEditTaskBtn").click(function () {
                    $("#editTaskPopup").fadeOut();
                    $(".popup-background").fadeOut();
                });

                // 작업 저장
                $("#saveEditTaskBtn").click(function () {
                    const taskId = $(this).data("task-id");
                    const taskName = $("#editTaskName").val();
                    const description = $("#editTaskDescription").val();
                    const startDate = $("#editTaskStartDate").val();
                    const dueDate = $("#editTaskDueDate").val();
                    const status = $("#editTaskStatus").val();
                    let assignedTo = $("#editTaskAssignedTo").val();

                    // "담당자 없음" 처리: 빈 값일 경우 null로 설정
                    assignedTo = assignedTo === "" ? null : assignedTo;

                    // **작업 ID 확인**
                    if (!taskId) {
                        alert("작업 ID가 설정되지 않았습니다.");
                        return;
                    }

                    // 필수 필드 확인
                    if (!taskName || !startDate || !dueDate) {
                        alert("모든 필드를 입력해주세요.");
                        return;
                    }

                    // 날짜 유효성 확인
                    if (new Date(startDate) > new Date(dueDate)) {
                        alert("시작 날짜는 마감 날짜보다 앞서야 합니다.");
                        return;
                    }

                    // 권한 검증
                    const isEditable = userRole === "팀장" || userIdx == assignedTo || assignedTo === null;
                    console.log("isEditable:", isEditable, "userRole:", userRole, "userIdx:", userIdx, "assignedTo:", assignedTo);

                    if (!isEditable) {
                        alert("작업을 저장할 권한이 없습니다.");
                        return;
                    }

                    // AJAX 요청
                    $.ajax({
                        url: `${API_URL}/tasks/update`,
                        method: "PUT",
                        contentType: "application/json",
                        data: JSON.stringify({
                            taskId,
                            taskName,
                            description,
                            startDate,
                            dueDate,
                            status: status || 1,
                            changedBy: userIdx, // 변경한 사용자
                            assignedTo // null 또는 선택된 사용자 ID 전달
                        }),
                        success: function (response) {
                            $("#editTaskPopup").fadeOut();
                            $(".popup-background").fadeOut();
                            fetchSprints(); // 화면 새로고침
                        },
                        error: function (err) {
                            console.error("작업 저장 오류:", err);
                            alert("작업 저장 중 오류가 발생했습니다.");
                        }
                    });
                });





                // 작업 삭제
                $("#deleteTaskBtn").click(function () {
                    const taskId = $(this).data("task-id");

                    if (!confirm("정말로 이 작업을 삭제하시겠습니까?")) {
                        return;
                    }


                    $.ajax({
                        url: `${API_URL}/tasks/delete`,
                        method: "DELETE",
                        contentType: "application/json",
                        data: JSON.stringify({ taskId }),
                        success: function () {
                            $("#editTaskPopup").fadeOut();
                            $(".popup-background").fadeOut();
                            fetchSprints(); // 스프린트 새로고침
                        },
                        error: function (err) {
                        },
                    });
                });
            });

            // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────



            // 초기 데이터 로드
            fetchSprints();
        });
        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


        // 함수 정의
        function openAddTaskPopup(sprintId, sprintEndDate, sprintName) {
            if (!sprintId || !sprintEndDate || !sprintName) {
                alert("스프린트 정보를 확인해주세요.");
                return;
            }

            // 팝업에 스프린트 이름 설정
            $("#addTaskPopup .popup-header").text(`작업 추가 - ${sprintName}`);

            // 스프린트 ID와 종료 날짜를 팝업에 설정
            $("#taskCreateBtn").data("sprint-id", sprintId);
            $("#taskDueDate").attr("max", sprintEndDate); // 마감 날짜의 최대값 설정

            // 시작 날짜와 마감 날짜 기본값 설정
            const today = new Date().toISOString().split("T")[0];
            $("#taskStartDate").val(today); // 시작 날짜 기본값
            $("#taskDueDate").val(today);   // 마감 날짜 기본값

            // 팝업 초기화
            $("#taskName").val("");
            $("#taskDescription").val("");

            // 프로젝트 ID 가져오기
            const projectId = sessionStorage.getItem("projectId");
            if (!projectId) {
                alert("프로젝트 ID를 확인할 수 없습니다.");
                return;
            }

            // 담당자 드롭다운 렌더링
            renderAssigneeDropdown(projectId);

            // 팝업 열기
            $("#addTaskPopup").fadeIn();
            $(".popup-background").fadeIn();
        }

        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────


        // 작업 편집 팝업 열기
        function openEditTaskPopup(taskId) {
            if (!taskId) {
                console.error("작업 ID가 전달되지 않았습니다.");
                alert("작업 ID가 유효하지 않습니다. 페이지를 새로고침합니다.");
                window.location.reload(); // 작업 ID가 없으면 새로고침
                return;
            }

            $.ajax({
                url: `${API_URL}/tasks/${taskId}`,
                method: "GET",
                success: async function (task) {
                    $("#saveEditTaskBtn").data("task-id", taskId);

                    $("#editTaskName").val(task.taskName || "");
                    $("#editTaskDescription").val(task.description || "");
                    $("#editTaskStartDate").val(task.startDate ? task.startDate.split("T")[0] : "");
                    $("#editTaskDueDate").val(task.dueDate ? task.dueDate.split("T")[0] : "");

                    const isEditable = userRole === "팀장" || userIdx == task.assignedTo;
                    $("#editTaskName, #editTaskDescription, #editTaskStartDate, #editTaskDueDate, #editTaskStatus, #editTaskAssignedTo")
                        .prop("disabled", !isEditable);
                    $("#saveEditTaskBtn, #deleteTaskBtn").toggle(isEditable);

                    loadTaskStatus(task.statusId, isEditable);

                    const projectId = sessionStorage.getItem("projectId");
                    if (projectId) {
                        await renderEditAssigneeDropdown(projectId, task.assignedTo);
                    } else {
                        console.error("프로젝트 ID를 찾을 수 없습니다.");
                    }

                    $(".popup-background").fadeIn();
                    $("#editTaskPopup").fadeIn();
                },
                error: function (err) {
                    console.error("작업 편집 로드 오류:", err);
                    alert("작업 정보를 불러오는 중 오류가 발생했습니다. 페이지를 새로고침합니다.");
                    window.location.reload();
                }
            });
        }




        async function renderEditAssigneeDropdown(projectId, selectedAssigneeId) {
            try {
                const response = await $.get(`${API_URL}/project/members`, { projectId });
                const teamMembers = response;

                const dropdown = document.getElementById("editTaskAssignedTo");
                if (!dropdown) {
                    console.error("[오류] 'editTaskAssignedTo' 드롭다운을 찾을 수 없습니다.");
                    return;
                }

                // 드롭다운 초기화
                dropdown.innerHTML = `
                    <option value="">담당자를 선택하세요</option>
                `;

                // 팀원 목록 추가
                teamMembers.forEach(member => {
                    const option = document.createElement("option");
                    option.value = member.userId;
                    option.textContent = member.userName;
                    if (member.userId === selectedAssigneeId) {
                        option.selected = true; // 기본값 설정
                    }
                    dropdown.appendChild(option);
                });

                // '담당자 없음' 옵션 추가
                const noAssigneeOption = document.createElement("option");
                noAssigneeOption.value = "";
                noAssigneeOption.textContent = "담당자 없음";
                if (!selectedAssigneeId) {
                    noAssigneeOption.selected = true;
                }
                dropdown.appendChild(noAssigneeOption);

                console.log("[성공] 담당자 드롭다운이 업데이트되었습니다.");
            } catch (err) {
                console.error("[오류] 담당자 목록 가져오기 중 오류 발생:", err);
            }
        }

        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────



        // 작업 상태 드롭다운을 로드하고 선택된 상태를 표시
        function loadTaskStatus(selectedStatusId, isEditable) {
            $.ajax({
                url: `${API_URL}/tasks/status-list`,
                method: "GET",
                success: function (statuses) {
                    const statusDropdown = $("#editTaskStatus");
                    statusDropdown.empty();

                    statuses.forEach(status => {
                        const isSelected = status.id === selectedStatusId ? "selected" : "";
                        statusDropdown.append(`<option value="${status.id}" ${isSelected}>${status.name}</option>`);
                    });

                    // 상태 변경 권한 설정
                    if (!isEditable) {
                        statusDropdown.prop("disabled", true);
                    }
                },
                error: function (err) {
                    console.error("작업 상태 로드 오류:", err);
                }
            });
        }



        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

        async function renderAssigneeDropdown(projectId) {
            try {
                const response = await $.get(`${API_URL}/project/members`, { projectId });
                const teamMembers = response;

                const dropdown = document.getElementById("taskAssignedTo");
                if (!dropdown) {
                    console.error("[오류] 'taskAssignedTo' 드롭다운을 찾을 수 없습니다.");
                    return;
                }

                dropdown.innerHTML = `<option value="">담당자를 선택하세요</option>`;

                teamMembers.forEach(member => {
                    const option = document.createElement("option");
                    option.value = member.userId;
                    option.textContent = member.userName;
                    dropdown.appendChild(option);
                });

                const noAssigneeOption = document.createElement("option");
                noAssigneeOption.value = "";
                noAssigneeOption.textContent = "담당자 없음";
                dropdown.appendChild(noAssigneeOption);

            } catch (err) {
                console.error("[오류] 담당자 목록 가져오기 중 오류 발생:", err);
            }
        }



        // ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

        // 드래그 시작 이벤트
        let draggedSprint = null;

        window.dragSprint = function (event) {
            draggedSprint = event.target; // 드래그 시작된 스프린트를 저장
            event.target.style.opacity = "0.5"; // 시각적으로 반투명 처리
        };

        // 드래그 종료 이벤트
        window.dragSprintEnd = function (event) {
            event.target.style.opacity = "1"; // 투명도 복원
            draggedSprint = null; // 드래그 완료 후 초기화
        };

        // 드롭 가능 영역 진입 이벤트
        window.allowDropSprint = function (event) {
            event.preventDefault(); // 기본 브라우저 동작 방지
        };

        // 드롭 이벤트
        window.dropSprint = function (event) {
            event.preventDefault();

            const targetSprint = event.target.closest(".sprint"); // 드롭된 위치의 스프린트를 찾음
            const sprintBoard = document.querySelector("#sprintBoard"); // 전체 스프린트 보드

            if (targetSprint && draggedSprint !== targetSprint) {
                const allSprints = Array.from(sprintBoard.children); // 모든 스프린트 가져오기
                const draggedIndex = allSprints.indexOf(draggedSprint); // 드래그한 스프린트의 인덱스
                const targetIndex = allSprints.indexOf(targetSprint); // 드롭 위치의 스프린트 인덱스

                if (draggedIndex < targetIndex) {
                    sprintBoard.insertBefore(draggedSprint, targetSprint.nextSibling); // 아래로 이동
                } else {
                    sprintBoard.insertBefore(draggedSprint, targetSprint); // 위로 이동
                }

                saveSprintOrder(); // 변경된 순서를 서버로 저장
            }

            draggedSprint.style.opacity = "1"; // 드래그한 스프린트 투명도 복원
            draggedSprint = null; // 드래그한 스프린트 초기화
        };

        // 스프린트 순서를 서버에 저장
        function saveSprintOrder() {
            const sprintOrder = Array.from(document.querySelectorAll(".sprint")).map((el, index) => ({
                sprintId: el.dataset.sprintId, // 스프린트 ID
                order: index + 1, // 순서
            }));

            // 서버로 AJAX 요청 전송
            $.ajax({
                url: `${API_URL}/sprint/order`, // 서버의 API 엔드포인트
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify(sprintOrder),
                success: function () {
                    console.log("스프린트 순서 저장 완료");
                },
                error: function (err) {
                    console.error("스프린트 순서 저장 실패", err);
                },
            });
        }




    </script>



</body>

</html>